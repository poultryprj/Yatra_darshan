<!-- templates/Diwali/manage_family_members.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Family Members</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; display: flex; align-items: center; }
        .back-btn { color: white; font-size: 24px; text-decoration: none; margin-right: 15px; }
        .header h1 { font-size: 22px; margin: 0; }
        .container-main { padding: 20px; max-width: 700px; margin: 0 auto; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { background-color: #f7fafc; font-weight: 600; color: #4a5568; }
        .member-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .member-item:last-child { border-bottom: none; }
        .member-icon { font-size: 20px; color: #667eea; margin-right: 15px; width: 25px; text-align: center; }
        .member-details .name { font-weight: 600; }
        .member-details .meta { font-size: 14px; color: #718096; }
        .member-actions { margin-left: auto; display: flex; gap: 10px; }
        .btn-action { width: 38px; height: 38px; border-radius: 50%; border: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-edit { background-color: #f6ad55; color: white; }
        .btn-delete { background-color: #f56565; color: white; }
        .no-members { text-align: center; padding: 30px; color: #a0aec0; }
    </style>
</head>
<body>
    <div class="header">
        <a href="{% url 'darshan_yatra_management' %}" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <h1 class="d-flex align-items-center justify-content-between w-100">
            <span>Manage Family</span>
            <button id="addMemberBtn" class="btn btn-light btn-sm rounded-circle shadow-sm" title="Add New Member" style="width:36px; height:36px;">
                <i class="fas fa-plus text-primary"></i>
            </button>
        </h1>
    </div>

    <div class="container-main">
        {% if head %}
        <!-- Hidden inputs to store head's data for JavaScript -->
        <input type="hidden" id="headRegistrationId" value="{{ head.RegistrationId }}">
        <input type="hidden" id="headMobileNo" value="{{ head.MobileNo }}">
        <input type="hidden" id="headAreaId" value="{{ head.AreaId }}">
        <input type="hidden" id="headAddress" value="{{ head.Address }}">
        <input type="hidden" id="rationCardNo" value="{{ ration_card_no }}">


        <div class="card">
            <div class="card-header"><i class="fas fa-user-shield me-2"></i> Head of Family</div>
            <div class="card-body">
                <h4>{{ head.Firstname|title }} {{ head.Middlename|title }} {{ head.Lastname|title }}</h4>
                <p class="text-muted mb-1"><i class="fas fa-phone me-2"></i> {{ head.MobileNo }}</p>
                <p class="text-muted mb-0"><i class="fas fa-id-card me-2"></i> {{ ration_card_no }}</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="fas fa-users me-2"></i> Family Members</div>
            <div id="membersList">
                {% for member in members %}
                <div class="member-item">
                    <span class="member-icon"><i class="fas fa-user"></i></span>
                    <div class="member-details">
                        <div class="name">{{ member.Firstname }} {{ member.Middlename }} {{ member.Lastname }}</div>
                        <div class="meta">
                            {% if member.MobileNo and member.MobileNo != 'None' %}
                                Mobile: {{ member.MobileNo }} &bull;
                            {% endif %}

                           
                            
                            {% if member.VoterIdProof and member.VoterIdProof != 'None' %}
                                <!-- Make the link clickable to view the photo -->
                                
                            {% endif %}
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="btn-action btn-edit" title="Edit Member"
                                data-reg-id="{{ member.RegistrationId }}"
                                data-name="{{ member.Firstname }} {{ member.Middlename }} {{ member.Lastname }}"
                                data-mobile="{{ member.MobileNo }}"
                                data-age="{{ member.Age }}"
                                data-voter="{{ member.VoterIdProof }}">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="btn-action btn-delete" title="Delete Member" data-reg-id="{{ member.RegistrationId }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="no-members">No other family members have been added.</div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="alert alert-danger">Could not load family data. Please go back and try again.</div>
        {% endif %}
    </div>

    <!-- MODAL FOR ADDING/EDITING MEMBER -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberModalTitle">Add Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="memberForm" onsubmit="return false;">
                        <input type="hidden" id="memberRegId" value="0">
                        <input type="hidden" id="existingVoterPhoto" value="">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="memberName" placeholder="Full Name" required>
                            <label for="memberName">Full Name</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" id="memberMobile" placeholder="Mobile Number (Optional)" maxlength="10">
                            <label for="memberMobile">Mobile Number (Optional)</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="memberAge" placeholder="Age (Optional)">
                            <label for="memberAge">Age (Optional)</label>
                        </div>
                         <div class="mb-3">
                            <label for="memberVoterIdPhoto" class="form-label">Voter ID Photo (Optional)</label>
                            <input type="file" class="form-control" id="memberVoterIdPhoto" accept="image/*,.pdf">
                            <div id="currentVoterPhotoPreview" class="mt-2" style="display: none;"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMemberBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
    const getCookie = (name) => { let c = null; if(document.cookie){for(const s of document.cookie.split(';')){const[k,v]=s.trim().split('=');if(k===name){c=decodeURIComponent(v);break;}}} return c; };

    const voterPhotoPreview = document.getElementById('currentVoterPhotoPreview');

    // --- Open modal for ADDING a new member ---
    document.getElementById('addMemberBtn').addEventListener('click', () => {
        document.getElementById('memberModalTitle').textContent = 'Add New Member';
        document.getElementById('memberForm').reset();
        document.getElementById('memberRegId').value = '0'; 
        voterPhotoPreview.style.display = 'none';
        voterPhotoPreview.innerHTML = '';
        memberModal.show();
        memberModal.show();
    });

    document.getElementById('membersList').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.btn-edit');
        const deleteBtn = e.target.closest('.btn-delete');

        // --- Handle EDIT ---
        if (editBtn) {
            document.getElementById('memberModalTitle').textContent = 'Edit Member';
            document.getElementById('memberForm').reset();
            
            document.getElementById('memberRegId').value = editBtn.dataset.regId;
            document.getElementById('memberName').value = editBtn.dataset.name;
            document.getElementById('memberMobile').value = editBtn.dataset.mobile;
            document.getElementById('memberAge').value = editBtn.dataset.age;
            
            document.getElementById('existingVoterPhoto').value = editBtn.dataset.voter;

            const existingPhotoUrl = editBtn.dataset.voter;
            if (existingPhotoUrl && existingPhotoUrl !== 'None' && existingPhotoUrl.trim() !== '') {
                voterPhotoPreview.innerHTML = `Current Photo: <a href="${existingPhotoUrl}" target="_blank">View Image</a>`;
                voterPhotoPreview.style.display = 'block';
            } else {
                voterPhotoPreview.style.display = 'none';
                voterPhotoPreview.innerHTML = '';
            }
    
            memberModal.show();
        }

        // --- Handle DELETE ---
        if (deleteBtn) {
            const regId = deleteBtn.dataset.regId;
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    const urlTemplate = "{% url 'delete_diwali_member' 0 %}";
                    const finalUrl = urlTemplate.replace('0', regId);

                    fetch(finalUrl, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCookie("csrftoken") }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server responded with status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire(
                                'Deleted!',
                                'The family member has been removed.',
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                data.message || 'Could not delete the member.',
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        console.error('Delete operation failed:', error);
                        Swal.fire(
                            'Request Failed!',
                            'An error occurred. Please check the console.',
                            'error'
                        );
                    });
                }
            });
        }
    });

    // --- Handle SAVE button click in modal (for both Add and Edit) ---
    document.getElementById('saveMemberBtn').addEventListener('click', () => {
        const headRegId = document.getElementById('headRegistrationId').value;
        const memberRegId = document.getElementById('memberRegId').value;

        // --- 1. Prepare the HEAD's data object (required by the backend) ---
        const headData = {
            userFirstname: document.getElementById('headFirstName').value,
            userMiddlename: document.getElementById('headMiddleName').value,
            userLastname: document.getElementById('headLastName').value,
            userMobileNo: document.getElementById('headMobileNo').value,
            AreaId: document.getElementById('headAreaId').value,
            address: document.getElementById('headAddress').value,
        };

        // --- 2. Prepare the new/edited MEMBER's data object ---
        const memberFullName = document.getElementById('memberName').value;
        const nameParts = memberFullName.trim().split(/\s+/);
        const firstname = nameParts.shift() || '';
        const lastname = nameParts.length > 0 ? nameParts.pop() : '';
        const middlename = nameParts.join(' ');
        
        // This is the member that will be added/updated.
        // NOTE: The backend only processes name, gender, and DOB for members based on the provided code.
        // Other fields like mobile and age might be ignored by the backend for members.
        const memberData = {
            registrationId: memberRegId, // '0' for new members
            userFirstname: firstname,
            userMiddlename: middlename,
            userLastname: lastname,
            // The backend expects Gender and DateOfBirth, but this form provides Age.
            // We are sending Age, which the backend might not use for members.
            // This is a limitation of the current backend code.
            Age: document.getElementById('memberAge').value || 0,
            userMobileNo: document.getElementById('memberMobile').value // Sending this just in case
        };

        // --- 3. Build the FormData object ---
        const formData = new FormData();
        formData.append('action', 'submit');
        formData.append('rationCardNo', document.getElementById('rationCardNo').value);
        formData.append('recordId', headRegId); // The "record" being updated is the family head
        
        // IMPORTANT: The head data and an ARRAY of family members are sent
        formData.append('head', JSON.stringify(headData));
        formData.append('family', JSON.stringify([memberData])); // The member is inside an array

        // Handle the Voter ID Photo if provided
        // NOTE: The backend code only saves VoterIdProof for the HEAD. This may not be saved for a member.
        const voterPhotoFile = document.getElementById('memberVoterIdPhoto').files[0];
        if (voterPhotoFile) {
            formData.append('VoterIdPhoto', voterPhotoFile);
        }

        // --- 4. Send the request ---
        fetch("{% url 'diwali_registration' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie("csrftoken")},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                memberModal.hide();
                Swal.fire('Success!', 'Family member details saved.', 'success')
                .then(() => window.location.reload());
            } else {
                Swal.fire('Error!', data.message || 'Could not save details.', 'error');
            }
        }).catch(err => {
            console.error(err);
            Swal.fire('Network Error!', 'Could not connect to server.', 'error');
        });
    });
});
</script>
</body>
</html>