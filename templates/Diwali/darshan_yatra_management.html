<!-- templates/Diwali/darshan_yatra_management.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darshan Yatra - Family Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; margin: 0; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; display: flex; align-items: center; }
        .back-btn { color: white; font-size: 24px; text-decoration: none; margin-right: 15px; }
        .header h1 { font-size: 22px; margin: 0; }
        .container-main { padding: 10px; max-width: 800px; margin: 0 auto; }
        .filter-container { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
        .search-bar { position: relative; flex-grow: 1; }
        .search-bar input, .form-select { padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .search-bar input { width: 100%; padding-left: 40px; }
        .search-bar .icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #a0aec0; }
        .no-results { text-align: center; padding: 40px; background: white; border-radius: 12px; }
        .accordion-item { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .accordion-header { padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: #f7fafc; border-bottom: 1px solid #e2e8f0; }
        .accordion-header h2 { font-size: 18px; margin: 0; color: #2d3748; }
        .accordion-header .ration-no { font-size: 14px; color: #718096; margin-top: 4px; }
        .accordion-header .chevron { font-size: 16px; color: #a0aec0; transition: transform 0.3s ease; }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease; padding: 0 20px; }
        .accordion-item.active .accordion-body { max-height: 1000px; padding: 20px; border-top: 1px solid #e2e8f0; }
        .accordion-item.active .accordion-header .chevron { transform: rotate(180deg); }
        .member { display: flex; align-items: center; margin-bottom: 15px; }
        .member .icon { font-size: 20px; color: #667eea; margin-right: 15px; width: 25px; text-align: center; }
        .member .details .name { font-weight: 600; color: #4a5568; }
        .member .details .meta { font-size: 13px; color: #a0aec0; }
        .actions-container { padding-top: 15px; margin-top: 15px; border-top: 1px dashed #cbd5e0; display: flex; justify-content: flex-end; }
        .btn-action { padding: 8px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: #667eea; color: white; } .btn-primary:hover { background-color: #5a67d8; }
    </style>
</head>
<body>
    <div class="header">
        <a href="{% url 'home' %}" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <h1>Darshan Yatra</h1>
    </div>

    <div class="container-main">
        <!-- Filter and Search Section -->
        <div class="filter-container">
            <select id="areaFilter" class="form-select" onchange="applyFilters()">
                <option value="">All Areas</option>
                {% if areas %}
                    {% for area in areas %}
                    <option value="{{ area.AreaId }}">{{ area.AreaName }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <div class="search-bar">
                <i class="fas fa-search icon"></i>
                <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search by name or ration card...">
            </div>
        </div>

        {% if families %}
            <div id="familyList">
            {% for family in families %}
                <!-- Added data-area-id for filtering -->
                <div class="accordion-item" data-area-id="{{ family.head.AreaId }}">
                    <div class="accordion-header">
                        <div>
                            <h2 class="head-name">{{ family.head.Firstname|title }} {{ family.head.Middlename|title }} {{ family.head.Lastname|title }}</h2>
                            <span class="ration-no">Ration: {{ family.ration_card_no }} &bull; Mo: {{ family.head.MobileNo }}</span>
                        </div>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="accordion-body">
                        {% for member in family.members %}
                        <div class="member">
                            <span class="icon"><i class="fas fa-user"></i></span>
                            <div class="details">
                                <div class="name">{{ member.Firstname }} {{ member.Middlename }} {{ member.Lastname }}</div>
                                <div class="meta">Family Member</div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted small">No other family members listed.</p>
                        {% endfor %}

                        <!-- Simplified Actions Container -->
                        <div class="actions-container">
                            <a href="{% url 'manage_family_members' family.ration_card_no %}" class="btn-action btn-primary" title="Add or Manage Members">
                                <i class="fas fa-user-plus"></i> Add Member
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
            <div id="noResults" class="no-results" style="display: none;">No families found matching your criteria.</div>
        {% else %}
            <div class="no-results">No registrations found.</div>
        {% endif %}
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Logic for expanding/collapsing the accordion
    const familyListContainer = document.getElementById('familyList');
    if (familyListContainer) {
        familyListContainer.addEventListener('click', function(event) {
            const header = event.target.closest('.accordion-header');
            if (header) {
                const item = header.parentElement;
                const isActive = item.classList.contains('active');
                // Optional: close other items when one is opened
                // document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('active'));
                if (!isActive) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            }
        });
    }
});

// Combined filter function for both search and area dropdown
function applyFilters() {
    const searchInput = document.getElementById("searchInput");
    const areaSelect = document.getElementById("areaFilter");
    const noResultsDiv = document.getElementById("noResults");
    
    const searchText = searchInput.value.toUpperCase();
    const selectedArea = areaSelect.value;
    
    const list = document.getElementById("familyList");
    const items = list.getElementsByClassName("accordion-item");
    let visibleCount = 0;

    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        
        // Check for area match
        const itemAreaId = item.getAttribute('data-area-id');
        const areaMatch = (selectedArea === "" || itemAreaId === selectedArea);
        
        // Check for text match (name or ration card)
        const headName = item.querySelector(".head-name");
        const rationNo = item.querySelector(".ration-no");
        const textContent = (headName.textContent || "") + (rationNo.textContent || "");
        const textMatch = textContent.toUpperCase().indexOf(searchText) > -1;
        
        // Show or hide based on both conditions
        if (areaMatch && textMatch) {
            item.style.display = "";
            visibleCount++;
        } else {
            item.style.display = "none";
        }
    }
    
    // Show or hide the "No results" message
    noResultsDiv.style.display = (visibleCount === 0) ? "block" : "none";
}
</script>

</body>
</html>