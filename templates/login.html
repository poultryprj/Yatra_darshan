<!doctype html>
{% load static %}
{% load pwa %}

<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="white">
    <title>Darshan Yatra</title>
    <meta name="description" content="Darshan Yatra">
    <meta name="keywords" content="Travel, Pilgrimage, Yatra" />
    <link rel="icon" type="image/png" href="{% static 'assets/img/favicon.png' %}" sizes="32x32">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/img/lakshya_pratishthan.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="manifest" href="{% static 'assets/__manifest.json' %}">
</head>

<body>
<style>
    /* White background everywhere */
    html, body, #appCapsule {
        background: white !important;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    /* Logo bigger */
    .logo-circle {
        width: 120px;   /* Increased size */
        height: 120px;  /* Increased size */
        border-radius: 50%;
        object-fit: contain;
        background: white;
        border: 2px solid #ddd;
        display: block;
        margin: 20px auto;
    }

    /* Middle block (card) grey background */
    .card {
        background-color: #f0f0f0 !important; /* Light grey */
        border: none;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Orange login button */
    .btn-success-custom {
        background-color: #ff7b00 !important;
        color: #fff !important;
        border: none;
        border-radius: 25px;
        padding: 14px;
        width: 100%;
        transition: background 0.3s;
    }
    .btn-success-custom:hover {
        background-color: #e66a00 !important;
        color: #fff !important;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-wrapper input.form-control {
        flex: 1;
        background: white !important;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px 40px 10px 10px; /* Right padding for icons */
    }

    .clear-input {
        position: absolute;
        right: 35px; /* leave space for eye icon */
        cursor: pointer;
        display: flex;
        align-items: center;
        height: 100%;
    }

    .toggle-password {
        position: absolute;
        right: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        height: 100%;
    }

    .clear-input ion-icon,
    .toggle-password ion-icon {
        font-size: 20px;
        color: #888;
    }

</style>


    <!-- loader -->
<div id="loader">
    <img src="{% static 'assets/img/loading-icon.png' %}" alt="icon" class="loading-icon">
</div>

<div id="appCapsule">

    <!-- ✅ Wrapper for logo, heading, form, and buttons -->
    <div class="login-wrapper">

        <!-- Logo + Title -->
        <div class="section mt-2 text-center">
            {% if ShopPhotoURL %}
                <img src="{{ ShopPhotoURL }}" alt="Shop Logo" class="logo-circle">
            {% else %}
                <img src="{% static 'assets/img/lakshya_pratishthan.png' %}" alt="Default Logo" class="logo-circle">
            {% endif %}

            <h1 style="color:black;">{{ BusinessName|default:"Darshan Yatra" }}</h1>
        </div>

        <!-- Login Form -->
        <div class="section mb-5 p-2">
            <form method="post" action="{% url 'login' %}">
                {% csrf_token %}
                <div class="card">
                    <div class="card-body pb-1">

                        <!-- Mobile Number -->
                        <div class="form-group basic animated">
                            <div class="input-wrapper">
                                <input type="text" name="mobile" class="form-control" id="mobile"
                                    placeholder="Your Mobile No." minlength="10" maxlength="10"
                                    pattern="\d{10}" inputmode="numeric"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <i class="clear-input">
                                    <ion-icon name="close-circle"></ion-icon>
                                </i>
                                <label class="label" for="mobile">Mobile Number</label>
                            </div>
                        </div>

                        <!-- Pin Number -->
                        <div class="form-group basic animated">
                            <div class="input-wrapper" style="position: relative;">
                                <input type="password" name="pin_number" class="form-control" id="pin_number"
                                    placeholder="Your Pin Number" autocomplete="off" maxlength="6"
                                    pattern="\d{6}" inputmode="numeric"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <i class="clear-input">
                                    <ion-icon name="close-circle"></ion-icon>
                                </i>
                                <label class="label" for="pin_number">Login Pin Number</label>

                                <!-- Eye Icon -->
                                <i class="toggle-password" onclick="togglePassword()">
                                    <ion-icon id="eyeIcon" name="eye-off-outline"></ion-icon>
                                </i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Button -->
                <div class="row mt-3">
                    <div class="col-12 mb-2 px-4">
                        <button type="submit" class="btn btn-success-custom btn-block btn-lg w-100"
                                style="color: white !important;">
                            Log in
                        </button>
                    </div>
                </div>
            </form> <!-- ✅ form closed here -->

            <!-- Extra buttons (outside form) -->
            <div class="row mt-1">
                <div class="col-12 mb-2 px-4">
                    <button id="installApp" type="button"
                            class="btn btn-success-custom btn-block btn-lg w-100"
                            style="color: white !important;">
                        Install App
                    </button>
                </div>
            </div>

            <!-- Install App Modal -->
            <div id="pwaInstallModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                        background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
                <div style="background:#fff; padding:20px; border-radius:10px; text-align:center;
                            max-width:300px; width:90%;">
                    <h3>Install {{ BusinessName|default:"Darshan Yatra" }} </h3>
                    <p>Get quick access to Darshan Yatra by installing it on your device.</p>
                    <button id="pwaInstallBtn"
                            style="margin:5px; padding:10px 20px; background:#ff7b00; color:#fff;
                                border:none; border-radius:5px;">
                        Install
                    </button>
                    <button id="pwaCancelBtn"
                            style="margin:5px; padding:10px 20px; background:#ccc; color:#000;
                                border:none; border-radius:5px;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div> <!-- ✅ login-wrapper ends -->
</div>



    <!-- Bootstrap -->
    <script src="{% static 'assets/js/lib/bootstrap.bundle.min.js' %}"></script>
    <!-- Ionicons -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
    <!-- Splide -->
    <script src="{% static 'assets/js/plugins/splide/splide.min.js' %}"></script>
    <!-- Base Js File -->
    <script src="{% static 'assets/js/base.js' %}"></script>

    <script>
    let deferredPrompt;
    const isAppInstalled = window.matchMedia('(display-mode: standalone)').matches;
    if (!isAppInstalled) {
        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const modal = document.getElementById('pwaInstallModal');
            modal.style.display = 'flex';
            const installBtn = document.getElementById('pwaInstallBtn');
            const cancelBtn = document.getElementById('pwaCancelBtn');
            installBtn.addEventListener('click', async () => {
                modal.style.display = 'none';
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
            });
            cancelBtn.addEventListener('click', (event) => {
                event.preventDefault();
                modal.style.display = 'none';
            });
        });
    }
    window.addEventListener("appinstalled", () => {
        console.log("PWA was installed");
    });
    </script>

    <script>
        function togglePassword() {
            const pinInput = document.getElementById("pin_number");
            const eyeIcon = document.getElementById("eyeIcon");
            if (pinInput.type === "password") {
                pinInput.type = "text";
                eyeIcon.setAttribute("name", "eye-outline");
            } else {
                pinInput.type = "password";
                eyeIcon.setAttribute("name", "eye-off-outline");
            }
        }

        // Function to handle clear input icons
        function setupClearInputs() {
            document.querySelectorAll('.clear-input').forEach(clearIcon => {
                const input = clearIcon.previousElementSibling; // The input field is the sibling before the clear icon

                if (input) {
                    // Initial check to show/hide icon
                    if (input.value) {
                        clearIcon.style.opacity = '1';
                    } else {
                        clearIcon.style.opacity = '0';
                    }

                    // Event listener for clearing input
                    clearIcon.addEventListener('click', () => {
                        input.value = '';
                        input.focus(); // Keep focus on the input after clearing
                        clearIcon.style.opacity = '0'; // Hide icon after clearing
                    });

                    // Event listener for input changes to show/hide clear icon
                    input.addEventListener('input', () => {
                        if (input.value) {
                            clearIcon.style.opacity = '1';
                        } else {
                            clearIcon.style.opacity = '0';
                        }
                    });
                }
            });
        }

        // Call setupClearInputs when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', setupClearInputs);

    </script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

    {% if messages %}
        <script>
            {% for message in messages %}
                var msg = "{{ message|escapejs }}";
                var tag = "{{ message.tags }}";

                var alertType = "info";
                var alertTitle = "Info";

                if (tag.includes("success")) {
                    alertType = "success";
                    alertTitle = "Success!";
                } else if (tag.includes("danger")) {
                    alertType = "error";
                    alertTitle = "Error!";
                }

                swal({
                    title: alertTitle,
                    text: msg,
                    type: alertType,
                    showConfirmButton: true
                });
            {% endfor %}
        </script>
    {% endif %}
</body>

</html>