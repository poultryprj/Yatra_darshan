{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Yatra Darshan Booking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
    <style>
        :root { --theme-orange: #ff7b00; --theme-blue: #0d6efd; --light-gray: #f0f2f5; }
        body { background-color: var(--light-gray); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .navbar { background-color: var(--theme-orange); }
        .main-container { margin-top: 70px; padding-bottom: 2rem; }
        .booking-card { background: #ffffff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.07); }
        .search-wrapper { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .search-wrapper .form-control { height: 44px; } .search-wrapper .btn { min-width: 44px; }
        .nav-tabs { border-bottom: 2px solid #dee2e6; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; }
        .nav-tabs .nav-link.active { color: var(--theme-orange); border-bottom: 3px solid var(--theme-orange); font-weight: 600; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: var(--theme-blue); margin-bottom: 1rem; }
        .passenger-list { list-style: none; padding-left: 0; max-height: 250px; overflow-y: auto; }
        .passenger-list-item { background-color: var(--light-gray); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .passenger-list-item:hover { background-color: #dee2e6; }
        .btn-orange { background-color: var(--theme-orange); color: white; font-weight: bold; }
        .offcanvas-header { background-color: var(--theme-orange); color: white; }
        .offcanvas-body { display: flex; flex-direction: column; }
        .form-fieldset { border: 1px solid #ced4da; border-radius: 8px; padding: 0.25rem 0.75rem 0.5rem 0.75rem; margin-bottom: 1rem; position: relative; }
        .form-fieldset legend { float: none; width: auto; padding: 0 5px; margin-left: 5px; font-size: 0.8rem; color: var(--theme-orange); font-weight: 500; }
        .form-fieldset input, .form-fieldset select { border: none; outline: none; width: 100%; height: 30px; padding: 0; background-color: transparent; }
        .form-fieldset:focus-within { border-color: var(--theme-orange); }
        .form-label-file { font-size: 0.8rem; color: var(--theme-orange); margin-bottom: 0.25rem; font-weight: 500; }
    </style>
</head>
<body>

<nav class="navbar fixed-top"><div class="container-fluid"><span class="navbar-brand mb-0 h1 text-white">Yatra Darshan Booking</span></div></nav>

<div class="container main-container">
    <div class="booking-card">
        <div class="search-wrapper">
            <input type="text" class="form-control" placeholder="Search by Mobile No." id="mobileSearchInput">
            <button class="btn btn-outline-secondary" id="searchBtn"><i class="bi bi-search"></i></button>
        </div>
        <ul class="nav nav-tabs" id="bookingTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#registration" type="button">Registration</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#booking" type="button">Ticket Booking</button></li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="registration" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="section-title mb-0" id="registrationsTitle">Registrations for Mobile No.</h5>
                    <button class="btn btn-orange btn-sm" id="addRegistrationBtn" data-bs-toggle="offcanvas" data-bs-target="#registrationOffcanvas"><i class="bi bi-plus-lg"></i> Add New</button>
                </div>
                <ul class="passenger-list" id="passengerListContainer"><li class="text-muted">Search for a mobile number.</li></ul>
                <div class="text-end my-3"><button class="btn btn-orange" id="bookNextBtn">Book Next <i class="bi bi-arrow-right"></i></button></div>
                <hr>
                <!-- History Section Updated with Bootstrap Grid -->
                <div class="row g-2 align-items-center mt-3">
                    <div class="col-auto">
                        <h5 class="section-title mb-0">Booking History</h5>
                    </div>
                    <div class="col">
                        <select class="form-select form-select-sm" id="historyPassengerSelect"></select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="historyYearSelect" style="width: 100px;"></select>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="booking" role="tabpanel"><p>Ticket booking form.</p></div>
        </div>
    </div>
</div>

<!-- Offcanvas (No changes here) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="registrationOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="registrationOffcanvasTitle">Add New Registration</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <form id="registrationForm" class="d-flex flex-column flex-grow-1">
            <div class="flex-grow-1">
                <div class="row g-3">
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Mobile No. *</legend><input type="text" id="formMobile" name="MobileNo" required></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Alternate Mobile</legend><input type="text" id="formAltMobile" name="AlternateMobileNo"></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>First Name *</legend><input type="text" id="formFirstName" name="Firstname" required></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Middle Name *</legend><input type="text" id="formMiddleName" name="Middlename" required></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Last Name *</legend><input type="text" id="formLastName" name="Lastname" required></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Area *</legend><select id="formArea" name="AreaId" required><option value="">Select</option></select></fieldset></div>
                    <div class="col-12"><fieldset class="form-fieldset"><legend>Address *</legend><input type="text" id="formAddress" name="Address" required></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Gender</legend><select id="formGender" name="Gender"><option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option></select></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Blood Group</legend><select id="formBloodGroup" name="BloodGroup"><option value="">Select</option></select></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Date of Birth</legend><input type="text" id="formDob" name="DateOfBirth" placeholder="dd-mm-yyyy"></fieldset></div>
                    <div class="col-6"><fieldset class="form-fieldset"><legend>Aadhar No.</legend><input type="text" id="formAadhar" name="AadharNumber"></fieldset></div>
                    <div class="col-6 mb-3"><label class="form-label-file">Aadhar Upload</label><input class="form-control form-control-sm" type="file" id="formAadharUpload"></div>
                    <div class="col-6 mb-3"><label class="form-label-file">Profile Picture Upload</label><input class="form-control form-control-sm" type="file" id="formProfilePic"></div>
                    <div class="col-12 mb-3"><label class="form-label-file">Voter ID Upload</label><input class="form-control form-control-sm" type="file" id="formVoterId"></div>
                </div>
            </div>
            <div class="text-center mt-auto pt-3"> 
                <button type="submit" class="btn btn-orange btn-lg w-100" id="registrationSubmitBtn"><i class="bi bi-check-circle"></i> Submit</button>
            </div>
            <input type="hidden" id="formRegistrationId" name="RegistrationId">
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

<!-- ================================== -->
<!--  SCRIPT BLOCK 1: INITIALIZATION    -->
<!-- ================================== -->
<script>
    const API_URL = "{% url 'TicketBookingApi' %}";
    let allRegistrationsData = [];
    let bookingTab, registrationOffcanvas;
    const searchInput = document.getElementById('mobileSearchInput');
    const passengerListContainer = document.getElementById('passengerListContainer');
    const registrationsTitle = document.getElementById('registrationsTitle');
    const historyPassengerSelect = document.getElementById('historyPassengerSelect');

    document.addEventListener('DOMContentLoaded', () => {
        bookingTab = new bootstrap.Tab(document.querySelector('[data-bs-target="#booking"]'));
        registrationOffcanvas = new bootstrap.Offcanvas(document.getElementById('registrationOffcanvas'));
        document.getElementById('searchBtn').addEventListener('click', handleSearch);
        document.getElementById('addRegistrationBtn').addEventListener('click', () => setupRegistrationForm('add'));
        document.getElementById('bookNextBtn').addEventListener('click', () => bookingTab.show());
        passengerListContainer.addEventListener('click', (e) => {
            const listItem = e.target.closest('li.passenger-list-item');
            if (listItem) {
                setupRegistrationForm('edit', listItem.dataset.id);
            }
        });
        populateYearDropdown();
    });

    /**
     * Populates the history year dropdown and selects the current year.
     */
    function populateYearDropdown() {
        const yearSelect = document.getElementById('historyYearSelect');
        const currentYear = new Date().getFullYear();
        yearSelect.innerHTML = '';
        // Corrected loop to go from 2025 up to the current year
        for (let i = 2025; i <= currentYear; i--) {
            yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
        }
        yearSelect.value = currentYear; // Set default to current year
    }
</script>

<!-- ================================================ -->
<!--  SCRIPT BLOCK 2: SEARCH AND DISPLAY LOGIC        -->
<!-- ================================================ -->
<script>
    async function handleSearch() {
        const mobileNo = searchInput.value.trim();
        if (mobileNo.length < 10) {
            swal("Error", "Please enter a valid 10-digit mobile number.", "error");
            return;
        }
        passengerListContainer.innerHTML = '<li>Loading...</li>';
        registrationsTitle.textContent = `Registrations for ${mobileNo}`;
        const formData = new FormData();
        formData.append('action', 'search_registrations');
        formData.append('MobileNo', mobileNo);

        try {
            const response = await fetch(API_URL, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.message_code === 1000 && data.message_data.length > 0) {
                allRegistrationsData = data.message_data;
                displayRegistrations(allRegistrationsData);
                populatePassengerDropdown(allRegistrationsData);
                // Set default passenger selection to the first person
                if (allRegistrationsData.length > 0) {
                    historyPassengerSelect.value = allRegistrationsData[0].RegistrationId;
                }
            } else {
                allRegistrationsData = [];
                passengerListContainer.innerHTML = `<li class="text-muted">${data.message_text || 'No registrations found.'}</li>`;
                populatePassengerDropdown([]);
            }
        } catch (error) {
            swal("Error", "Could not fetch registrations.", "error");
            passengerListContainer.innerHTML = '<li class="text-danger">Failed to load data.</li>';
            populatePassengerDropdown([]);
        }
    }

    function displayRegistrations(registrations) {
        passengerListContainer.innerHTML = '';
        registrations.forEach(reg => {
            const fullName = `${reg.Firstname || ''} ${reg.Middlename || ''} ${reg.Lastname || ''}`.trim();
            const li = document.createElement('li');
            li.className = 'passenger-list-item';
            li.textContent = fullName || 'Unnamed Registration';
            li.dataset.id = reg.RegistrationId;
            passengerListContainer.appendChild(li);
        });
    }

    /**
     * Populates the passenger dropdown with only the first name.
     */
    function populatePassengerDropdown(registrations) {
        historyPassengerSelect.innerHTML = '<option value="">Select Reg.</option>';
        registrations.forEach(reg => {
            const firstName = reg.Firstname || 'Unnamed';
            historyPassengerSelect.innerHTML += `<option value="${reg.RegistrationId}">${firstName}</option>`;
        });
    }
</script>

<!-- ================================================ -->
<!--  SCRIPT BLOCK 3: REGISTRATION FORM LOGIC         -->
<!-- ================================================ -->
<script>
    const registrationForm = document.getElementById('registrationForm');
    const registrationOffcanvasTitle = document.getElementById('registrationOffcanvasTitle');
    const registrationSubmitBtn = document.getElementById('registrationSubmitBtn');

    function setupRegistrationForm(mode, registrationId = null) {
        registrationForm.reset();
        if (mode === 'add') {
            registrationOffcanvasTitle.textContent = 'Add New Registration';
            registrationSubmitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit';
            document.getElementById('formMobile').value = searchInput.value;
            document.getElementById('formRegistrationId').value = '';
        } else if (mode === 'edit') {
            const regData = allRegistrationsData.find(reg => reg.RegistrationId === registrationId);
            if (!regData) { swal("Error", "Could not find registration data.", "error"); return; }
            document.getElementById('formRegistrationId').value = regData.RegistrationId;
            document.getElementById('formMobile').value = regData.MobileNo || '';
            document.getElementById('formAltMobile').value = regData.AlternateMobileNo || '';
            document.getElementById('formFirstName').value = regData.Firstname || '';
            document.getElementById('formMiddleName').value = regData.Middlename || '';
            document.getElementById('formLastName').value = regData.Lastname || '';
            document.getElementById('formAddress').value = regData.Address || '';
            document.getElementById('formDob').value = regData.DateOfBirth || '';
            document.getElementById('formAadhar').value = regData.AadharNumber || '';
            registrationOffcanvasTitle.textContent = 'Edit Registration';
            registrationSubmitBtn.innerHTML = '<i class="bi bi-arrow-up-circle"></i> Update';
            registrationOffcanvas.show();
        }
    }
    
    async function handleRegistrationFormSubmit(event) {
        event.preventDefault();
        const isUpdating = !!document.getElementById('formRegistrationId').value;
        const formData = new FormData(registrationForm);
        formData.append('action', isUpdating ? 'update_registration' : 'add_registration');
        try {
            const response = await fetch(API_URL, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.message_code === 1000) {
                swal("Success", data.message_text, "success");
                registrationOffcanvas.hide();
                handleSearch();
            } else {
                swal("Error", data.message_text || "An unknown error occurred.", "error");
            }
        } catch (error) {
            swal("Error", "An operation failed. Please check your connection.", "error");
        }
    }
    registrationForm.addEventListener('submit', handleRegistrationFormSubmit);
</script>

</body>
</html>