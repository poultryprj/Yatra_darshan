{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Registrations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { background-color: #f8fafc; font-family: "Poppins", "Segoe UI", Roboto, sans-serif; }
    .navbar { background: linear-gradient(90deg, #6a11cb, #2575fc); color: #fff; padding: 0.8rem 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .navbar-brand { font-weight: 600; font-size: 1.2rem; }
    .back-btn { font-size: 1.5rem; color: #fff; text-decoration: none; }
    .search-box { background: #fff; border-radius: 10px; margin: 1rem; padding: 0.5rem 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; align-items: center; }
    .search-box input { border: none; outline: none; flex: 1; margin-left: 8px; font-size: 0.95rem; }
    .reg-card { background: #ffffff; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); margin: 0.6rem 1rem; padding: 0.8rem 1rem; display: flex; align-items: center; justify-content: space-between; }
    .reg-details { flex-grow: 1; }
    .reg-name { font-weight: 600; color: #222; font-size: 1rem; margin-bottom: 0.2rem; }
    .reg-info { color: #6c757d; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .qr-icon { font-size: 1.8rem; color: #6a11cb; cursor: pointer; transition: transform 0.2s; }
    .qr-icon:hover { transform: scale(1.1); }
    .empty-state { text-align: center; color: #777; padding: 3rem 1rem; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar sticky-top d-flex justify-content-between align-items-center">
    <a href="{% url 'event_list_page' %}" class="back-btn"><i class="bi bi-arrow-left"></i></a>
    <span class="navbar-brand mb-0">Registrations</span>
    <a href="{% url 'public_registration_page' event_id=event_id %}" class="text-white fs-5"><i class="bi bi-plus-circle"></i></a>
  </nav>

  <!-- Search -->
  <div class="search-box">
    <i class="bi bi-search text-muted"></i>
    <input type="text" id="searchInput" placeholder="Search by name, mobile, or token...">
  </div>

  <!-- Registrations -->
  <div id="regList">
    {% if registration_data.registrations %}
      {% for reg in registration_data.registrations %}
        <div class="reg-card" data-name="{{ reg.firstname }} {{ reg.lastname }}" data-mobile="{{ reg.mobileNo }}" data-token="{{ reg.TokenNo }}">
            <div class="reg-details">
              <div class="reg-name">
                <span class="badge bg-primary me-2">#{{ reg.TokenNo }}</span>
                {{ reg.firstname }} {{ reg.lastname }}
              </div>
              <div class="reg-info">
                Mo: {{ reg.mobileNo|default:"-" }} 
                {% if reg.address %} â€¢ {{ reg.address }}{% endif %}
              </div>
            </div>
            <i class="bi bi-qr-code-scan qr-icon" 
               data-bs-toggle="modal" 
               data-bs-target="#qrModal" 
               data-token="{{ reg.TokenNo }}" 
               data-name="{{ reg.firstname }} {{ reg.lastname }}"
               data-qr-url="{{ reg.QRURL }}">
            </i>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <i class="bi bi-person-x display-6 d-block mb-2"></i>
        No registrations found for this event yet.
      </div>
    {% endif %}
  </div>

  <!-- QR Display Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">Registration Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <h4 id="modal-reg-name"></h4>
                    <p>Token Number: <strong class="text-primary" id="modal-token-no"></strong></p>
                    <div id="modal-qr-code-container" class="p-2 bg-light d-inline-block">
                        <!-- QR Code will be generated here by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- QR Code Generator Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
  <script>
    // Search filter
    document.getElementById("searchInput").addEventListener("keyup", function () {
      const filter = this.value.toLowerCase();
      document.querySelectorAll(".reg-card").forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const mobile = card.dataset.mobile.toLowerCase();
        const token = card.dataset.token.toLowerCase();
        card.style.display = (name.includes(filter) || mobile.includes(filter) || token.includes(filter)) ? "" : "none";
      });
    });

    // QR Modal Logic
    const qrModal = document.getElementById('qrModal');
    qrModal.addEventListener('show.bs.modal', function (event) {
        const icon = event.relatedTarget;
        const name = icon.getAttribute('data-name');
        const token = icon.getAttribute('data-token');
        const qrUrl = icon.getAttribute('data-qr-url');

        const modalTitle = qrModal.querySelector('#modal-reg-name');
        const modalToken = qrModal.querySelector('#modal-token-no');
        const qrContainer = qrModal.querySelector('#modal-qr-code-container');

        modalTitle.textContent = name;
        modalToken.textContent = `#${token}`;
        qrContainer.innerHTML = ''; // Clear previous QR code

        // Generate QR code using the library
        try {
            const typeNumber = 4;
            const errorCorrectionLevel = 'L';
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(qrUrl);
            qr.make();
            qrContainer.innerHTML = qr.createImgTag(5, 5); // (cellSize, margin)
        } catch (e) {
            qrContainer.innerHTML = "Could not generate QR code.";
            console.error(e);
        }
    });
  </script>

</body>
</html>