<!-- templates/bus_master.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Darshan Yatra - Bus Master</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
    <style>
        /* --- NEW, ATTRACTIVE DESIGN STYLES --- */
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; }
        .navbar { background-color: #ff7b00; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .back-btn { font-size: 1.5rem; color: white; text-decoration: none; }
        .navbar-brand { font-weight: bold; }
        .container-main { max-width: 800px; margin: 80px auto 40px auto; }
        
        .accordion-button { font-weight: bold; font-size: 1.1rem; }
        .accordion-button:not(.collapsed) { background-color: #fff8f0; color: #ff7b00; box-shadow: inset 0 -1px 0 rgba(0,0,0,.125); }
        .accordion-button:focus { box-shadow: 0 0 0 .25rem rgba(255, 123, 0, 0.25); }
        
        .bus-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        /* Modal Styles */
        .modal-header { background-color: #003399; color: white; }
        .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .modal-body label { font-weight: 600; color: #555; }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #ff7b00;
            box-shadow: 0 0 0 .25rem rgba(255, 123, 0, 0.25);
        }
    </style>
</head>
<body>

<nav class="navbar fixed-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="{% url 'Registrationpage1' %}" class="back-btn"><i class="bi bi-arrow-left-circle"></i></a>
        <span class="navbar-brand mb-0 h1" style="color:white">Bus Master</span>
        <span style="width: 30px;"></span> 
    </div>
</nav>

<div class="container-main">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h4 class="mb-3 text-primary">Manage Yatra Buses</h4>
            <div class="accordion" id="yatraAccordion">
                {% for yatra in yatras_with_buses %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ yatra.YatraId }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ yatra.YatraId }}">
                            {{ yatra.YatraRouteName }} ({{ yatra.YatraDateTime }})
                        </button>
                    </h2>
                    <div id="collapse-{{ yatra.YatraId }}" class="accordion-collapse collapse" data-bs-parent="#yatraAccordion">
                        <div class="accordion-body">
                            <div class="bus-list">
                                {% for bus in yatra.buses %}
                                <div class="bus-list-item">
                                    <div><i class="bi bi-bus-front-fill me-2"></i><strong>Bus {{ bus.BusName }}</strong><small class="text-muted ms-2">(Capacity: {{ bus.BusCapacity }})</small></div>
                                    <button class="btn btn-sm btn-outline-primary edit-bus-btn" data-bs-toggle="modal" data-bs-target="#editBusModal" data-bus-info='{{ bus.json_string }}'><i class="bi bi-pencil-fill"></i></button>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-sm btn-success mt-3 add-bus-btn" data-bs-toggle="modal" data-bs-target="#addBusModal" data-yatra-id="{{ yatra.YatraId }}" data-route-id="{{ yatra.YatraRouteId }}" data-datetime="{{ yatra.YatraDateTime }}" data-fees="{{ yatra.YatraFees }}">
                                <i class="bi bi-plus-circle"></i> Add Buses
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-muted">No Yatras found. Please create a Yatra first.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Buses Modal -->
<div class="modal fade" id="addBusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add Buses</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p class="text-muted">Enter a capacity for each bus you want to add. Leave blank to ignore.</p>
                <div id="busCapacityContainer"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="saveAddBusBtn">Save Buses</button></div>
        </div>
    </div>
</div>

<!-- Edit Bus Modal -->
<div class="modal fade" id="editBusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Bus Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="editBusForm">
            <input type="hidden" id="editYatraBusId"><input type="hidden" id="editYatraId"><input type="hidden" id="editRouteId">
            <div class="mb-3"><label class="form-label">Bus Name</label><input type="text" id="editBusName" class="form-control" readonly></div>
            <div class="mb-3"><label class="form-label">Capacity</label><input type="number" id="editBusCapacity" class="form-control" placeholder="e.g., 45"></div>
            <div class="mb-3"><label class="form-label">Seat Fees</label><input type="number" id="editSeatFees" class="form-control" placeholder="e.g., 500"></div>
            <div class="mb-3"><label class="form-label">Start Date & Time</label><input type="datetime-local" id="editBusDateTimeStart" class="form-control"></div>
            <div class="mb-3"><label class="form-label">Status</label><select id="editBusStatus" class="form-select"><option value="1">Active</option><option value="0">Inactive</option></select></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="saveEditBusBtn">Update Bus</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script>
    const addBusModal = new bootstrap.Modal(document.getElementById('addBusModal'));
    const editBusModal = new bootstrap.Modal(document.getElementById('editBusModal'));
    let currentYatraInfo = {};

    function formatToApiDateTime(dateString) {
        if (!dateString) return '';
        const parts = dateString.split(' ');
        const datePart = parts[0];
        const timePart = parts.length > 1 ? parts[1] : '00:00:00';
        const [day, month, year] = datePart.split('-');
        return `${year}-${month}-${day} ${timePart}`;
    }
    function formatToInputDateTime(dateString) {
        if (!dateString) return '';
        const parts = dateString.split(' ');
        const datePart = parts[0];
        const timePart = parts.length > 1 ? parts[1] : '00:00';
        const [day, month, year] = datePart.split('-');
        return `${year}-${month}-${day}T${timePart.slice(0, 5)}`;
    }

    document.addEventListener('click', e => {
        const addBtn = e.target.closest('.add-bus-btn');
        if (addBtn) {
            currentYatraInfo = addBtn.dataset;
            populateAddBusModal();
        }
        const editBtn = e.target.closest('.edit-bus-btn');
        if (editBtn) {
            const busInfo = JSON.parse(editBtn.dataset.busInfo);
            document.getElementById('editYatraBusId').value = busInfo.YatraBusId;
            document.getElementById('editYatraId').value = busInfo.YatraId;
            document.getElementById('editRouteId').value = busInfo.YatraRouteId;
            document.getElementById('editBusName').value = `Bus ${busInfo.BusName}`;
            document.getElementById('editBusCapacity').value = busInfo.BusCapacity;
            document.getElementById('editSeatFees').value = busInfo.SeatFees;
            document.getElementById('editBusStatus').value = busInfo.BusStatus;
            document.getElementById('editBusDateTimeStart').value = formatToInputDateTime(busInfo.BusDateTimeStart);
        }
    });

    function populateAddBusModal() {
    const busCapacityContainer = document.getElementById('busCapacityContainer');
    busCapacityContainer.innerHTML = '';
    
    // Step 1: Find out which buses are already assigned to the current Yatra.
    // We get the accordion item for the current Yatra.
    const currentAccordionItem = document.querySelector(`#collapse-${currentYatraInfo.yatraId}`);
    const existingBusElements = currentAccordionItem.querySelectorAll('.bus-list-item strong');
    const existingBusNames = new Set();
    existingBusElements.forEach(el => {
        // Extract just the letter, e.g., 'A' from 'Bus A'
        const busName = el.textContent.replace('Bus ', '').trim();
        existingBusNames.add(busName);
    });

    const busLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
    busLetters.forEach(letter => {
        const div = document.createElement('div');
        div.className = 'input-group input-group-sm mb-2';

        // Step 2: Check if this bus letter already exists for the Yatra.
        const isDisabled = existingBusNames.has(letter);
        
        // Step 3: If it exists, disable the input and add a visual cue.
        // Otherwise, create a normal, enabled input.
        div.innerHTML = `
            <span class="input-group-text" style="width: 80px;">Bus ${letter}</span>
            <input 
                type="number" 
                class="form-control" 
                placeholder="${isDisabled ? 'Already Added' : 'Capacity'}" 
                data-bus-name="${letter}"
                ${isDisabled ? 'disabled' : ''}>
        `;
        busCapacityContainer.appendChild(div);
    });
}

    document.getElementById('saveAddBusBtn').addEventListener('click', () => {
        const capacityInputs = document.getElementById('busCapacityContainer').querySelectorAll('input[type="number"]');
        const promises = [];
        capacityInputs.forEach(input => {
            const capacity = parseInt(input.value, 10);
            if (capacity > 0) {
                const formData = new FormData();
                formData.append('action', 'create_bus');
                formData.append('busName', input.dataset.busName);
                formData.append('capacity', capacity);
                formData.append('yatraId', currentYatraInfo.yatraId);
                formData.append('routeId', currentYatraInfo.routeId);
                formData.append('dateTime', formatToApiDateTime(currentYatraInfo.datetime));
                formData.append('seatFees', currentYatraInfo.fees);
                promises.push(fetch("{% url 'bus_master_api' %}", { method: 'POST', body: formData }));
            }
        });
        if (promises.length === 0) {
            swal("Info", "Please enter a capacity for at least one bus.", "info");
            return;
        }
        Promise.all(promises).then(() => {
            swal({ title: "Success!", text: "Buses created successfully.", type: "success" }, () => location.reload());
        }).catch(err => swal("Error", "Failed to create buses.", "error"));
    });

    document.getElementById('saveEditBusBtn').addEventListener('click', () => {
        const formData = new FormData();
        formData.append('action', 'update_bus');
        formData.append('yatraBusId', document.getElementById('editYatraBusId').value);
        formData.append('yatraId', document.getElementById('editYatraId').value);
        formData.append('routeId', document.getElementById('editRouteId').value);
        formData.append('busName', document.getElementById('editBusName').value.replace('Bus ', ''));
        formData.append('capacity', document.getElementById('editBusCapacity').value);
        formData.append('seatFees', document.getElementById('editSeatFees').value);
        formData.append('status', document.getElementById('editBusStatus').value);
        const dtValue = document.getElementById('editBusDateTimeStart').value;
        formData.append('dateTime', new Date(dtValue).toISOString().slice(0, 19).replace('T', ' '));
        fetch("{% url 'bus_master_api' %}", { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.message_code === 1000) {
                    swal({ title: "Success!", text: data.message_text, type: "success" }, () => location.reload());
                } else {
                    swal("Error", data.message_text || "Update failed.", "error");
                }
            });
    });
</script>
</body>
</html>