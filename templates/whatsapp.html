{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk WhatsApp Messaging</title>

    <!-- Essential CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
    
    <!-- Libraries for Select2 Dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="manifest" href="{% static 'assets/__manifest.json' %}">

    <style>
        :root {
            --brand-orange: #ff7b00;
            --brand-orange-dark: #e67000;
            --brand-blue: #003399;
            --brand-green: #006633;
        }
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; }
        .navbar { background-color: var(--brand-orange); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .back-btn { font-size: 1.5rem; color: white; text-decoration: none; }
        .navbar-brand { font-weight: bold; }
        .container-main { max-width: 900px; margin: 80px auto; border: none; padding: 0; background-color: transparent; box-shadow: none; }
        .btn-brand-send { background-color: var(--brand-orange); color: white; font-weight: bold; }
        .btn-brand-send:hover { background-color: var(--brand-orange-dark); color: white; }
        .table thead { background-color: var(--brand-blue); color: white; }
        .table th:first-child, .table td:first-child { width: 50px; text-align: center; }
        @media (max-width: 576px) { .container-main { margin: 56px 0 0 0; } .card { border-radius: 0; border-left: none; border-right: none; } }
        .select2-container--bootstrap-5 .select2-dropdown { z-index: 1060; }
    </style>
</head>
<body>

<!-- Top Navigation Bar -->
<nav class="navbar fixed-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="{% url 'Registrationpage1' %}" class="back-btn"><i class="bi bi-arrow-left-circle"></i></a>
        <span class="navbar-brand mb-0 h1" style="color:white">WhatsApp Sender</span>
        <span style="width: 30px;"></span>
    </div>
</nav>

<!-- Main Page Content -->
<div class="container-main">
    <div class="card">
        <div class="card-body">
            <h4 class="mb-3" style="color: var(--brand-green);"><i class="bi bi-whatsapp"></i> Bulk WhatsApp Sender</h4>

            <!-- Step 1: Filters -->
            <div class="card shadow-sm mb-4">
                <div class="card-header fw-bold">Step 1: Select Recipients</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12"><label for="routeFilter" class="form-label">Route</label><select id="routeFilter" class="form-select">
                            <option value="">-- Choose a Route --</option>{% for route in routes %}<option value="{{ route.YatraRouteId }}">{{ route.YatraRouteName }}</option>{% endfor %}</select></div>
                        <div class="col-12"><label for="yatraFilter" class="form-label">Yatra (Date)</label><select id="yatraFilter" class="form-select" disabled><option value="">-- Select Route First --</option></select></div>
                        <div class="col-12"><label for="busFilter" class="form-label">Bus</label><select id="busFilter" class="form-select" disabled><option value="">-- Select Yatra First --</option></select></div>
                    </div>
                </div>
            </div>

            <!-- Message Composer and Recipient List Container -->
            <div id="mainContentContainer" class="d-none">
                <!-- Step 2: Message Composer -->
                <h5 class="card-title">Step 2: Compose Your Message</h5>
                
                <!-- ✅ NEW: Template Selector -->
                <div class="mb-3">
                    <label for="templateSelector" class="form-label">Select a Message Template (Optional)</label>
                    <select id="templateSelector" class="form-select">
                        <option value="">-- Write a Custom Message --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="customMessageBody" class="form-label">Message Body</label>
                    <textarea id="customMessageBody" class="form-control" rows="5" placeholder="Type a custom message or select a template..."></textarea>
                </div>
                <div class="form-text mb-3">Placeholders like <code>{{NAME}}</code> will be replaced for each passenger.</div>
                <button id="btnSendCustomMessage" class="btn btn-brand-send w-100 btn-lg"><i class="bi bi-send-fill me-2"></i>Send to Selected Recipients</button>
                <hr class="my-4">

                <!-- Step 3: Recipient List -->
                <h5 class="card-title">Recipients (Selected: <span id="recipientCount">0</span>)</h5>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr><th><input class="form-check-input" type="checkbox" id="selectAllCheckbox" title="Select All"></th><th>Name</th><th>Mobile No</th></tr>
                        </thead>
                        <tbody id="passengerTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="loader" class="text-center my-4 d-none"><div class="spinner-border" style="color: var(--brand-orange);" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Fetching recipients...</p></div>
            <div id="statusMessage" class="alert text-center d-none"></div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmBulkSendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirm Bulk Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div id="modalBodyContent" class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" id="confirmSendBtn" class="btn btn-success">Yes, Send Message</button></div></div>
    </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Page-Specific JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Initialize DOM Elements ---
    const mainContentContainer = document.getElementById('mainContentContainer');
    const passengerTableBody = document.getElementById('passengerTableBody');
    const loader = document.getElementById('loader');
    const statusMessage = document.getElementById('statusMessage');
    const customMessageBody = document.getElementById('customMessageBody');
    const btnSendCustomMessage = document.getElementById('btnSendCustomMessage');
    const recipientCountSpan = document.getElementById('recipientCount');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const confirmBulkSendModal = new bootstrap.Modal(document.getElementById('confirmBulkSendModal'));
    const confirmSendBtn = document.getElementById('confirmSendBtn');
    const modalBodyContent = document.getElementById('modalBodyContent');
    const templateSelector = document.getElementById('templateSelector'); // New element
    
    let yatraDataCache = {};
    let messageTemplates = []; // To store fetched templates

    // --- Initialize Select2 Dropdowns ---
    $('#routeFilter, #yatraFilter, #busFilter, #templateSelector').select2({ theme: "bootstrap-5" });

    // ✅ NEW: Function to load message templates on page load
    async function loadMessageTemplates() {
        try {
            const response = await fetch("{% url 'get_whatsapp_templates_api' %}");
            const result = await response.json();
            if (result.message_code === 1000 && Array.isArray(result.message_data)) {
                messageTemplates = result.message_data; // Store for later use
                const templateSelect = $('#templateSelector');
                // Clear any existing options except the first one
                templateSelect.find('option:not(:first)').remove(); 
                messageTemplates.forEach(template => {
                    // Add new templates to the dropdown
                    templateSelect.append(new Option(template.TemplateTitle, template.TemplateId, false, false));
                });
                templateSelect.trigger('change'); // Notify Select2 of changes
            }
        } catch (error) {
            console.error("Failed to load message templates:", error);
        }
    }

    // Call the new function when the page loads
    loadMessageTemplates();

    // ✅ NEW: Event listener for the template selector
    $('#templateSelector').on('change', function() {
        const selectedTemplateId = this.value;
        if (selectedTemplateId) {
            const selectedTemplate = messageTemplates.find(t => t.TemplateId == selectedTemplateId);
            if (selectedTemplate) {
                customMessageBody.value = selectedTemplate.TemplateMessageBody;
            }
        } else {
            // If the user selects "-- Write a Custom Message --", clear the textarea
            customMessageBody.value = '';
        }
    });

    // --- Filter Logic ---
    $('#routeFilter').on('change', async function() { /* ... no changes ... */ });
    $('#yatraFilter').on('change', function() { /* ... no changes ... */ });
    $('#busFilter').on('change', function() { /* ... no changes ... */ });
    
    // --- Data Fetching, Rendering, and Sending Logic (is all the same as before) ---
    async function fetchAndRenderPassengers() { /* ... no changes ... */ }
    function renderPassengerTable(passengers) { /* ... no changes ... */ }
    function updateSelectedCount() { /* ... no changes ... */ }
    selectAllCheckbox.addEventListener('change', function() { /* ... no changes ... */ });
    passengerTableBody.addEventListener('change', function(e) { /* ... no changes ... */ });
    btnSendCustomMessage.addEventListener('click', function() { /* ... no changes ... */ });
    confirmSendBtn.addEventListener('click', async function() { /* ... no changes ... */ });
    async function sendMessage(dataset, customText) { /* ... no changes ... */ }
    function populateYatraFilter(data) { /* ... no changes ... */ }
    function populateBusFilter(buses) { /* ... no changes ... */ }
    function resetFilters(filterNames) { /* ... no changes ... */ }
    function showLoader(show) { /* ... no changes ... */ }
    function showStatus(message, alertClass) { /* ... no changes ... */ }
    function hideMainContent() { /* ... no changes ... */ }

    // Full JS code for completeness
    $('#routeFilter').on('change', async function() {const routeId = this.value; resetFilters(['yatra', 'bus']); hideMainContent(); if (!routeId) return; try {const fd = new FormData(); fd.append('action', 'get_filters'); fd.append('route_id', routeId); const response = await fetch("{% url 'passenger_documents_api' %}", { method: 'POST', body: fd }); const result = await response.json(); if (result.status === 'success') {yatraDataCache = result.data; populateYatraFilter(yatraDataCache);} else {showStatus('Error fetching yatra dates: ' + result.message, 'alert-danger');}} catch (error) {showStatus('An unexpected error occurred.', 'alert-danger');}});
    $('#yatraFilter').on('change', function() {const yatraId = this.value; resetFilters(['bus']); hideMainContent(); if (yatraId && yatraDataCache[yatraId]) {populateBusFilter(yatraDataCache[yatraId].buses);}});
    $('#busFilter').on('change', function() {if (this.value) {fetchAndRenderPassengers();} else {hideMainContent();}});
    async function fetchAndRenderPassengers() {const routeId = $('#routeFilter').val(); const yatraId = $('#yatraFilter').val(); const busId = $('#busFilter').val(); if (!routeId || !yatraId || !busId) return; showLoader(true); hideMainContent(); try {const fd = new FormData(); fd.append('action', 'get_passengers'); fd.append('route_id', routeId); fd.append('yatra_id', yatraId); fd.append('bus_id', busId); const response = await fetch("{% url 'passenger_documents_api' %}", { method: 'POST', body: fd }); const result = await response.json(); if (result.status === 'success' && result.data.length > 0) {renderPassengerTable(result.data); mainContentContainer.classList.remove('d-none'); showStatus('', 'd-none');} else if (result.status === 'success') {showStatus('No passengers found for this selection.', 'alert-info');} else {showStatus('Error fetching passengers: ' + result.message, 'alert-danger');}} catch (error) {showStatus('An unexpected network error occurred.', 'alert-danger');} finally {showLoader(false);}}
    function renderPassengerTable(passengers) {passengerTableBody.innerHTML = ''; const validRecipients = passengers.filter(pax => pax.MobileNo && pax.MobileNo.length >= 10); if (validRecipients.length === 0) {passengerTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No valid recipients found.</td></tr>`;} validRecipients.forEach((pax) => {const fullName = [pax.Firstname, pax.Middlename, pax.Lastname].filter(Boolean).join(' '); const row = `<tr data-reg-id="${pax.RegistrationId}" data-name="${fullName}" data-mobile="${pax.MobileNo}" data-yatra-name="${$('#routeFilter option:selected').text()}" data-yatra-date="${$('#yatraFilter option:selected').text()}" data-bus-no="${$('#busFilter option:selected').text()}" data-seat-no="${pax.SeatNo}"><td><input class="form-check-input row-checkbox" type="checkbox"></td><td>${fullName}</td><td>${pax.MobileNo}</td></tr>`; passengerTableBody.insertAdjacentHTML('beforeend', row);}); updateSelectedCount(); selectAllCheckbox.checked = false;}
    function updateSelectedCount() {const selectedCount = passengerTableBody.querySelectorAll('.row-checkbox:checked').length; recipientCountSpan.textContent = selectedCount;}
    selectAllCheckbox.addEventListener('change', function() {const checkboxes = passengerTableBody.querySelectorAll('.row-checkbox'); checkboxes.forEach(checkbox => {checkbox.checked = this.checked;}); updateSelectedCount();});
    passengerTableBody.addEventListener('change', function(e) {if (e.target.classList.contains('row-checkbox')) {updateSelectedCount(); const totalCheckboxes = passengerTableBody.querySelectorAll('.row-checkbox').length; const checkedCheckboxes = passengerTableBody.querySelectorAll('.row-checkbox:checked').length; selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;}});
    btnSendCustomMessage.addEventListener('click', function() {const message = customMessageBody.value.trim(); if (!message) {swal("Wait!", "Please type a message before sending.", "warning"); customMessageBody.focus(); return;} const selectedRows = passengerTableBody.querySelectorAll('.row-checkbox:checked'); if (selectedRows.length > 0) {modalBodyContent.innerHTML = `<p>You are about to send a custom message to <strong>${selectedRows.length}</strong> selected recipients.</p><p>Do you want to proceed?</p>`; confirmBulkSendModal.show();} else {swal("No Recipients Selected", "Please select at least one recipient by checking the box next to their name.", "info");}});
    confirmSendBtn.addEventListener('click', async function() {confirmBulkSendModal.hide(); const customText = customMessageBody.value.trim(); const selectedRecipientRows = Array.from(passengerTableBody.querySelectorAll('.row-checkbox:checked')).map(cb => cb.closest('tr')); let successCount = 0; let failCount = 0; const originalButtonText = btnSendCustomMessage.innerHTML; btnSendCustomMessage.disabled = true; btnSendCustomMessage.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Sending...`; for (const row of selectedRecipientRows) {const success = await sendMessage(row.dataset, customText); if (success) successCount++; else failCount++; await new Promise(resolve => setTimeout(resolve, 200));} btnSendCustomMessage.disabled = false; btnSendCustomMessage.innerHTML = originalButtonText; swal({title: "Bulk Send Complete!", text: `Messages sent to ${selectedRecipientRows.length} recipients.\n\nSuccessful: ${successCount}\nFailed: ${failCount}`, type: "success"}, function(isConfirm){ if(isConfirm){ document.querySelectorAll('.row-checkbox:checked').forEach(c => c.checked=false); selectAllCheckbox.checked=false; updateSelectedCount();}});});
    async function sendMessage(dataset, customText) {try {const fd = new FormData(); fd.append('registration_id', dataset.regId); fd.append('user_name', dataset.name); fd.append('mobile_no', dataset.mobile); fd.append('yatra_name', dataset.yatraName); fd.append('yatra_date', dataset.yatraDate); fd.append('bus_no', dataset.busNo); fd.append('seat_no', dataset.seatNo); fd.append('custom_message_body', customText); const response = await fetch("{% url 'send_whatsapp_api' %}", { method: 'POST', body: fd }); const result = await response.json(); return result.status === 'success';} catch (error) {console.error(`Error sending message to ${dataset.name}:`, error); return false;}}
    function populateYatraFilter(data) {const yatraSelect = $('#yatraFilter'); yatraSelect.empty().append('<option value="">-- Choose a Yatra Date --</option>'); for (const yatraId in data) {yatraSelect.append(new Option(data[yatraId].date, yatraId, false, false));} yatraSelect.prop('disabled', false).trigger('change');}
    function populateBusFilter(buses) {const busSelect = $('#busFilter'); busSelect.empty().append('<option value="">-- Choose a Bus --</option>'); buses.forEach(bus => {busSelect.append(new Option(bus.name, bus.id, false, false));}); busSelect.prop('disabled', false).trigger('change');}
    function resetFilters(filterNames) {if (filterNames.includes('yatra')) {$('#yatraFilter').empty().append('<option value="">-- Select Route First --</option>').prop('disabled', true).trigger('change');} if (filterNames.includes('bus')) {$('#busFilter').empty().append('<option value="">-- Select Yatra First --</option>').prop('disabled', true).trigger('change');}}
    function showLoader(show) {loader.classList.toggle('d-none', !show); if (show) statusMessage.classList.add('d-none');}
    function showStatus(message, alertClass) {statusMessage.textContent = message; statusMessage.className = `alert ${alertClass} text-center`;}
    function hideMainContent() {mainContentContainer.classList.add('d-none');}
});
</script>

</body>
</html>