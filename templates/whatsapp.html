{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk WhatsApp Messaging</title>

    <!-- Essential CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
    
    <!-- Libraries for Select2 Dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="manifest" href="{% static 'assets/__manifest.json' %}">

    <style>
        :root {
            --brand-orange: #ff7b00;
            --brand-orange-dark: #e67000;
            --brand-blue: #003399;
            --brand-green: #006633;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; }
        .navbar { background-color: var(--brand-orange); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .back-btn { font-size: 1.5rem; color: white; text-decoration: none; }
        .navbar-brand { font-weight: bold; }
        .container-main { max-width: 900px; margin: 70px auto; padding: 10px; padding-bottom: 100px; /* Space for sticky footer */ }
        
        .sticky-footer-send {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .btn-brand-send { background-color: var(--brand-orange); color: white; font-weight: bold; padding: 12px; font-size: 1.1rem; border: none; }
        .btn-brand-send:hover { background-color: var(--brand-orange-dark); color: white; }
        
        .passenger-item { display: flex; align-items: center; padding: 12px; }
        .avatar {
            width: 40px; height: 40px; border-radius: 50%; background-color: var(--brand-blue);
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 15px; flex-shrink: 0;
        }
        .passenger-details { flex-grow: 1; }
        .passenger-name { font-weight: 600; }
        .passenger-mobile { font-size: 0.9em; color: #6c757d; }
        .passenger-checkbox { transform: scale(1.4); margin-left: 15px; flex-shrink: 0; }
        
        .select2-container--bootstrap-5 .select2-dropdown { z-index: 1060; }
    </style>
</head>
<body>

<!-- Top Navigation Bar -->
<nav class="navbar fixed-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="{% url 'dashboard' %}" class="back-btn"><i class="bi bi-arrow-left-circle-fill"></i></a>
        <span class="navbar-brand mb-0 h1" style="color:white">WhatsApp Sender</span>
        <span style="width: 30px;"></span>
    </div>
</nav>

<!-- Main Page Content -->
<div class="container-main">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h4 class="mb-3" style="color: var(--brand-green);"><i class="bi bi-whatsapp"></i> Bulk WhatsApp Sender</h4>

            <!-- Step 1: Filters -->
            <div class="card-header bg-transparent fw-bold ps-0">Step 1: Select Recipients</div>
            <div class="p-3 border rounded mb-4">
                <div class="mb-3">
                    <label for="routeFilter" class="form-label text-muted">Route</label>
                    <select id="routeFilter" class="form-select form-select-lg">
                        <option value="">-- Choose a Route --</option>
                        {% for route in routes %}<option value="{{ route.YatraRouteId }}">{{ route.YatraRouteName }}</option>{% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="yatraFilter" class="form-label text-muted">Yatra (Date)</label>
                    <select id="yatraFilter" class="form-select form-select-lg" disabled><option value="">-- Select Route First --</option></select>
                </div>
                <div>
                    <label for="busFilter" class="form-label text-muted">Bus</label>
                    <select id="busFilter" class="form-select form-select-lg" disabled><option value="">-- Select Yatra First --</option></select>
                </div>
            </div>

            <!-- Message Composer and Recipient List Container -->
            <div id="mainContentContainer" class="d-none">
                <!-- Step 2: Message Composer -->
                <div class="card-header bg-transparent fw-bold ps-0">Step 2: Compose Your Message</div>
                <div class="p-3 border rounded mb-4">
                    <div class="mb-3"><label for="templateSelector" class="form-label text-muted">Select a Template (Optional)</label><select id="templateSelector" class="form-select form-select-lg"><option value="">-- Write a Custom Message --</option></select></div>
                    <div><label for="customMessageBody" class="form-label text-muted">Message Body</label><textarea id="customMessageBody" class="form-control" rows="5" placeholder="Type a message or select a template..."></textarea></div>
                    <small class="form-text text-muted">Placeholders like <code>{{NAME}}</code> will be replaced.</small>
                </div>

                <!-- Step 3: Recipient List -->
                <div class="card shadow-sm">
                    <div class="card-header fw-bold bg-light d-flex justify-content-between align-items-center">
                        <span>Recipients (Selected: <span id="recipientCount">0</span>)</span>
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label" for="selectAllCheckbox">Select All</label></div>
                    </div>
                    <div id="passengerTableBody" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- STICKY FOOTER FOR THE SEND BUTTON -->
                <div class="sticky-footer-send">
                    <button id="btnSendCustomMessage" class="btn btn-brand-send w-100"><i class="bi bi-send-fill me-2"></i>Send to Selected</button>
                </div>
            </div>
            
            <div id="loader" class="text-center my-4 d-none"><div class="spinner-border" style="color: var(--brand-orange);"></div><p class="mt-2">Fetching...</p></div>
            <div id="statusMessage" class="alert text-center d-none"></div>
             <div id="initialPrompt" class="text-center text-muted p-4"><i class="bi bi-filter-circle fs-1"></i><p class="mt-2">Please select a Route, Yatra, and Bus to load recipients.</p></div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmBulkSendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirm Bulk Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div id="modalBodyContent" class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" id="confirmSendBtn" class="btn btn-success">Yes, Send Message</button></div></div></div>
</div>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Page-Specific JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const mainContentContainer = document.getElementById('mainContentContainer');
    const passengerTableBody = document.getElementById('passengerTableBody');
    const loader = document.getElementById('loader');
    const statusMessage = document.getElementById('statusMessage');
    const initialPrompt = document.getElementById('initialPrompt');
    const customMessageBody = document.getElementById('customMessageBody');
    const btnSendCustomMessage = document.getElementById('btnSendCustomMessage');
    const recipientCountSpan = document.getElementById('recipientCount');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const confirmBulkSendModal = new bootstrap.Modal(document.getElementById('confirmBulkSendModal'));
    const confirmSendBtn = document.getElementById('confirmSendBtn');
    const modalBodyContent = document.getElementById('modalBodyContent');
    const templateSelector = document.getElementById('templateSelector');
    let yatraDataCache = {};
    let messageTemplates = [];

    $('#routeFilter, #yatraFilter, #busFilter, #templateSelector').select2({ theme: "bootstrap-5", containerCssClass: "form-select-lg", dropdownCssClass: "form-select-lg" });

    async function loadMessageTemplates() { try { const response = await fetch("{% url 'get_whatsapp_templates_api' %}"); const result = await response.json(); if (result.message_code === 1000 && Array.isArray(result.message_data)) { messageTemplates = result.message_data; const templateSelect = $('#templateSelector'); templateSelect.find('option:not(:first)').remove(); messageTemplates.forEach(template => { templateSelect.append(new Option(template.TemplateTitle, template.TemplateId, false, false)); }); templateSelect.trigger('change'); } } catch (error) { console.error("Failed to load message templates:", error); } }
    loadMessageTemplates();

    $('#templateSelector').on('change', function() { const selectedTemplateId = this.value; if (selectedTemplateId) { const selectedTemplate = messageTemplates.find(t => t.TemplateId == selectedTemplateId); if (selectedTemplate) { customMessageBody.value = selectedTemplate.TemplateMessageBody; } } else { customMessageBody.value = ''; } });
    $('#routeFilter').on('change', async function() {const routeId = this.value; resetFilters(['yatra', 'bus']); hideMainContent(); if (!routeId) return; try {const fd = new FormData(); fd.append('action', 'get_filters'); fd.append('route_id', routeId); const response = await fetch("{% url 'passenger_documents_api' %}", { method: 'POST', body: fd }); const result = await response.json(); if (result.status === 'success') {yatraDataCache = result.data; populateYatraFilter(yatraDataCache);} else {showStatus('Error fetching yatra dates: ' + result.message);}} catch (error) {showStatus('An unexpected error occurred.');}});
    $('#yatraFilter').on('change', function() {const yatraId = this.value; resetFilters(['bus']); hideMainContent(); if (yatraId && yatraDataCache[yatraId]) {populateBusFilter(yatraDataCache[yatraId].buses);}});
    $('#busFilter').on('change', function() {if (this.value) {fetchAndRenderPassengers();} else {hideMainContent();}});
    
    async function fetchAndRenderPassengers() {
        const routeId = $('#routeFilter').val();
        const yatraId = $('#yatraFilter').val();
        const selectedBusId = $('#busFilter').val();
        if (!routeId || !yatraId || !selectedBusId) return;

        showLoader(true);
        hideMainContent();
        initialPrompt.classList.add('d-none');
        
        try {
            let combinedPassengers = [];
            if (selectedBusId === 'all') {
                const busesForYatra = yatraDataCache[yatraId]?.buses || [];
                const fetchPromises = busesForYatra.map(bus => fetchSingleBus(routeId, yatraId, bus.id));
                const results = await Promise.all(fetchPromises);
                results.forEach(passengerList => {
                    if (passengerList) {
                        combinedPassengers.push(...passengerList);
                    }
                });
            } else {
                const singleBusPassengers = await fetchSingleBus(routeId, yatraId, selectedBusId);
                if (singleBusPassengers) {
                    combinedPassengers = singleBusPassengers;
                }
            }
            
            renderPassengerList(combinedPassengers);
            mainContentContainer.classList.remove('d-none');
            showStatus('', true);

        } catch (error) {
            console.error("Error in fetchAndRenderPassengers:", error);
            showStatus('An unexpected error occurred while fetching passengers.');
        } finally {
            showLoader(false);
        }
    }

    async function fetchSingleBus(routeId, yatraId, busId) {
        try {
            const fd = new FormData(); fd.append('action', 'get_passengers'); fd.append('route_id', routeId); fd.append('yatra_id', yatraId); fd.append('bus_id', busId);
            const response = await fetch("{% url 'passenger_documents_api' %}", { method: 'POST', body: fd });
            if (!response.ok) { throw new Error(`HTTP error for bus ${busId}: ${response.status}`); }
            const result = await response.json();
            if (result.status === 'success') { return result.data; } 
            else { console.error(`API error for bus ${busId}:`, result.message); return null; }
        } catch (error) {
            console.error(`Network error for bus ${busId}:`, error);
            return null;
        }
    }

    function populateBusFilter(buses) {
        const busSelect = $('#busFilter');
        busSelect.empty().append('<option value="">-- Choose a Bus --</option>');
        buses.forEach(bus => { busSelect.append(new Option(bus.name, bus.id, false, false)); });
        if (buses.length > 1) { busSelect.append(new Option("All Buses", "all", false, false)); }
        busSelect.prop('disabled', false).trigger('change');
    }
    
    function renderPassengerList(passengers) {
        passengerTableBody.innerHTML = '';
        const validRecipients = passengers.filter(pax => pax.MobileNo && pax.MobileNo.length >= 10);
        if (validRecipients.length === 0) { passengerTableBody.innerHTML = `<div class="list-group-item text-center text-muted">No valid recipients found.</div>`; }
        validRecipients.forEach((pax) => {
            const fullName = [pax.Firstname, pax.Middlename, pax.Lastname].filter(Boolean).join(' ');
            const initials = (fullName.split(' ').map(n => n[0]).join('')).substring(0, 2).toUpperCase();
            const row = `
                <div class="list-group-item passenger-item"
                    data-reg-id="${pax.RegistrationId}" data-name="${fullName}" data-mobile="${pax.MobileNo}"
                    data-yatra-name="${$('#routeFilter option:selected').text()}" data-yatra-date="${$('#yatraFilter option:selected').text()}"
                    data-bus-no="${pax.BusName || 'N/A'}" data-seat-no="${pax.SeatNo}">
                    <div class="avatar">${initials}</div>
                    <div class="passenger-details">
                        <div class="passenger-name">${fullName}</div>
                        <div class="passenger-mobile">${pax.MobileNo}</div>
                    </div>
                    <input class="form-check-input passenger-checkbox row-checkbox" type="checkbox">
                </div>`;
            passengerTableBody.insertAdjacentHTML('beforeend', row);
        });
        updateSelectedCount();
        selectAllCheckbox.checked = false;
    }

    function updateSelectedCount() {const selectedCount = passengerTableBody.querySelectorAll('.row-checkbox:checked').length; recipientCountSpan.textContent = selectedCount;}
    selectAllCheckbox.addEventListener('change', function() {const checkboxes = passengerTableBody.querySelectorAll('.row-checkbox'); checkboxes.forEach(checkbox => {checkbox.checked = this.checked;}); updateSelectedCount();});
    passengerTableBody.addEventListener('change', function(e) {if (e.target.classList.contains('row-checkbox')) {updateSelectedCount(); const totalCheckboxes = passengerTableBody.querySelectorAll('.row-checkbox').length; const checkedCheckboxes = passengerTableBody.querySelectorAll('.row-checkbox:checked').length; selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;}});
    btnSendCustomMessage.addEventListener('click', function() {const message = customMessageBody.value.trim(); if (!message) {swal("Wait!", "Please type a message before sending.", "warning"); customMessageBody.focus(); return;} const selectedRows = passengerTableBody.querySelectorAll('.row-checkbox:checked'); if (selectedRows.length > 0) {modalBodyContent.innerHTML = `<p>You are about to send a custom message to <strong>${selectedRows.length}</strong> selected recipients.</p><p>Do you want to proceed?</p>`; confirmBulkSendModal.show();} else {swal("No Recipients Selected", "Please select at least one recipient.", "info");}});
    confirmSendBtn.addEventListener('click', async function() { confirmBulkSendModal.hide(); const customText = customMessageBody.value.trim(); const selectedRecipientRows = Array.from(passengerTableBody.querySelectorAll('.row-checkbox:checked')).map(cb => cb.closest('.passenger-item')); let successCount = 0; let failCount = 0; const originalButtonText = btnSendCustomMessage.innerHTML; btnSendCustomMessage.disabled = true; btnSendCustomMessage.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Sending...`; for (const row of selectedRecipientRows) {const success = await sendMessage(row.dataset, customText); if (success) successCount++; else failCount++; await new Promise(resolve => setTimeout(resolve, 200));} btnSendCustomMessage.disabled = false; btnSendCustomMessage.innerHTML = originalButtonText; swal({title: "Bulk Send Complete!", text: `Messages sent to ${selectedRecipientRows.length} recipients.\n\nSuccessful: ${successCount}\nFailed: ${failCount}`, type: "success"}, function(isConfirm){ if(isConfirm){ document.querySelectorAll('.row-checkbox:checked').forEach(c => c.checked=false); selectAllCheckbox.checked=false; updateSelectedCount();}});});
    async function sendMessage(dataset, customText) {try {const fd = new FormData(); fd.append('registration_id', dataset.regId); fd.append('user_name', dataset.name); fd.append('mobile_no', dataset.mobile); fd.append('yatra_name', dataset.yatraName); fd.append('yatra_date', dataset.yatraDate); fd.append('bus_no', dataset.busNo); fd.append('seat_no', dataset.seatNo); fd.append('custom_message_body', customText); const response = await fetch("{% url 'send_whatsapp_api' %}", { method: 'POST', body: fd }); const result = await response.json(); return result.status === 'success';} catch (error) {console.error(`Error sending message to ${dataset.name}:`, error); return false;}}
    function populateYatraFilter(data) {const yatraSelect = $('#yatraFilter'); yatraSelect.empty().append('<option value="">-- Choose a Yatra Date --</option>'); for (const yatraId in data) {yatraSelect.append(new Option(data[yatraId].date, yatraId, false, false));} yatraSelect.prop('disabled', false).trigger('change');}
    function resetFilters(filterNames) {if (filterNames.includes('yatra')) {$('#yatraFilter').empty().append('<option value="">-- Select Route First --</option>').prop('disabled', true).trigger('change');} if (filterNames.includes('bus')) {$('#busFilter').empty().append('<option value="">-- Select Yatra First --</option>').prop('disabled', true).trigger('change');}}
    function showLoader(show) {loader.classList.toggle('d-none', !show); if (show) statusMessage.classList.add('d-none');}
    function showStatus(message, hide = false) {statusMessage.textContent = message; statusMessage.className = `alert ${hide ? 'd-none' : 'alert-danger'} text-center`;}
    function hideMainContent() {mainContentContainer.classList.add('d-none'); initialPrompt.classList.remove('d-none');}
});
</script>

</body>
</html>