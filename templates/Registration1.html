{% load i18n %}
{% load static %}
{% load pwa %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Yatra Darshan Booking</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --brand-orange: #ff7b00;
            --brand-orange-dark: #e67000;
            --brand-blue: #003399;
            --brand-green: #006633;
        }

        body {
            background: #f0f2f5;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: var(--brand-orange);
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .navbar-brand {
            color: #fff;
            font-weight: 600;
            font-size: 20px;
        }

        .container-main {
            max-width: 980px;
            margin: 75px auto 40px;
            padding: 0 12px;
        }

        .card-main {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
            overflow: hidden;
            background-color: #fff;
        }

        .search-bar-top {
            padding: 18px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-grow {
            flex: 1;
            position: relative;
        }

        .search-grow input {
            width: 100%;
            height: 40px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 0 45px 0 10px;
            font-size: 1rem;
        }

        .search-icon-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 6px;
            border: none;
            background: var(--brand-orange);
            color: #fff;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .search-icon-btn:hover {
            background: var(--brand-orange-dark);
        }

        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .nav-tabs .nav-link.active {
            color: var(--brand-orange);
            border-color: var(--brand-orange);
            background-color: #fff;
        }

        .tab-content {
            padding: 20px;
            background-color: #fff;
        }

        .registration-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .registration-list-header h5 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .listview .list-group-item {
            border: 0;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .listview .list-group-item:hover {
            background: #fbfbff;
        }

        .item-line {
            font-size: 14px;
        }

        .btn-add-reg {
            background: var(--brand-green);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .btn-add-reg:hover {
            background: #005a2e;
        }

        .section-header {
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
        }

        .floating {
            position: relative;
            margin-bottom: 16px;
        }

        .floating input,
        .floating select,
        .floating textarea,
        .floating .form-control { /* Target our new div */
            width: 100%;
            padding: 12px 10px 10px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: #fff;
            outline: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .floating input:focus,
        .floating select:focus,
        .floating textarea:focus,
        .floating .form-control:focus {
            border-color: var(--brand-orange);
            box-shadow: 0 0 0 0.25rem rgba(255, 123, 0, 0.25);
        }

        .floating label {
            position: absolute;
            left: 10px;
            top: 12px;
            font-size: 14px;
            color: #6c757d;
            pointer-events: none;
            transition: all 0.2s ease;
            background: #fff;
            padding: 0 4px;
            margin-left: -4px;
        }

        .floating input:focus + label,
        .floating input:not(:placeholder-shown) + label,
        .floating select:focus + label,
        .floating select:not([value=""]) + label,
        .floating textarea:focus + label,
        .floating textarea:not(:placeholder-shown) + label,
        .floating .form-control:not(:empty) + label {
            top: -8px;
            font-size: 11px;
            color: var(--brand-orange);
        }
        
        .compact-booking-layout .floating, .compact-booking-layout .floating select {
            height: 100%;
        }
        .compact-booking-layout .form-text {
            position: absolute;
            bottom: -15px;
            left: 0;
            font-size: 0.75rem;
        }


        .btn-submit {
            background: var(--brand-orange);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-submit:hover {
            background: var(--brand-orange-dark);
        }

        .offcanvas-end {
            width: 400px !important;
            max-width: 90vw;
        }

        .offcanvas-header {
            background: var(--brand-orange);
            color: #fff;
            padding: 15px 20px;
        }

        .offcanvas-title {
            color: #fff;
            font-size: 18px;
        }

        .offcanvas-body {
            padding: 20px;
            overflow-y: auto;
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }

        .yatra-summary {
            font-size: 0.9rem;
            color: #555;
        }
        .yatra-summary strong {
            color: #333;
        }

        .form-control-file {
            padding-top: 10px;
            padding-bottom: 10px;
            font-size: 14px;
        }
        .next-tab-button {
          margin-top: 20px;
          text-align: right;
        }
        .next-tab-button .btn {
          background-color: var(--brand-blue);
          border-color: var(--brand-blue);
        }
        .next-tab-button .btn:hover {
          background-color: #002b80;
          border-color: #002b80;
        }

        .history-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-file-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }

        .compact-form .row {
            margin-bottom: 0;
        }

        .compact-form .floating {
            margin-bottom: 12px;
        }

        .compact-form textarea {
            min-height: 60px;
        }
        
        .compact-booking-layout {
            margin-bottom: 16px;
        }

        .compact-booking-layout .floating {
            margin-bottom: 12px;
            height: auto;
        }

        .passenger-checkbox-list-container {
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 8px 10px;
            min-height: 160px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            position: relative;
        }

        .passenger-checkbox-list-container label {
            font-size: 14px;
            color: #6c757d;
            position: absolute;
            left: 10px;
            top: -8px;
            background: #fff;
            padding: 0 4px;
            margin-left: -4px;
            font-size: 11px;
            color: var(--brand-orange);
            z-index: 1;
        }

        .passenger-checkbox-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .passenger-checkbox-item input[type="checkbox"] {
            min-width: 16px;
            min-height: 16px;
        }

        .passenger-checkbox-item label {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: #333;
            position: unset;
            background: unset;
            padding: unset;
            margin-left: unset;
            z-index: unset;
        }

        .selected-passenger-ids {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--brand-blue);
            min-height: 20px;
        }

        .compact-booking-layout .right-stacked-fields {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .compact-booking-layout .right-stacked-fields .floating {
            margin-bottom: 10px;
            flex: 1;
        }

        .compact-booking-layout .right-stacked-fields .floating:last-child {
            margin-bottom: 12px;
        }

        .compact-booking-layout .right-stacked-fields select {
            height: 48px;
        }

        .compact-booking-layout .form-text {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #6c757d;
        }

        /* ----- NEW CSS FOR SEAT MAP ----- */
        .seat-map {
            display: grid;
            /* This makes the middle (aisle) column narrower than the seat columns */
            grid-template-columns: 1fr 1fr 0.5fr 1fr 1fr;
            gap: 8px;
            width: 100%;
            max-width: 320px; /* Slightly increased width for better spacing */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .seat {
            height: 35px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid;
            user-select: none; /* Prevents text selection on click */
        }

        .seat.aisle {
            background: transparent;
            border: none;
            cursor: default;
        }

        /* --- Seat Statuses --- */
        .seat.available {
            background-color: #fff;
            border-color: #28a745; /* Green border */
            color: #28a745;
        }
        .seat.available:hover {
            background-color: #e9f7ef;
        }

        /* Reserved for Swayamsevak (Grey) */
        .seat.reserved {
            background-color: #808080;
            border-color: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        /* Booked by other pilgrims (Faint Black / Light Grey) */
        .seat.booked {
            background-color: #e9ecef; /* Faint black */
            border-color: #ced4da;
            color: #6c757d;
            cursor: not-allowed;
        }

        /* Seat selected by the current user (Solid Green) */
        .seat.selected {
            background-color: #28a745;
            border-color: #218838;
            color: white;
        }

        /* --- Legend Styling --- */
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        .legend-box {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        /* ----- END OF NEW CSS ----- */


        @media (max-width: 767px) {
            .passenger-checkbox-list-container {
                min-height: 130px;
                max-height: 150px;
            }
            
            .compact-booking-layout .right-stacked-fields .floating {
                margin-bottom: 8px;
            }
            
            .compact-booking-layout .right-stacked-fields select {
                height: 40px;
            }
            
            .compact-booking-layout .form-text {
                font-size: 0.65rem;
            }
        }

        /* ----- NEW CSS FOR COMPACT TICKETS ----- */
        .compact-ticket-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px !important;
        }
        .compact-ticket-details {
            flex-grow: 1;
            margin-right: 10px;
        }
        .compact-ticket-details strong {
            display: block; /* Puts name on its own line */
            font-size: 15px;
            color: #333;
        }
        .compact-ticket-details .details-line {
            font-size: 12px;
            color: #555;
        }
        .btn-remove-compact {
            padding: 5px 10px;
            font-size: 12px;
        }
        /* ----- END OF NEW CSS ----- */


        /* ----- NEW CSS FOR GROUPED TICKETS ----- */
        .ticket-group-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 12px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .ticket-group-header {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ticket-group-header-info strong {
            display: block;
            font-size: 14px;
        }
        .ticket-group-header-info span {
            font-size: 12px;
            color: #6c757d;
        }
        .ticket-group-passengers li {
            font-size: 14px;
            padding: 8px 0; /* A bit more vertical padding */
            border-bottom: 1px solid #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center; /* Vertically align items */
        }

        /* NEW: Styles for the small, individual remove button */
        .btn-remove-passenger {
            padding: 2px 7px;
            line-height: 1.2;
            font-size: 14px;
        }
        
        /* NEW: Container for passenger name and seat info */
        .passenger-details {
            display: flex;
            flex-direction: column;
        }
        .passenger-details .seat-info {
             font-size: 12px;
             color: #6c757d;
        }
        /* ----- END OF NEW CSS ----- */

        /* ----- NEW CSS FOR COMPACT TICKET SUMMARY ----- */
        .ticket-summary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px !important; /* !important to override default list-group padding */
        }
        .ticket-summary-info {
            flex-grow: 1;
        }
        .ticket-summary-info strong {
            font-size: 15px;
            color: #333;
        }
        .ticket-summary-info .details-line {
            font-size: 12px;
            color: #6c757d;
        }
        .ticket-summary-actions .btn {
            margin-left: 5px;
        }
        /* ----- END OF NEW CSS ----- */

        .back-btn i {
        color: white;
        font-size: 28px;
        }
        .back-btn i:hover {
        color: #ddd; /* Optional hover effect */
        }

    </style>
</head>
<body>
    <!-- Topbar -->
    <!-- <nav class="navbar fixed-top">
        <span class="navbar-brand">Yatra Darshan Booking</span>
    </nav> -->
    <nav class="navbar fixed-top">
        <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="{% url 'dashboard' %}" class="back-btn">
            <i class="bi bi-arrow-left-circle"></i>
        </a>
        <span class="navbar-brand mb-0 h1" style="color:white">Yatra Darshan Booking</span>
        <span style="width: 30px;"></span>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container-main">
        <div class="card-main">
            <!-- Search Bar at the very top -->
            <div class="search-bar-top">
                <div class="search-grow">
                    <input id="searchMobile" type="tel" maxlength="10" placeholder="Mobile Number" autocomplete="off" />
                    <button id="btnSearch" class="search-icon-btn" title="Search">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration" type="button" role="tab" aria-controls="registration" aria-selected="true">Registration</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking" type="button" role="tab" aria-controls="booking" aria-selected="false">Booking</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="myTabContent">
                <!-- Registration Tab -->
                <div class="tab-pane fade show active" id="registration" role="tabpanel" aria-labelledby="registration-tab">
                    <div id="statusMsg" class="alert d-none"></div>

                    <div class="registration-list-header">
                        <h5>Registrations for <strong id="labelMobile"></strong></h5>
                        <button id="btnAddNew" class="btn-add-reg" title="Add new registration">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="regList" class="listview">
                        <ul id="regItems" class="list-group list-group-flush">
                            <li class="list-group-item text-center text-muted py-4">Search a mobile number to see registrations.</li>
                        </ul>
                    </div>
                    <div class="next-tab-button">
                        <button id="btnRegNext" class="btn btn-primary">Next <i class="bi bi-arrow-right"></i></button>
                    </div>

                    <div class="section-header">Booking History</div>
                    <div class="history-filters">
                        <div class="floating">
                            <select id="historyPassenger" placeholder=" ">
                                <option value="">Select Passenger</option>
                            </select>
                            <label>Passenger</label>
                        </div>
                        <div class="floating">
                            <select id="historyYear" placeholder=" ">
                                <option value="">Select Year</option>
                            </select>
                            <label>Year</label>
                        </div>
                    </div>
                    <div id="bookingHistoryList" class="list-group">
                         <li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>
                    </div>
                </div>

                <!-- Booking Tab -->
                <div class="tab-pane fade" id="booking" role="tabpanel" aria-labelledby="booking-tab">
                    <div class="section-header">Select Passengers & Yatra Details</div>

                        <div class="row g-2 compact-booking-layout">
                            <div class="col-6">
                                <div class="passenger-checkbox-list-container">
                                    <label>Select Passengers*</label>
                                    <div id="passengerCheckboxes">
                                    </div>
                                    <input type="hidden" id="selectedPassengerIdsInput" name="selectedPassengerIds">
                                </div>
                                <div id="selectedPassengerIds" class="selected-passenger-ids">
                                </div>
                            </div>
                            
                            <div class="col-6 right-stacked-fields">
                                <div class="floating">
                                    <select id="selectRoute" placeholder=" " required>
                                        <option value="">Select Route*</option>
                                    </select>
                                    <label>Route</label>
                                </div>
                                <div class="floating">
                                    <select id="selectYatra" placeholder=" " required>
                                        <option value="">Select Yatra*</option>
                                    </select>
                                    <label>Yatra</label>
                                </div>
                                <div class="floating">
                                    <select id="selectBus" placeholder=" " required>
                                        <option value="">Select Bus*</option>
                                    </select>
                                    <label>Bus</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ***** MODIFIED SEAT SELECTION AREA ***** -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <!-- This div will trigger the modal and display the selected seats -->
                                <div class="floating">
                                    <div id="selectSeatsDisplay" class="form-control" style="cursor: pointer; padding-top: 12px; padding-bottom: 12px; height: auto; min-height: 48px;">
                                        <span class="text-muted">Select a bus to see seats</span>
                                    </div>
                                    <label>Select Seats*</label>
                                    <!-- Hidden input to store the comma-separated seat numbers -->
                                    <input type="hidden" id="selectedSeatsInput" name="selectedSeats">
                                </div>
                            </div>
                        </div>
                        <!-- ***** END OF MODIFICATION ***** -->

                        <div class="d-flex justify-content-end mt-3">
                            <button id="btnAddTicket" class="btn btn-success"><i class="bi bi-plus-circle me-1"></i> Add Ticket</button>
                        </div>

                    <div class="section-header mt-2">Added Tickets</div>
                    <div id="addedTicketsList" class="list-group mb-3">
                         <li class="list-group-item text-center text-muted py-4">No tickets added yet.</li>
                    </div>

                    <div class="section-header mt-2">Payment Details</div>
                    <div class="floating">
                        <input id="totalFees" type="number" placeholder=" " min="0" readonly>
                        <label>Total Fees (₹)</label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="floating">
                                <input id="discount" type="number" placeholder=" " min="0" value="0">
                                <label>Discount (₹)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="floating">
                                <input id="discountReason" type="text" placeholder=" ">
                                <label>Discount Reason</label>
                            </div>
                        </div>
                    </div>
                    <div class="floating">
                        <select id="paymentMode" placeholder=" " required>
                            <option value="">Select Payment Mode*</option>
                            <option value="cash">Cash</option>
                            <option value="upi">UPI</option>
                        </select>
                        <label>Payment Mode</label>
                    </div>

                    <div id="upiFields" class="d-none">
                        <div class="floating">
                            <input id="transactionId" type="text" placeholder=" ">
                            <label>UPI Transaction ID</label>
                        </div>
                        <div class="mb-3">
                            <label for="upiScreenshot" class="form-label">Upload UPI Screenshot*</label>
                            <input id="upiScreenshot" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        </div>
                    </div>

                    <div class="mt-4 d-grid">
                        <button id="submitBooking" type="button" class="btn-submit">
                            <i class="bi bi-check2-circle me-1"></i> Submit Booking
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration/Update Side Panel (Offcanvas) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="regActionBar" aria-labelledby="regActionBarLabel">
        <div class="offcanvas-header">
            <h5 id="regActionBarLabel" class="offcanvas-title">Pilgrim Registration</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form id="regForm" class="compact-form" autocomplete="off">
                {% csrf_token %} 
                <input id="RegistrationId" type="hidden" value="0">

                <div class="row g-2">
                    <div class="col-6">
                        <div class="floating">
                            <input id="MobileNo" type="tel" placeholder=" " maxlength="10" required>
                            <label>Mobile No. *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="AlternateMobileNo" type="tel" placeholder=" " maxlength="10">
                            <label>Alternate Mobile</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="Firstname" type="text" placeholder=" " required>
                            <label>First Name *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="Middlename" type="text" placeholder=" ">
                            <label>Middle Name</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="Lastname" type="text" placeholder=" " required>
                            <label>Last Name *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <select id="AreaId" placeholder=" " required><option value="">Select Area*</option></select>
                            <label>Area *</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="floating">
                            <textarea id="Address" placeholder=" " rows="2" required></textarea>
                            <label>Address *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <select id="Gender" placeholder=" "><option value="">Select Gender</option></select>
                            <label>Gender</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <select id="BloodGroup" placeholder=" "><option value="">Select Blood Group</option></select>
                            <label>Blood Group</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="DateOfBirth" type="date" placeholder=" ">
                            <label>Date of Birth</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="AadharNumber" type="text" placeholder=" " maxlength="12">
                            <label>Aadhar No.</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="AadharUpload" class="form-file-label">Aadhar Upload</label>
                        <input id="AadharUpload" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        <input type="hidden" id="IdProofFileName" value="">
                    </div>
                    <div class="col-12">
                        <label for="ProfilePicUpload" class="form-file-label">Profile Picture</label>
                        <input id="ProfilePicUpload" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        <input type="hidden" id="PhotoFileName" value="">
                    </div>
                    <div class="col-12">
                        <label for="VoterIdUpload" class="form-file-label">Voter ID Upload</label>
                        <input id="VoterIdUpload" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        <input type="hidden" id="VoterId" value="">
                    </div>
                </div>

                <div class="mt-3 d-grid">
                    <button id="btnSubmit" type="submit" class="btn-submit"><i class="bi bi-check2-circle me-1"></i> Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ***** NEW SEAT SELECTION MODAL ***** -->
    <div class="modal fade" id="seatSelectionModal" tabindex="-1" aria-labelledby="seatModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="seatModalLabel">Select Your Seats</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Legend for seat statuses -->
            <div id="seatLegend" class="d-flex justify-content-around mb-3"></div>
            <!-- Seat grid will be dynamically generated here -->
            <div id="seatMapContainer" class="d-flex justify-content-center">
                <div class="text-muted">Please select a bus first.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmSeatSelection">Confirm Selection</button>
          </div>
        </div>
      </div>
    </div>
    <!-- ***** END OF NEW MODAL ***** -->

    <!-- ***** TICKET DETAILS MODAL ***** -->
    <div class="modal fade" id="ticketDetailsModal" tabindex="-1" aria-labelledby="ticketDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ticketDetailsModalLabel">Ticket Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="ticketDetailsModalBody">
            <!-- Passenger details will be dynamically injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- ***** END OF MODAL ***** -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // No changes needed in this section
    const API_BASE_URL = "{% url 'registration_api1' %}";

    async function postForm(action, data = {}, isFormData = false) {
        const fd = new FormData();
        fd.append('action', action);
        if (isFormData) {
            for (let pair of data.entries()) {
                fd.append(pair[0], pair[1]);
            }
        } else {
            for (const k in data) {
                if (data[k] instanceof File) {
                    fd.append(k, data[k], data[k].name);
                } else {
                    fd.append(k, data[k]);
                }
            }
        }
        const url = API_BASE_URL;
        const response = await fetch(url, { method: 'POST', body: fd });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }

    function showMsg(type, text, title = null) {
        Swal.fire({
            icon: type,
            title: title || (type === 'success' ? 'Success!' : 'Error!'),
            html: text,
            confirmButtonColor: '#ff7b00',
        });
    }

    function validMobile(m) {
        return /^\d{10}$/.test(m);
    }
    
    function populatePassengerBookingDropdown(registrations) {
        const passengerCheckboxesContainer = document.getElementById('passengerCheckboxes');
        passengerCheckboxesContainer.innerHTML = '';
        document.getElementById('selectedPassengerIds').textContent = '';

        if (registrations && registrations.length > 0) {
            registrations.forEach(reg => {
                const fullName = [reg.Firstname, reg.Middlename, reg.Lastname].filter(Boolean).join(" ");
                const div = document.createElement('div');
                div.className = 'passenger-checkbox-item form-check';
                div.innerHTML = `
                    <label class="form-check-label" for="passenger_${reg.RegistrationId}">
                        ${fullName}
                    </label>
                    <input class="form-check-input" type="checkbox" value="${reg.RegistrationId}" id="passenger_${reg.RegistrationId}">
                `;
                passengerCheckboxesContainer.appendChild(div);
                div.querySelector('input[type="checkbox"]').addEventListener('change', updateSelectedPassengerDisplay);
            });
        } else {
            passengerCheckboxesContainer.innerHTML = '<div class="text-muted py-2">No passengers found for this number.</div>';
        }
        updateSelectedPassengerDisplay();
    }

    function updateSelectedPassengerDisplay() {
        const selectedIdsDisplay = document.getElementById('selectedPassengerIds');
        const selectedIdsInput = document.getElementById('selectedPassengerIdsInput');
        const checkboxes = document.querySelectorAll('#passengerCheckboxes input[type="checkbox"]:checked');
        
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        const selectedNames = Array.from(checkboxes).map(cb => {
            const fullName = cb.previousElementSibling.textContent.trim();
            return fullName.split(' ')[0];
        });

        if (selectedIds.length > 0) {
            selectedIdsDisplay.innerHTML = `Selected: <strong>${selectedNames.join(', ')}</strong><br>IDs: ${selectedIds.join(', ')}`;
        } else {
            selectedIdsDisplay.textContent = '';
        }
        selectedIdsInput.value = selectedIds.join(',');
    }

    // --- GLOBAL VARIABLES & ELEMENT REFERENCES ---
    const searchMobileInput = document.getElementById('searchMobile');
    const btnSearch = document.getElementById('btnSearch');
    const btnAddNew = document.getElementById('btnAddNew');
    const labelMobile = document.getElementById('labelMobile');
    const regItemsList = document.getElementById('regItems');
    const regActionBar = new bootstrap.Offcanvas(document.getElementById('regActionBar'));
    const regForm = document.getElementById('regForm');
    const btnRegNext = document.getElementById('btnRegNext');
    const historyYearSelect = document.getElementById('historyYear');
    const historyPassengerSelect = document.getElementById('historyPassenger');
    const bookingHistoryList = document.getElementById('bookingHistoryList');
    const selectRoute = document.getElementById('selectRoute');
    const selectYatra = document.getElementById('selectYatra');
    const selectBus = document.getElementById('selectBus');
    const btnAddTicket = document.getElementById('btnAddTicket');
    const addedTicketsList = document.getElementById('addedTicketsList');
    const totalFeesInput = document.getElementById('totalFees');
    const discountInput = document.getElementById('discount');
    const discountReasonInput = document.getElementById('discountReason');
    const paymentModeSelect = document.getElementById('paymentMode');
    const upiFieldsDiv = document.getElementById('upiFields');
    const submitBookingBtn = document.getElementById('submitBooking');
    const bookingTabButton = document.getElementById('booking-tab');
    const selectedPassengerIdsInput = document.getElementById('selectedPassengerIdsInput');

    // --- STATE MANAGEMENT VARIABLES ---
    let allRoutes = [];
    let allYatras = [];
    let allBuses = [];
    let currentRegistrations = [];
    let addedTickets = [];
    let hasBookingDataLoaded = false;
    let ticketDetailsModal; 
    
    // --- MODULE FOR REGISTRATION TAB LOGIC ---
    const RegistrationDisplay = (() => {
        let isExplicitSearch = false;

        async function doSearch(explicitSearchTriggered = true) {
            const mob = searchMobileInput.value.trim();
            if (!validMobile(mob)) {
                showMsg('error', 'Please enter a valid 10-digit mobile number.');
                labelMobile.textContent = '';
                regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Search a mobile number to see registrations.</li>';
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>';
                populatePassengerBookingDropdown([]);
                return;
            }
            sessionStorage.setItem('lastSearchMobile', mob);
            isExplicitSearch = explicitSearchTriggered;
            labelMobile.textContent = mob;
            regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-2">Loading registrations...</li>';

            try {
                const resp = await postForm('search_list', { search: mob });
                if (resp.message_code === 1000 && Array.isArray(resp.message_data)) {
                    currentRegistrations = resp.message_data;
                    renderRegistrationList(currentRegistrations, mob);
                    populatePassengerDropdown(currentRegistrations);
                    populatePassengerBookingDropdown(currentRegistrations);
                    if (isExplicitSearch) {
                        showMsg('success', `${currentRegistrations.length} registrations found.`);
                    }
                } else {
                    currentRegistrations = [];
                    renderRegistrationList([], mob);
                    populatePassengerDropdown([]);
                    populatePassengerBookingDropdown([]);
                    showMsg('info', resp.message_text || 'No records found for this number.');
                }
            } catch (err) {
                console.error("Search failed:", err);
                showMsg('error', 'Search failed. Please try again.');
            }
            await fetchBookingHistory();
        }

        function populatePassengerDropdown(registrations) {
            historyPassengerSelect.innerHTML = '<option value="">All Passengers</option>';
            registrations.forEach(r => {
                const fullName = [r.Firstname, r.Middlename, r.Lastname].filter(Boolean).join(" ");
                const option = new Option(fullName, r.RegistrationId);
                historyPassengerSelect.appendChild(option);
            });
        }

        function renderRegistrationList(registrations, mob) {
            regItemsList.innerHTML = '';
            if (!registrations.length) {
                regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-4">No registrations found for this number.</li>';
                return;
            }
            registrations.forEach(r => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                const fullName = [r.Firstname, r.Middlename, r.Lastname].filter(Boolean).join(" ");
                const area = r.AreaName || '-';
                li.innerHTML = `<div class="item-line"><strong>${fullName}</strong>, ${area}</div>`;
                li.addEventListener('click', () => RegistrationForm.openForm('update', r, mob));
                regItemsList.appendChild(li);
            });
        }

        function populateHistoryYears() {
            const currentYear = new Date().getFullYear();
            historyYearSelect.innerHTML = '<option value="">Select Year</option>';
            for (let i = currentYear; i >= currentYear - 5; i--) {
                const option = new Option(i, i);
                historyYearSelect.appendChild(option);
            }
            historyYearSelect.value = currentYear;
        }

        async function fetchBookingHistory() {
            const mob = searchMobileInput.value.trim();
            const year = historyYearSelect.value;
            const passengerId = historyPassengerSelect.value;

            if (!validMobile(mob) || !year) {
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>';
                return;
            }
            bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-2">Loading history...</li>';
            try {
                const resp = await postForm('get_booking_history', { mobile: mob, year: year, passengerId: passengerId });
                if (resp.message_code === 1000 && Array.isArray(resp.message_data) && resp.message_data.length > 0) {
                    renderBookingHistory(resp.message_data);
                } else {
                    bookingHistoryList.innerHTML = `<li class="list-group-item text-center text-muted py-4">${resp.message_text || 'No booking history found.'}</li>`;
                }
            } catch (err) {
                console.error("Failed to fetch booking history:", err);
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Error fetching history.</li>';
            }
        }

        function renderBookingHistory(history) {
            bookingHistoryList.innerHTML = '';
            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>Yatra:</strong> ${item.YatraName || 'N/A'}<br>
                        <strong>Date:</strong> ${item.YatraDate || 'N/A'}<br>
                        <strong>Seats:</strong>${item.Seats || 'N/A'}
                    </div>
                    <div>
                        <strong>Total:</strong>₹${item.AmountPaid || '0'}<br>
                        <span class="badge bg-secondary">${item.Status || 'Booked'}</span>
                    </div>`;
                bookingHistoryList.appendChild(li);
            });
        }

        return { doSearch, populateHistoryYears, fetchBookingHistory };
    })();

    // --- MODULE FOR REGISTRATION FORM (OFFCANVAS) ---
    const RegistrationForm = (() => {
        async function loadDropdowns() {
            const [areas, genders, bloodgroups] = await Promise.all([
                postForm('list_area'), postForm('list_gender'), postForm('list_bloodgroup')
            ]);
            function fillSelect(sel, res, vKey, tKey) {
                sel.innerHTML = '<option value="">Select</option>';
                if (res && res.message_code === 1000 && Array.isArray(res.message_data)) {
                    res.message_data.forEach(it => {
                        sel.appendChild(new Option(it[tKey], it[vKey]));
                    });
                }
            }
            fillSelect(document.getElementById('AreaId'), areas, 'AreaId', 'AreaName');
            fillSelect(document.getElementById('Gender'), genders, 'GenderId', 'GenderName');
            fillSelect(document.getElementById('BloodGroup'), bloodgroups, 'bloodGroupId', 'bloodGroupName');
        }

        async function openForm(mode, row = null, mobile = '') {
            regForm.reset();
            document.getElementById('RegistrationId').value = '0';
            document.getElementById('PhotoFileName').value = '';
            document.getElementById('IdProofFileName').value = '';
            document.getElementById('VoterId').value = '';
            document.getElementById('regActionBarLabel').textContent = mode === 'insert' ? 'Add New Registration' : 'Update Registration';
            
            if (mode === 'insert' && mobile) { document.getElementById('MobileNo').value = mobile; }
            
            await loadDropdowns();

            if (mode === 'update' && row) {
                // Populate fields, including the critical RegistrationId
                document.getElementById('RegistrationId').value = row.RegistrationId || '0';
                document.getElementById('MobileNo').value = row.MobileNo || mobile || '';
                document.getElementById('AlternateMobileNo').value = row.AlternateMobileNo || '';
                document.getElementById('Firstname').value = row.Firstname || '';
                document.getElementById('Middlename').value = row.Middlename || '';
                document.getElementById('Lastname').value = row.Lastname || '';
                document.getElementById('Address').value = row.Address || '';
                document.getElementById('AadharNumber').value = row.AadharNumber || '';
                document.getElementById('PhotoFileName').value = row.PhotoFileName || '';
                document.getElementById('IdProofFileName').value = row.IdProofFileName || '';
                document.getElementById('VoterId').value = row.VoterIdProof || '';
                
                setTimeout(() => { 
                    document.getElementById('AreaId').value = row.AreaId || '';
                    document.getElementById('Gender').value = row.GenderId || row.Gender || '';
                    document.getElementById('BloodGroup').value = row.BloodGroupId || '';
                }, 150);

                if (row.DateOfBirth && row.DateOfBirth.includes('-')) {
                    const [d, m, y] = row.DateOfBirth.split('-');
                    if (d && m && y) document.getElementById('DateOfBirth').value = `${y}-${m}-${d}`;
                }
            }
            regActionBar.show();
        }

        async function handleSubmit(e) {
            e.preventDefault();
            if (!validMobile(document.getElementById('MobileNo').value.trim())) {
                showMsg('error', 'Mobile Number must be 10 digits.');
                return;
            }

            const formData = new FormData();
            formData.append("action", "submit");
            
            // Manually append all data to ensure correctness
            formData.append("RegistrationId", document.getElementById('RegistrationId').value);
            formData.append("userMobileNo", document.getElementById('MobileNo').value.trim());
            formData.append("userAlternateMobileNo", document.getElementById('AlternateMobileNo').value.trim());
            formData.append("userFirstname", document.getElementById('Firstname').value.trim());
            formData.append("userMiddlename", document.getElementById('Middlename').value.trim());
            formData.append("userLastname", document.getElementById('Lastname').value.trim());
            formData.append("AreaId", document.getElementById('AreaId').value);
            formData.append("Address", document.getElementById('Address').value.trim());
            formData.append("Gender", document.getElementById('Gender').value);
            const bloodGroupSelect = document.getElementById('BloodGroup');
            formData.append("BloodGroup", bloodGroupSelect.options[bloodGroupSelect.selectedIndex].textContent);
            formData.append("DateOfBirth", document.getElementById('DateOfBirth').value);
            formData.append("AadharNumber", document.getElementById('AadharNumber').value.trim());
            
            const aadharFile = document.getElementById('AadharUpload').files[0];
            if (aadharFile) formData.append("AadharUpload", aadharFile);
            
            const profileFile = document.getElementById('ProfilePicUpload').files[0];
            if (profileFile) formData.append("ProfilePicUpload", profileFile);
            
            const voterFile = document.getElementById('VoterIdUpload').files[0];
            if (voterFile) formData.append("VoterIdUpload", voterFile);
            
            formData.append("IdProofFileName", document.getElementById('IdProofFileName').value);
            formData.append("PhotoFileName", document.getElementById('PhotoFileName').value);
            formData.append("VoterId", document.getElementById('VoterId').value);

            try {
                const resp = await fetch(API_BASE_URL, { method: "POST", body: formData });
                const res = await resp.json();
                if (String(res.message_code) === "1000") {
                    showMsg('success', res.message_text || 'Operation successful!');
                    regActionBar.hide();
                    RegistrationDisplay.doSearch(false);
                } else {
                    showMsg('error', res.message_text || 'Failed to save registration.');
                }
            } catch (err) {
                console.error("Submission failed:", err);
                showMsg('error', `An error occurred: ${err.message}`);
            }
        }
        
        return {
            openForm,
            handleSubmit
        };
    })();

    // --- MODULE FOR BOOKING TAB ---
    const Booking = (() => {
        let currentlySelectedSeats = [];
        const seatModal = new bootstrap.Modal(document.getElementById('seatSelectionModal'));
        const selectSeatsDisplay = document.getElementById('selectSeatsDisplay');
        const selectedSeatsInput = document.getElementById('selectedSeatsInput');

        async function loadBookingData() {
            if (hasBookingDataLoaded) return;
            try {
                const [routesRes, yatrasRes, busesRes] = await Promise.all([
                    postForm('list_routes'), postForm('list_yatras'), postForm('list_buses')
                ]);
                if (routesRes.message_code === 1000) allRoutes = routesRes.message_data;
                if (yatrasRes.message_code === 1000) allYatras = yatrasRes.message_data;
                if (busesRes.message_code === 1000) allBuses = busesRes.message_data;
                populateRoutes();
                handleRouteChange();
                hasBookingDataLoaded = true;
            } catch (err) {
                console.error("Error fetching booking data:", err);
                showMsg('error', 'Could not fetch booking data.');
            }
        }

        function populateRoutes() {
            selectRoute.innerHTML = '<option value="">All Routes</option>';
            allRoutes.forEach(route => {
                selectRoute.appendChild(new Option(route.YatraRouteName, route.YatraRouteId));
            });
        }

        function handleRouteChange() {
            const selectedRouteId = selectRoute.value;
            const filteredYatras = selectedRouteId ? allYatras.filter(y => String(y.YatraRouteId) === selectedRouteId) : allYatras;
            selectYatra.innerHTML = '<option value="">Select Yatra*</option>';
            filteredYatras.forEach(yatra => {
                selectYatra.appendChild(new Option(`${yatra.YatraRouteName} (${yatra.YatraDateTime})`, yatra.YatraId));
            });
            selectBus.innerHTML = '<option value="">Select Bus*</option>';
        }

        function handleYatraChange() {
            const selectedYatraId = selectYatra.value;
            selectBus.innerHTML = '<option value="">Select Bus*</option>';
            if (selectedYatraId) {
                const filteredBuses = allBuses.filter(b => String(b.YatraId) === selectedYatraId);
                if (filteredBuses.length > 0) {
                    filteredBuses.forEach(bus => {
                        selectBus.appendChild(new Option(`${bus.BusName} (Capacity: ${bus.BusCapacity})`, bus.YatraBusId));
                    });
                } else {
                     selectBus.innerHTML = '<option value="">No buses found</option>';
                }
            }
        }

        async function handleBusChange() {
            currentlySelectedSeats = [];
            updateSelectedSeatsDisplay();
            if (!selectBus.value || !selectYatra.value) {
                document.getElementById('seatMapContainer').innerHTML = '<div class="text-muted">Please select a yatra and bus.</div>';
                selectSeatsDisplay.innerHTML = `<span class="text-muted">Select a bus to see seats</span>`;
                return;
            }
            await fetchAndDisplaySeats(selectRoute.value, selectYatra.value, selectBus.value);
        }

        async function fetchAndDisplaySeats(routeId, yatraId, busId) {
            const seatMapContainer = document.getElementById('seatMapContainer');
            seatMapContainer.innerHTML = '<div class="text-muted">Loading seats...</div>';
            try {
                const data = await postForm('fetch_seats', { route_id: routeId, yatra_id: yatraId, bus_id: busId });
                if (data.message_code === 1000) {
                    renderSeatMap(data.message_data);
                } else {
                    seatMapContainer.innerHTML = `<div class="text-danger">Error: ${data.message_text}</div>`;
                }
            } catch (err) {
                console.error("Failed to fetch seats:", err);
                seatMapContainer.innerHTML = `<div class="text-danger">Failed to load seat information.</div>`;
            }
        }

        function renderSeatMap(data) {
            const seatMapContainer = document.getElementById('seatMapContainer');
            document.getElementById('seatLegend').innerHTML = `
                <div class="legend-item"><div class="legend-box" style="background: #fff; border-color: #28a745;"></div>Available</div>
                <div class="legend-item"><div class="legend-box" style="background: #e9ecef;"></div>Booked</div>
                <div class="legend-item"><div class="legend-box" style="background: #808080;"></div>Reserved</div>
                <div class="legend-item"><div class="legend-box" style="background: #28a745;"></div>Selected</div>`;
            const seatMap = document.createElement('div');
            seatMap.className = 'seat-map';
            seatMap.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; margin-bottom: 10px; font-size: 12px; color: #6c757d;">◄ Front of Bus</div>`;
            for (let i = 1; i <= data.Capacity; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.seatNumber = i;
                seat.textContent = i;
                if (data.reserved_for_swayamsevak.includes(i)) seat.classList.add('reserved');
                else if (data.booked_seats.includes(i)) seat.classList.add('booked');
                else seat.classList.add('available');
                if (currentlySelectedSeats.includes(i)) seat.classList.add('selected');
                seatMap.appendChild(seat);
                if (i % 4 === 2) {
                    const aisle = document.createElement('div');
                    aisle.className = 'seat aisle';
                    seatMap.appendChild(aisle);
                }
            }
            seatMapContainer.innerHTML = '';
            seatMapContainer.appendChild(seatMap);
        }

        document.getElementById('seatMapContainer').addEventListener('click', (e) => {
            if (!e.target.matches('.seat.available')) return;
            const clickedSeatNumber = parseInt(e.target.dataset.seatNumber);
            const isSelected = e.target.classList.contains('selected');
            const maxSeats = document.querySelectorAll('#passengerCheckboxes input:checked').length;
            if (maxSeats === 0) { showMsg('warning', 'Please select passengers first.'); return; }
            
            document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
            currentlySelectedSeats = [];
            if (isSelected) return;

            let newSelection = [];
            for (let i = 0; i < maxSeats; i++) {
                const seatNum = clickedSeatNumber + i;
                const seatEl = document.querySelector(`.seat[data-seat-number='${seatNum}']`);
                if (!seatEl || !seatEl.matches('.available')) {
                    showMsg('warning', `Could not find ${maxSeats} consecutive available seats from this point.`);
                    return;
                }
                newSelection.push(seatNum);
            }
            currentlySelectedSeats = newSelection;
            currentlySelectedSeats.forEach(sn => document.querySelector(`.seat[data-seat-number='${sn}']`)?.classList.add('selected'));
        });

        function updateSelectedSeatsDisplay() {
            currentlySelectedSeats.sort((a, b) => a - b);
            if (currentlySelectedSeats.length > 0) {
                selectSeatsDisplay.innerHTML = `<strong>Seats: ${currentlySelectedSeats.join(', ')}</strong>`;
            } else {
                selectSeatsDisplay.innerHTML = `<span class="text-muted">Click to select seats</span>`;
            }
            selectedSeatsInput.value = currentlySelectedSeats.join(',');
        }

        document.getElementById('confirmSeatSelection').addEventListener('click', () => {
            updateSelectedSeatsDisplay(); seatModal.hide();
        });
        selectSeatsDisplay.addEventListener('click', () => {
            if (selectBus.value) seatModal.show();
            else showMsg('warning', 'Please select a Bus first.');
        });
        
        function addTicket() {
            const selectedPassengerIds = selectedPassengerIdsInput.value.split(',').filter(Boolean);
            const selectedSeatNumbers = selectedSeatsInput.value.split(',').filter(Boolean);
            if (selectedPassengerIds.length === 0 || selectedSeatNumbers.length === 0) { showMsg('error', 'Please select passengers and their seats first.'); return; }
            const yatraId = selectYatra.value;
            const busId = selectBus.value;
            if (!yatraId || !busId) { showMsg('error', 'Please select a yatra and bus.'); return; }

            const selectedYatra = allYatras.find(y => String(y.YatraId) === yatraId);
            if (!selectedYatra) { showMsg('error', 'Could not find yatra details.'); return; }
            const selectedYatraDate = selectedYatra.YatraDateTime.split(' ')[0];

            for (const passengerId of selectedPassengerIds) {
                for (const group of addedTickets) {
                    const existingYatra = allYatras.find(y => String(y.YatraId) === group.yatraId);
                    if (!existingYatra) continue;
                    const existingYatraDate = existingYatra.YatraDateTime.split(' ')[0];
                    const isPassengerInGroup = group.passengers.some(p => p.registrationId === passengerId);
                    if (isPassengerInGroup && (String(group.yatraId) === yatraId || existingYatraDate === selectedYatraDate)) {
                        const p = currentRegistrations.find(r => String(r.RegistrationId) === passengerId);
                        showMsg('error', `'${p ? p.Firstname : 'A passenger'}' is already booked for this yatra or on this date.`);
                        return;
                    }
                }
            }
            const feePerPerson = parseFloat(selectedYatra.YatraFees) || 0;
            const newGroup = { yatraId, yatraName: selectYatra.options[selectYatra.selectedIndex].text.split(' (')[0], busId, busName: selectBus.options[selectBus.selectedIndex].text.split(' (')[0], feePerPerson, passengers: [] };
            selectedPassengerIds.forEach((passengerId, index) => {
                const p = currentRegistrations.find(r => String(r.RegistrationId) === passengerId);
                const name = p ? [p.Firstname, p.Middlename, p.Lastname].filter(Boolean).join(" ") : `ID: ${passengerId}`;
                newGroup.passengers.push({ registrationId: passengerId, registrationName: name, seat: selectedSeatNumbers[index] });
            });
            addedTickets.push(newGroup);
            renderAddedTickets();
            calculateTotalFees();
            currentlySelectedSeats = [];
            updateSelectedSeatsDisplay();
            document.querySelectorAll('#passengerCheckboxes input:checked').forEach(cb => cb.checked = false);
            updateSelectedPassengerDisplay();
        }

        function renderAddedTickets() {
            addedTicketsList.innerHTML = addedTickets.length === 0 ? '<li class="list-group-item text-center text-muted py-4">No tickets added yet.</li>' : '';
            addedTickets.forEach((group, groupIndex) => {
                const li = document.createElement('li');
                li.className = 'list-group-item ticket-summary-item';
                const totalGroupFee = (group.passengers.length * group.feePerPerson).toFixed(2);
                const yatraDate = allYatras.find(y => y.YatraId == group.yatraId)?.YatraDateTime.split(' ')[0] || '';
                li.innerHTML = `
                    <div class="ticket-summary-info">
                        <strong>${group.yatraName} (${yatraDate})</strong>
                        <div class="details-line">
                            Pass: ${group.passengers.length} &nbsp;&bull;&nbsp; Bus: ${group.busName} &nbsp;&bull;&nbsp; Total: <strong>₹${totalGroupFee}</strong>
                        </div>
                    </div>
                    <div class="ticket-summary-actions">
                        <button class="btn btn-sm btn-primary view-details-btn" data-group-index="${groupIndex}" data-bs-toggle="modal" data-bs-target="#ticketDetailsModal">View</button>
                        <button class="btn btn-sm btn-outline-danger remove-ticket-group-btn" data-group-index="${groupIndex}"><i class="bi bi-trash"></i></button>
                    </div>`;
                addedTicketsList.appendChild(li);
            });
        }

        function populateTicketModal(groupIndex) {
            const group = addedTickets[groupIndex];
            if (!group) return;
            const yatraDate = allYatras.find(y => y.YatraId == group.yatraId)?.YatraDateTime.split(' ')[0] || '';
            document.getElementById('ticketDetailsModalLabel').textContent = `${group.yatraName} (${yatraDate})`;
            const passengersHtml = group.passengers.map(p => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><span>${p.registrationName}</span><br><small class="text-muted">Seat: ${p.seat}</small></div>
                    <button class="btn btn-danger btn-sm btn-remove-passenger" data-group-index="${groupIndex}" data-passenger-id="${p.registrationId}"><i class="bi bi-trash"></i></button>
                </li>`).join('');
            document.getElementById('ticketDetailsModalBody').innerHTML = `<ul class="list-group list-group-flush">${passengersHtml}</ul>`;
        }

        function calculateTotalFees() {
            const total = addedTickets.reduce((sum, group) => sum + (group.passengers.length * group.feePerPerson), 0);
            totalFeesInput.value = total.toFixed(2);
            updateFinalAmount();
        }

        function updateFinalAmount() {
            const total = parseFloat(totalFeesInput.value || '0');
            let discount = parseFloat(discountInput.value || '0');
            if (discount > total) discountInput.value = total.toFixed(2);
        }

        function handlePaymentModeChange() {
            upiFieldsDiv.classList.toggle('d-none', paymentModeSelect.value !== 'upi');
            document.getElementById('upiScreenshot').required = paymentModeSelect.value === 'upi';
            document.getElementById('transactionId').required = paymentModeSelect.value === 'upi';
        }

        // =========================================================================
        // ===== START: REPLACED AND CORRECTED submitBooking FUNCTION =====
        // =========================================================================
        async function submitBooking() {
            if (addedTickets.length === 0) {
                showMsg('error', 'There are no tickets added to the booking list.');
                return;
            }

            // --- STEP 1: GATHER PAYMENT AND USER DATA ---
            const userId = '{{ request.session.user_id|default:"0" }}';
            const amountPaid = (parseFloat(totalFeesInput.value) - parseFloat(discountInput.value)).toFixed(2);
            const discount = discountInput.value || '0';
            const discountReason = discountReasonInput.value || '';
            const paymentMode = paymentModeSelect.value;
            const upiFile = document.getElementById('upiScreenshot').files[0];

            // --- Validation ---
            if (paymentMode === '') {
                showMsg('error', 'Please select a payment mode.');
                return;
            }
            if (paymentMode === 'upi' && !upiFile) {
                showMsg('error', 'Please upload a UPI screenshot for UPI payments.');
                return;
            }

            // --- STEP 2: BUILD THE NESTED "Bookings" OBJECT FROM addedTickets ---
            const bookingsObject = addedTickets.map(group => {
                return {
                    YatraId: group.yatraId,
                    BusId: group.busId,
                    Registrations: group.passengers.map(p => ({
                        RegistrationId: p.registrationId,
                        SeatNo: p.seat
                    }))
                };
            });

            // --- STEP 3: PREPARE FORMDATA FOR THE AJAX REQUEST ---
            const formData = new FormData();
            formData.append('action', 'book_ticket');
            formData.append('UserId', userId);
            formData.append('AmountPaid', amountPaid);
            formData.append('Discount', discount);
            formData.append('DiscountReason', discountReason);
            formData.append('PaymentMode', paymentMode);
            
            if (upiFile) {
                formData.append('UPIScreenshot', upiFile);
            }
            
            formData.append('Bookings', JSON.stringify(bookingsObject));

            // --- STEP 4: SEND THE DATA TO YOUR BACKEND PROXY ---
            try {
                // ★★★ START: ADDED ROBUST CSRF TOKEN CHECK ★★★
                const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');

                if (!csrfTokenElement) {
                    // This provides a much clearer error than the crash
                    showMsg('error', 'Security token (CSRF) not found. Please reload the page.');
                    console.error('CRITICAL: CSRF token input field not found on the page. Ensure {% csrf_token %} is in the template.');
                    return; // Stop execution
                }
                // ★★★ END: ADDED ROBUST CSRF TOKEN CHECK ★★★

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfTokenElement.value // Use the validated token
                    }
                });

                const result = await response.json();

                if (result.message_code === 1000) {
                    showMsg('success', result.message_text || 'Booking successful!');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showMsg('error', result.message_text || 'An unknown error occurred during booking.');
                }
            } catch (error) {
                // The error will now be caught and displayed gracefully
                console.error('Submission failed:', error);
                showMsg('error', 'A critical error occurred. Please check the developer console.');
            }
        }
        
        // =========================================================================
        // ===== END: REPLACED AND CORRECTED submitBooking FUNCTION =====
        // =========================================================================

        // =========================================================================
        // ===== START: ADDED MISSING RETURN BLOCK TO FIX UNCLICKABLE BUTTONS ======
        // =========================================================================
        // Expose public functions so they can be called from outside the module
        return {
            loadBookingData,
            handleRouteChange,
            handleYatraChange,
            handleBusChange,
            addTicket,
            renderAddedTickets,
            populateTicketModal,
            calculateTotalFees,
            updateFinalAmount,
            handlePaymentModeChange,
            submitBooking
        };
        // =========================================================================
        // ===== END: ADDED MISSING RETURN BLOCK ======
        // =========================================================================
    })();

    // --- PAGE INITIALIZATION & MAIN EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Initialize the Bootstrap modal
        ticketDetailsModal = new bootstrap.Modal(document.getElementById('ticketDetailsModal'));
        
        // 2. Set up initial page state for Registration tab
        RegistrationDisplay.populateHistoryYears();
        sessionStorage.removeItem('lastSearchMobile');
        searchMobileInput.value = '';
        labelMobile.textContent = '';
        
        // 3. Set up initial state for Booking tab
        Booking.renderAddedTickets();
        Booking.calculateTotalFees();

        // --- ALL EVENT LISTENERS ARE HERE ---

        // 4. Main page event listeners
        btnSearch.addEventListener('click', () => RegistrationDisplay.doSearch(true));
        searchMobileInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') RegistrationDisplay.doSearch(true); });
        btnAddNew.addEventListener('click', () => {
            const mob = searchMobileInput.value.trim();
            if (!validMobile(mob)) {
                showMsg('error', "Please enter a valid 10-digit mobile number in the search box first.");
                searchMobileInput.focus();
                return;
            }
            RegistrationForm.openForm('insert', null, mob);
        });
        regForm.addEventListener('submit', RegistrationForm.handleSubmit);
        historyYearSelect.addEventListener('change', RegistrationDisplay.fetchBookingHistory);
        historyPassengerSelect.addEventListener('change', RegistrationDisplay.fetchBookingHistory);
        btnRegNext.addEventListener('click', () => { new bootstrap.Tab(document.getElementById('booking-tab')).show(); });
        bookingTabButton.addEventListener('shown.bs.tab', () => {
            Booking.loadBookingData();
            populatePassengerBookingDropdown(currentRegistrations);
        });
        selectRoute.addEventListener('change', Booking.handleRouteChange);
        selectYatra.addEventListener('change', Booking.handleYatraChange);
        selectBus.addEventListener('change', Booking.handleBusChange);
        btnAddTicket.addEventListener('click', Booking.addTicket);
        discountInput.addEventListener('input', Booking.updateFinalAmount);
        paymentModeSelect.addEventListener('change', Booking.handlePaymentModeChange);
        submitBookingBtn.addEventListener('click', Booking.submitBooking);

        // 5. Event delegation for dynamically created buttons in "Added Tickets" list
        addedTicketsList.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-details-btn');
            const removeGroupBtn = e.target.closest('.remove-ticket-group-btn');
            
            if (viewBtn) {
                const groupIndex = parseInt(viewBtn.dataset.groupIndex);
                Booking.populateTicketModal(groupIndex);
            }
            
            if (removeGroupBtn) {
                const groupIndex = parseInt(removeGroupBtn.dataset.groupIndex);
                addedTickets.splice(groupIndex, 1);
                Booking.renderAddedTickets();
                Booking.calculateTotalFees();
            }
        });

        // 6. Event delegation for buttons inside the ticket details modal
        document.getElementById('ticketDetailsModalBody').addEventListener('click', (e) => {
             const removePassengerBtn = e.target.closest('.btn-remove-passenger');
             if(removePassengerBtn) {
                const groupIndex = parseInt(removePassengerBtn.dataset.groupIndex);
                const passengerId = removePassengerBtn.dataset.passengerId;
                
                const group = addedTickets[groupIndex];
                if (!group) return;

                group.passengers = group.passengers.filter(p => p.registrationId !== passengerId);

                if (group.passengers.length === 0) {
                    addedTickets.splice(groupIndex, 1);
                    ticketDetailsModal.hide();
                } else {
                    Booking.populateTicketModal(groupIndex); 
                }
                
                Booking.renderAddedTickets();
                Booking.calculateTotalFees();
             }
        });
    });
</script>
</body>
</html>