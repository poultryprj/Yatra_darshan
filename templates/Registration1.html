{% load i18n %}
{% load static %}
{% load pwa %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Yatra Darshan Booking</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --brand-orange: #ff7b00;
            --brand-orange-dark: #e67000;
            --brand-blue: #003399;
            --brand-green: #006633;
        }

        body {
            background: #f0f2f5;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: var(--brand-orange);
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .navbar-brand {
            color: #fff;
            font-weight: 600;
            font-size: 20px;
        }

        .container-main {
            max-width: 980px;
            margin: 75px auto 40px;
            padding: 0 12px;
        }

        .card-main {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
            overflow: hidden;
            background-color: #fff;
        }

        .search-bar-top {
            padding: 18px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-grow {
            flex: 1;
            position: relative;
        }

        .search-grow input {
            width: 100%;
            height: 40px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 0 45px 0 10px;
            font-size: 1rem;
        }

        .search-icon-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 6px;
            border: none;
            background: var(--brand-orange);
            color: #fff;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .search-icon-btn:hover {
            background: var(--brand-orange-dark);
        }

        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .nav-tabs .nav-link.active {
            color: var(--brand-orange);
            border-color: var(--brand-orange);
            background-color: #fff;
        }

        .tab-content {
            padding: 20px;
            background-color: #fff;
        }

        .registration-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .registration-list-header h5 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .listview .list-group-item {
            border: 0;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .listview .list-group-item:hover {
            background: #fbfbff;
        }

        .item-line {
            font-size: 14px;
        }

        .btn-add-reg {
            background: var(--brand-green);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .btn-add-reg:hover {
            background: #005a2e;
        }

        .section-header {
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
        }

        .floating {
            position: relative;
            margin-bottom: 16px;
        }

        .floating input,
        .floating select,
        .floating textarea {
            width: 100%;
            padding: 12px 10px 10px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: #fff;
            outline: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .floating input:focus,
        .floating select:focus,
        .floating textarea:focus {
            border-color: var(--brand-orange);
            box-shadow: 0 0 0 0.25rem rgba(255, 123, 0, 0.25);
        }

        .floating label {
            position: absolute;
            left: 10px;
            top: 12px;
            font-size: 14px;
            color: #6c757d;
            pointer-events: none;
            transition: all 0.2s ease;
            background: #fff;
            padding: 0 4px;
            margin-left: -4px;
        }

        .floating input:focus + label,
        .floating input:not(:placeholder-shown) + label,
        .floating select:focus + label,
        .floating select:not([value=""]) + label,
        .floating textarea:focus + label,
        .floating textarea:not(:placeholder-shown) + label {
            top: -8px;
            font-size: 11px;
            color: var(--brand-orange);
        }
        
        /* --- NEW CSS for two-column booking layout --- */
        .compact-booking-layout #selectPassengers {
             min-height: 145px; /* Taller passenger select box */
        }
        .compact-booking-layout .floating, .compact-booking-layout .floating select {
            height: 100%;
        }
        .compact-booking-layout .form-text {
            position: absolute;
            bottom: -15px;
            left: 0;
            font-size: 0.75rem;
        }


        .btn-submit {
            background: var(--brand-orange);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-submit:hover {
            background: var(--brand-orange-dark);
        }

        .offcanvas-end {
            width: 400px !important;
            max-width: 90vw;
        }

        .offcanvas-header {
            background: var(--brand-orange);
            color: #fff;
            padding: 15px 20px;
        }

        .offcanvas-title {
            color: #fff;
            font-size: 18px;
        }

        .offcanvas-body {
            padding: 20px;
            overflow-y: auto;
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }

        .yatra-summary {
            font-size: 0.9rem;
            color: #555;
        }
        .yatra-summary strong {
            color: #333;
        }

        .form-control-file {
            padding-top: 10px;
            padding-bottom: 10px;
            font-size: 14px;
        }
        .next-tab-button {
          margin-top: 20px;
          text-align: right;
        }
        .next-tab-button .btn {
          background-color: var(--brand-blue);
          border-color: var(--brand-blue);
        }
        .next-tab-button .btn:hover {
          background-color: #002b80;
          border-color: #002b80;
        }

        .history-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-file-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }

        .compact-form .row {
            margin-bottom: 0;
        }

        .compact-form .floating {
            margin-bottom: 12px;
        }

        .compact-form textarea {
            min-height: 60px;
        }
        
        /* Compact booking layout - Passengers left, Route/Yatra/Bus right stacked */
        .compact-booking-layout {
            margin-bottom: 16px;
        }

        .compact-booking-layout .floating {
            margin-bottom: 12px;
            height: auto;
        }

        .compact-booking-layout #selectPassengers {
            min-height: 160px;
            height: 160px;
        }

        /* Right column with stacked fields */
        .compact-booking-layout .right-stacked-fields {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .compact-booking-layout .right-stacked-fields .floating {
            margin-bottom: 10px;
            flex: 1;
        }

        .compact-booking-layout .right-stacked-fields .floating:last-child {
            margin-bottom: 12px;
        }

        .compact-booking-layout .right-stacked-fields select {
            height: 48px;
        }

        #selectSeats {
            min-height: 80px;
        }

        .compact-booking-layout .form-text {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #6c757d;
        }

        @media (max-width: 767px) {
            .compact-booking-layout #selectPassengers {
                min-height: 130px;
                height: 130px;
            }
            
            .compact-booking-layout .right-stacked-fields .floating {
                margin-bottom: 8px;
            }
            
            .compact-booking-layout .right-stacked-fields select {
                height: 40px;
            }
            
            #selectSeats {
                min-height: 70px;
            }
            
            .compact-booking-layout .form-text {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <!-- Topbar -->
    <nav class="navbar fixed-top">
        <span class="navbar-brand">Yatra Darshan Booking</span>
    </nav>

    <!-- Main Content Container -->
    <div class="container-main">
        <div class="card-main">
            <!-- Search Bar at the very top -->
            <div class="search-bar-top">
                <div class="search-grow">
                    <input id="searchMobile" type="tel" maxlength="10" placeholder="Mobile Number" autocomplete="off" />
                    <button id="btnSearch" class="search-icon-btn" title="Search">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration" type="button" role="tab" aria-controls="registration" aria-selected="true">Registration</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking" type="button" role="tab" aria-controls="booking" aria-selected="false">Booking</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="myTabContent">
                <!-- Registration Tab -->
                <div class="tab-pane fade show active" id="registration" role="tabpanel" aria-labelledby="registration-tab">
                    <div id="statusMsg" class="alert d-none"></div>

                    <div class="registration-list-header">
                        <h5>Registrations for <strong id="labelMobile"></strong></h5>
                        <button id="btnAddNew" class="btn-add-reg" title="Add new registration">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="regList" class="listview">
                        <ul id="regItems" class="list-group list-group-flush">
                            <li class="list-group-item text-center text-muted py-4">Search a mobile number to see registrations.</li>
                        </ul>
                    </div>
                    <div class="next-tab-button">
                        <button id="btnRegNext" class="btn btn-primary">Next <i class="bi bi-arrow-right"></i></button>
                    </div>

                    <div class="section-header">Booking History</div>
                    <div class="history-filters">
                        <div class="floating">
                            <select id="historyPassenger" placeholder=" ">
                                <option value="">Select Passenger</option>
                            </select>
                            <label>Passenger</label>
                        </div>
                        <div class="floating">
                            <select id="historyYear" placeholder=" ">
                                <option value="">Select Year</option>
                            </select>
                            <label>Year</label>
                        </div>
                    </div>
                    <div id="bookingHistoryList" class="list-group">
                         <li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>
                    </div>
                </div>

                <!-- Booking Tab -->
                <div class="tab-pane fade" id="booking" role="tabpanel"           aria-labelledby="booking-tab">
                    <div class="section-header">Select Passengers & Yatra Details</div>

                        <!-- TWO-COLUMN LAYOUT: Passengers on Left, Route/Yatra/Bus stacked on Right -->
                        <div class="row g-2 compact-booking-layout">
                            <!-- Left Column: Passengers (tall) -->
                            <div class="col-6">
                                <div class="floating">
                                    <select id="selectPassengers" multiple placeholder=" " required>
                                        <!-- Options populated by JS -->
                                    </select>
                                    <label>Select Passengers*</label>
                                </div>
                            </div>
                            
                            <!-- Right Column: Route, Yatra, Bus stacked vertically -->
                            <div class="col-6 right-stacked-fields">
                                <div class="floating">
                                    <select id="selectRoute" placeholder=" " required>
                                        <option value="">Select Route*</option>
                                    </select>
                                    <label>Route</label>
                                </div>
                                <div class="floating">
                                    <select id="selectYatra" placeholder=" " required>
                                        <option value="">Select Yatra*</option>
                                    </select>
                                    <label>Yatra</label>
                                </div>
                                <div class="floating">
                                    <select id="selectBus" placeholder=" " required>
                                        <option value="">Select Bus*</option>
                                    </select>
                                    <label>Bus</label>
                                </div>
                            </div>
                        </div>

                        <!-- Seats Section - Full Width -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <div class="floating">
                                    <select id="selectSeats" multiple placeholder=" " required>
                                    </select>
                                    <label>Select Seats*</label>
                                </div>
                                <div class="form-text">Match number of seats to passengers.</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-3">
                            <button id="btnAddTicket" class="btn btn-success"><i class="bi bi-plus-circle me-1"></i> Add Ticket</button>
                        </div>

                    <div class="section-header mt-2">Added Tickets</div>
                    <div id="addedTicketsList" class="list-group mb-3">
                         <li class="list-group-item text-center text-muted py-4">No tickets added yet.</li>
                    </div>

                    <div class="section-header mt-2">Payment Details</div>
                    <div class="floating">
                        <input id="totalFees" type="number" placeholder=" " min="0" readonly>
                        <label>Total Fees (₹)</label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="floating">
                                <input id="discount" type="number" placeholder=" " min="0" value="0">
                                <label>Discount (₹)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="floating">
                                <input id="discountReason" type="text" placeholder=" ">
                                <label>Discount Reason</label>
                            </div>
                        </div>
                    </div>
                    <div class="floating">
                        <select id="paymentMode" placeholder=" " required>
                            <option value="">Select Payment Mode*</option>
                            <option value="cash">Cash</option>
                            <option value="upi">UPI</option>
                        </select>
                        <label>Payment Mode</label>
                    </div>

                    <div id="upiFields" class="d-none">
                        <div class="floating">
                            <input id="transactionId" type="text" placeholder=" ">
                            <label>UPI Transaction ID</label>
                        </div>
                        <div class="mb-3">
                            <label for="upiScreenshot" class="form-label">Upload UPI Screenshot*</label>
                            <input id="upiScreenshot" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        </div>
                    </div>

                    <div class="mt-4 d-grid">
                        <button id="submitBooking" type="button" class="btn-submit">
                            <i class="bi bi-check2-circle me-1"></i> Submit Booking
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration/Update Side Panel (Offcanvas) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="regActionBar" aria-labelledby="regActionBarLabel">
        <div class="offcanvas-header">
            <h5 id="regActionBarLabel" class="offcanvas-title">Pilgrim Registration</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form id="regForm" class="compact-form" autocomplete="off">
                <input id="RegistrationId" type="hidden" value="0">

                <div class="row g-2">
                    <div class="col-6">
                        <div class="floating">
                            <input id="MobileNo" type="tel" placeholder=" " maxlength="10" required>
                            <label>Mobile No. *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="AlternateMobileNo" type="tel" placeholder=" " maxlength="10">
                            <label>Alternate Mobile</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="Firstname" type="text" placeholder=" " required>
                            <label>First Name *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="Middlename" type="text" placeholder=" ">
                            <label>Middle Name</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="Lastname" type="text" placeholder=" " required>
                            <label>Last Name *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <select id="AreaId" placeholder=" " required><option value="">Select Area*</option></select>
                            <label>Area *</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="floating">
                            <textarea id="Address" placeholder=" " rows="2" required></textarea>
                            <label>Address *</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <select id="Gender" placeholder=" "><option value="">Select Gender</option></select>
                            <label>Gender</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <select id="BloodGroup" placeholder=" "><option value="">Select Blood Group</option></select>
                            <label>Blood Group</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="DateOfBirth" type="date" placeholder=" ">
                            <label>Date of Birth</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="floating">
                            <input id="AadharNumber" type="text" placeholder=" " maxlength="12">
                            <label>Aadhar No.</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="AadharUpload" class="form-file-label">Aadhar Upload</label>
                        <input id="AadharUpload" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        <input type="hidden" id="IdProofFileName" value="">
                    </div>
                    <div class="col-12">
                        <label for="ProfilePicUpload" class="form-file-label">Profile Picture</label>
                        <input id="ProfilePicUpload" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        <input type="hidden" id="PhotoFileName" value="">
                    </div>
                    <div class="col-12">
                        <label for="VoterIdUpload" class="form-file-label">Voter ID Upload</label>
                        <input id="VoterIdUpload" type="file" class="form-control form-control-file" accept="image/*,.pdf">
                        <input type="hidden" id="VoterId" value="">
                    </div>
                </div>

                <div class="mt-3 d-grid">
                    <button id="btnSubmit" type="submit" class="btn-submit"><i class="bi bi-check2-circle me-1"></i> Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // NOTE: The JavaScript code remains the same as the previous version.
    // The changes are purely structural (HTML) and stylistic (CSS).
    
    const API_BASE_URL = "{% url 'registration_api1' %}";

    async function postForm(action, data = {}, isFormData = false) {
        const fd = new FormData();
        fd.append('action', action);
        if (isFormData) {
            for (let pair of data.entries()) {
                fd.append(pair[0], pair[1]);
            }
        } else {
            for (const k in data) {
                if (data[k] instanceof File) {
                    fd.append(k, data[k], data[k].name);
                } else {
                    fd.append(k, data[k]);
                }
            }
        }
        const url = API_BASE_URL;
        const response = await fetch(url, { method: 'POST', body: fd });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }

    function showMsg(type, text, title = null) {
        Swal.fire({
            icon: type,
            title: title || (type === 'success' ? 'Success!' : 'Error!'),
            html: text,
            confirmButtonColor: '#ff7b00',
        });
    }

    function validMobile(m) {
        return /^\d{10}$/.test(m);
    }
    
    function populatePassengerBookingDropdown(registrations) {
        const selectPassengers = document.getElementById('selectPassengers');
        selectPassengers.innerHTML = '';
        if (registrations && registrations.length > 0) {
            registrations.forEach(reg => {
                const fullName = [reg.Firstname, reg.Middlename, reg.Lastname].filter(Boolean).join(" ");
                const option = document.createElement('option');
                option.value = reg.RegistrationId;
                option.textContent = fullName;
                selectPassengers.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = 'No passengers found for this number.';
            option.disabled = true;
            selectPassengers.appendChild(option);
        }
    }

    const searchMobileInput = document.getElementById('searchMobile');
    const btnSearch = document.getElementById('btnSearch');
    const btnAddNew = document.getElementById('btnAddNew');
    const labelMobile = document.getElementById('labelMobile');
    const regItemsList = document.getElementById('regItems');
    const regActionBar = new bootstrap.Offcanvas(document.getElementById('regActionBar'));
    const regForm = document.getElementById('regForm');
    const btnRegNext = document.getElementById('btnRegNext');
    const historyYearSelect = document.getElementById('historyYear');
    const historyPassengerSelect = document.getElementById('historyPassenger');
    const bookingHistoryList = document.getElementById('bookingHistoryList');
    const selectPassengers = document.getElementById('selectPassengers'); 
    const selectRoute = document.getElementById('selectRoute');
    const selectYatra = document.getElementById('selectYatra');
    const selectBus = document.getElementById('selectBus');
    const selectSeats = document.getElementById('selectSeats');
    const btnAddTicket = document.getElementById('btnAddTicket');
    const addedTicketsList = document.getElementById('addedTicketsList');
    const totalFeesInput = document.getElementById('totalFees');
    const discountInput = document.getElementById('discount');
    const discountReasonInput = document.getElementById('discountReason');
    const paymentModeSelect = document.getElementById('paymentMode');
    const upiFieldsDiv = document.getElementById('upiFields');
    const submitBookingBtn = document.getElementById('submitBooking');
    const bookingTabButton = document.getElementById('booking-tab');

    let allRoutes = [];
    let allYatras = [];
    let allBuses = [];
    let currentRegistrations = [];
    let addedTickets = [];
    let hasLoadedRoutesYatras = false;

    const RegistrationDisplay = (() => {
        let isExplicitSearch = false;

        async function doSearch(explicitSearchTriggered = true) {
            const mob = searchMobileInput.value.trim();
            if (!validMobile(mob)) {
                showMsg('error', 'Please enter a valid 10-digit mobile number.');
                labelMobile.textContent = '';
                regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Search a mobile number to see registrations.</li>';
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>';
                populatePassengerBookingDropdown([]);
                return;
            }
            sessionStorage.setItem('lastSearchMobile', mob);
            isExplicitSearch = explicitSearchTriggered;

            labelMobile.textContent = mob;
            regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-2">Loading registrations...</li>';

            try {
                const resp = await postForm('search_list', { search: mob });
                if (resp.message_code === 1000 && Array.isArray(resp.message_data)) {
                    currentRegistrations = resp.message_data;
                    renderRegistrationList(currentRegistrations, mob);
                    populatePassengerDropdown(currentRegistrations);
                    populatePassengerBookingDropdown(currentRegistrations);
                    if (isExplicitSearch) {
                        showMsg('success', `${currentRegistrations.length} registrations found.`);
                    }
                } else {
                    currentRegistrations = [];
                    renderRegistrationList([], mob);
                    populatePassengerDropdown([]);
                    populatePassengerBookingDropdown([]);
                    showMsg('error', resp.message_text || 'No records found.');
                }
            } catch (err) {
                console.error("Search failed:", err);
                showMsg('error', 'Search failed. Please try again.');
            }
            await fetchBookingHistory();
        }

        function populatePassengerDropdown(registrations) {
            historyPassengerSelect.innerHTML = '<option value="">All Passengers</option>';
            registrations.forEach(r => {
                const fullName = [r.Firstname, r.Middlename, r.Lastname].filter(Boolean).join(" ");
                const option = document.createElement('option');
                option.value = r.RegistrationId;
                option.textContent = fullName;
                historyPassengerSelect.appendChild(option);
            });
            if (registrations.length > 0 && !historyPassengerSelect.value) {
                historyPassengerSelect.value = registrations[0].RegistrationId;
            }
        }

        function renderRegistrationList(registrations, mob) {
            regItemsList.innerHTML = '';
            if (!registrations.length) {
                regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-4">No registrations found for this number.</li>';
                return;
            }
            registrations.forEach(r => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                const fullName = [r.Firstname, r.Middlename, r.Lastname].filter(Boolean).join(" ");
                const area = r.AreaName || '-';
                li.innerHTML = `<div class="item-line"><strong>${fullName}</strong>, ${area}</div>`;
                li.addEventListener('click', () => RegistrationForm.openForm('update', r, mob));
                regItemsList.appendChild(li);
            });
        }

        function populateHistoryYears() {
            const currentYear = new Date().getFullYear();
            historyYearSelect.innerHTML = '<option value="">Select Year</option>';
            for (let i = currentYear; i >= currentYear - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                historyYearSelect.appendChild(option);
            }
            historyYearSelect.value = currentYear;
        }

        async function fetchBookingHistory() {
            const mob = searchMobileInput.value.trim();
            const year = historyYearSelect.value;
            const passengerId = historyPassengerSelect.value;

            if (!validMobile(mob) || !year) {
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>';
                return;
            }

            bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-2">Loading history...</li>';

            try {
                const resp = await postForm('get_booking_history', {
                    mobile: mob,
                    year: year,
                    passengerId: passengerId
                });
                if (resp.message_code === 1000 && Array.isArray(resp.message_data)) {
                    renderBookingHistory(resp.message_data);
                } else {
                    bookingHistoryList.innerHTML = `<li class="list-group-item text-center text-muted py-4">${resp.message_text || 'No booking history found.'}</li>`;
                }
            } catch (err) {
                console.error("Failed to fetch booking history:", err);
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Error fetching history.</li>';
            }
        }

        function renderBookingHistory(history) {
            bookingHistoryList.innerHTML = '';
            if (!history.length) {
                bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">No booking history found.</li>';
                return;
            }
            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                        <div>
                            <strong>Yatra:</strong> ${item.YatraName || 'N/A'}<br>
                            <strong>Date:</strong> ${item.YatraDate || 'N/A'}<br>
                            <strong>Seats:</strong>${item.Seats || 'N/A'}
                        </div>
                        <div>
                            <strong>Total:</strong>₹${item.AmountPaid || '0'}<br>
                            <span class="badge bg-secondary">${item.Status || 'Booked'}</span>
                        </div>
                    `;
                bookingHistoryList.appendChild(li);
            });
        }

        return { doSearch, populateHistoryYears, fetchBookingHistory };
    })();

    const RegistrationForm = (() => {
        const areaSel = document.getElementById('AreaId');
        const genderSel = document.getElementById('Gender');
        const bloodSel = document.getElementById('BloodGroup');

        async function loadDropdowns() {
            const [areas, genders, bloodgroups] = await Promise.all([
                postForm('list_area'),
                postForm('list_gender'),
                postForm('list_bloodgroup')
            ]);

            function fillSelect(sel, res, vKey, tKey) {
                sel.innerHTML = '<option value="">Select</option>';
                if (res && res.message_code === 1000 && Array.isArray(res.message_data)) {
                    res.message_data.forEach(it => {
                        const o = document.createElement('option');
                        o.value = it[vKey];
                        o.textContent = it[tKey];
                        sel.appendChild(o);
                    });
                }
            }

            fillSelect(areaSel, areas, 'AreaId', 'AreaName');
            fillSelect(genderSel, genders, 'GenderId', 'GenderName');
            fillSelect(bloodSel, bloodgroups, 'bloodGroupId', 'bloodGroupName');
        }

        async function openForm(mode, row = null, mobile = '') {
            regForm.reset();
            document.getElementById('RegistrationId').value = '0';
            document.getElementById('PhotoFileName').value = '';
            document.getElementById('IdProofFileName').value = '';
            document.getElementById('VoterId').value = '';
            document.getElementById('AadharUpload').value = '';
            document.getElementById('ProfilePicUpload').value = '';
            document.getElementById('VoterIdUpload').value = '';

            document.getElementById('regActionBarLabel').textContent = mode === 'insert' ? 'Add New Registration' : 'Update Registration';

            document.getElementById('AadharUpload').required = mode === 'insert' || (!row || !row.IdProofFileName);
            document.getElementById('ProfilePicUpload').required = mode === 'insert' || (!row || !row.PhotoFileName);
            document.getElementById('VoterIdUpload').required = mode === 'insert' || (!row || !row.VoterIdProof);


            if (mode === 'insert' && mobile) {
                document.getElementById('MobileNo').value = mobile;
            }

            await loadDropdowns(); 

            if (mode === 'update' && row) {
                document.getElementById('RegistrationId').value = row.RegistrationId || '0';
                document.getElementById('MobileNo').value = row.MobileNo || mobile || '';
                document.getElementById('AlternateMobileNo').value = row.AlternateMobileNo || '';
                document.getElementById('Firstname').value = row.Firstname || '';
                document.getElementById('Middlename').value = row.Middlename || '';
                document.getElementById('Lastname').value = row.Lastname || '';
                document.getElementById('Address').value = row.Address || '';
                document.getElementById('AadharNumber').value = row.AadharNumber || '';
                document.getElementById('PhotoFileName').value = row.PhotoFileName || '';
                document.getElementById('IdProofFileName').value = row.IdProofFileName || '';
                document.getElementById('VoterId').value = row.VoterIdProof || '';
                document.getElementById('AadharUpload').required = !row.IdProofFileName;
                document.getElementById('ProfilePicUpload').required = !row.PhotoFileName;
                document.getElementById('VoterIdUpload').required = !row.VoterIdProof;

                setTimeout(() => { 
                    document.getElementById('AreaId').value = row.AreaId || '';
                    document.getElementById('Gender').value = row.Gender || '';
                    const bloodGroupSelect = document.getElementById('BloodGroup');
                    let bloodGroupOption;
                    if (row.BloodGroupId) {
                        bloodGroupOption = Array.from(bloodGroupSelect.options).find(opt => opt.value === String(row.BloodGroupId));
                    } else if (row.BloodGroup) {
                        bloodGroupOption = Array.from(bloodGroupSelect.options).find(opt => opt.textContent.toLowerCase() === row.BloodGroup.toLowerCase());
                    }

                    if (bloodGroupOption) bloodGroupSelect.value = bloodGroupOption.value;
                }, 100); 

                if (row.DateOfBirth) {
                    const dobParts = row.DateOfBirth.split('-');
                    if (dobParts.length === 3) {
                        document.getElementById('DateOfBirth').value = `${dobParts[2]}-${dobParts[1]}-${dobParts[0]}`;
                    } else if (String(row.DateOfBirth).match(/^\d+$/)) {
                        const date = new Date(parseInt(row.DateOfBirth) * 1000);
                        if (!isNaN(date.getTime())) {
                            document.getElementById('DateOfBirth').value = date.toISOString().split('T')[0];
                        }
                    }
                }
            }
            regActionBar.show();
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const requiredFields = ['MobileNo', 'Firstname', 'Lastname', 'AreaId', 'Address'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showMsg('error', `Please fill out the ${field.previousElementSibling.textContent.replace(' *', '')} field.`);
                    field.focus();
                    return;
                }
            }

            const mobileNo = document.getElementById('MobileNo').value.trim();
            if (!validMobile(mobileNo)) {
                showMsg('error', 'Mobile Number must be 10 digits.');
                document.getElementById('MobileNo').focus();
                return;
            }
            const registrationId = document.getElementById('RegistrationId').value;
            const formData = new FormData();
            formData.append("action", "submit");
            formData.append("RegistrationId", registrationId);
            formData.append("userMobileNo", document.getElementById('MobileNo').value.trim());
            formData.append("userAlternateMobileNo", document.getElementById('AlternateMobileNo').value.trim());
            formData.append("userFirstname", document.getElementById('Firstname').value.trim());
            formData.append("userMiddlename", document.getElementById('Middlename').value.trim());
            formData.append("userLastname", document.getElementById('Lastname').value.trim());
            formData.append("AreaId", document.getElementById('AreaId').value);
            formData.append("Address", document.getElementById('Address').value.trim());
            formData.append("Gender", document.getElementById('Gender').value);
            formData.append("BloodGroup", document.getElementById('BloodGroup').options[document.getElementById('BloodGroup').selectedIndex].textContent);
            const dobVal = document.getElementById('DateOfBirth').value;
            formData.append("DateOfBirth", dobVal || "");
            formData.append("AadharNumber", document.getElementById('AadharNumber').value.trim());

            const aadharUpload = document.getElementById('AadharUpload').files[0];
            const profilePicUpload = document.getElementById('ProfilePicUpload').files[0];
            const voterIdUpload = document.getElementById('VoterIdUpload').files[0];

            if (aadharUpload) formData.append("AadharUpload", aadharUpload);
            else if (document.getElementById('IdProofFileName').value) formData.append("IdProofFileName", document.getElementById('IdProofFileName').value);

            if (profilePicUpload) formData.append("ProfilePicUpload", profilePicUpload);
            else if (document.getElementById('PhotoFileName').value) formData.append("PhotoFileName", document.getElementById('PhotoFileName').value);

            if (voterIdUpload) formData.append("VoterIdUpload", voterIdUpload);
            else if (document.getElementById('VoterId').value) formData.append("VoterId", document.getElementById('VoterId').value);

            try {
                const resp = await fetch("{% url 'registration_api1' %}", { method: "POST", body: formData });
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                const res = await resp.json();
                if (String(res.message_code) === "1000") {
                    const message = registrationId === '0' ? 'Registration added successfully!' : 'Registration updated successfully!';
                    showMsg('success', res.message_text || message);
                    regActionBar.hide();
                    RegistrationDisplay.doSearch(false);
                } else {
                    showMsg('error', res.message_text || 'Failed to save registration.');
                }
            } catch (err) {
                console.error("Submission failed:", err);
                showMsg('error', `An error occurred: ${err.message}`);
            }
        }

        return { openForm, handleSubmit };
    })();

    const Booking = (() => {
        async function loadAllRoutesYatras() {
            if (hasLoadedRoutesYatras) return;

            try {
                const resp = await postForm('get_routes_yatras');
                if (resp.message_code === 1000 && Array.isArray(resp.message_data)) {
                    allRoutes = resp.message_data;
                    populateRoutes();
                    hasLoadedRoutesYatras = true;
                } else {
                    console.error("Failed to load routes and yatras:", resp.message_text);
                    showMsg('error', 'Failed to load route and yatra data.');
                }
            } catch (err) {
                console.error("Error fetching routes/yatras:", err);
                showMsg('error', 'Could not fetch routes/yatras. Please check network or API configuration.');
            }
        }

        function populateRoutes() {
            selectRoute.innerHTML = '<option value="">Select Route*</option>';
            allRoutes.forEach(route => {
                const option = document.createElement('option');
                option.value = route.RouteId;
                option.textContent = route.RouteName;
                selectRoute.appendChild(option);
            });
        }

        async function handleRouteChange() {
            const selectedRouteId = selectRoute.value;
            selectYatra.innerHTML = '<option value="">Select Yatra*</option>';
            selectBus.innerHTML = '<option value="">Select Bus*</option>';
            selectSeats.innerHTML = '';

            if (selectedRouteId) {
                const selectedRoute = allRoutes.find(r => String(r.RouteId) === selectedRouteId);
                if (selectedRoute && Array.isArray(selectedRoute.Yatras)) {
                    allYatras = selectedRoute.Yatras;
                    allYatras.forEach(yatra => {
                        const option = document.createElement('option');
                        option.value = yatra.YatraId;
                        option.textContent = `${yatra.YatraName} (${yatra.YatraDate})`;
                        selectYatra.appendChild(option);
                    });
                }
            }
        }

        async function handleYatraChange() {
            const selectedYatraId = selectYatra.value;
            selectBus.innerHTML = '<option value="">Select Bus*</option>';
            selectSeats.innerHTML = '';

            if (selectedYatraId) {
                try {
                    const resp = await postForm('get_yatra_buses', { yatraId: selectedYatraId });
                    if (resp.message_code === 1000 && Array.isArray(resp.message_data)) {
                        allBuses = resp.message_data;
                        allBuses.forEach(bus => {
                            const option = document.createElement('option');
                            option.value = bus.BusId;
                            option.textContent = `${bus.BusNumber} (Capacity: ${bus.Capacity}, Booked: ${bus.BookedSeats.length})`;
                            selectBus.appendChild(option);
                        });
                    } else {
                        showMsg('error', 'Failed to load buses for this yatra.');
                    }
                } catch (err) {
                    showMsg('error', 'Could not fetch buses. Please check network.');
                }
            }
        }

        function handleBusChange() {
            const selectedBusId = selectBus.value;
            selectSeats.innerHTML = '';

            if (selectedBusId) {
                const selectedBus = allBuses.find(b => String(b.BusId) === selectedBusId);
                if (selectedBus) {
                    const totalCapacity = selectedBus.Capacity;
                    const bookedSeats = selectedBus.BookedSeats || [];

                    for (let i = 1; i <= totalCapacity; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Seat ${i}`;
                        if (bookedSeats.includes(i)) {
                            option.disabled = true;
                            option.textContent += ' (Booked)';
                        }
                        selectSeats.appendChild(option);
                    }
                }
            }
        }
        
        function addTicket() {
            const selectedPassengerOptions = Array.from(selectPassengers.selectedOptions);
            const selectedSeatOptions = Array.from(selectSeats.selectedOptions);
            
            if (selectedPassengerOptions.length === 0) {
                showMsg('error', 'Please select at least one passenger.');
                return;
            }
            if (selectedSeatOptions.length === 0) {
                showMsg('error', 'Please select at least one seat.');
                return;
            }
            if (selectedPassengerOptions.length !== selectedSeatOptions.length) {
                showMsg('error', 'The number of selected passengers must match the number of selected seats.');
                return;
            }

            const routeId = selectRoute.value;
            const yatraId = selectYatra.value;
            const busId = selectBus.value;

            if (!routeId || !yatraId || !busId) {
                showMsg('error', 'Please select a route, yatra, and bus.');
                return;
            }

            const selectedYatra = allYatras.find(y => String(y.YatraId) === yatraId);
            const feePerPerson = selectedYatra ? selectedYatra.FeesPerPerson : 0;
            
            selectedPassengerOptions.forEach((passengerOption, index) => {
                const passengerId = passengerOption.value;
                const seatNumber = selectedSeatOptions[index].value;

                const alreadyAdded = addedTickets.some(ticket => 
                    String(ticket.registrationId) === passengerId && String(ticket.yatraId) === yatraId
                );

                if (alreadyAdded) {
                     console.warn(`Ticket for ${passengerOption.textContent} for this yatra already added. Skipping.`);
                     return;
                }

                const newTicket = {
                    registrationId: passengerId,
                    registrationName: passengerOption.textContent,
                    yatraId: yatraId,
                    yatraName: selectedYatra ? `${selectedYatra.YatraName} (${selectedYatra.YatraDate})` : 'N/A',
                    busId: busId,
                    busNumber: selectBus.options[selectBus.selectedIndex].textContent.split(' ')[0],
                    seats: [seatNumber],
                    fee: feePerPerson
                };
                addedTickets.push(newTicket);
            });
            
            renderAddedTickets();
            calculateTotalFees();
            
            selectSeats.selectedIndex = -1;
            selectPassengers.selectedIndex = -1;
        }

        function renderAddedTickets() {
            addedTicketsList.innerHTML = '';
            if (addedTickets.length === 0) {
                addedTicketsList.innerHTML = '<li class="list-group-item text-center text-muted py-4">No tickets added yet.</li>';
                return;
            }

            addedTickets.forEach((ticket, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                        <div class="yatra-summary">
                            <strong>${ticket.registrationName}</strong> - ${ticket.yatraName}<br>
                            Bus ${ticket.busNumber}, Seat: ${ticket.seats.join(', ')}<br>
                            Fee: <strong>₹${ticket.fee}</strong>
                        </div>
                        <div class="yatra-item-actions">
                            <button class="btn btn-sm btn-danger remove-ticket-btn" data-index="${index}">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    `;
                addedTicketsList.appendChild(li);
            });

            document.querySelectorAll('.remove-ticket-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.currentTarget.dataset.index);
                    addedTickets.splice(indexToRemove, 1);
                    renderAddedTickets();
                    calculateTotalFees();
                });
            });
        }

        function calculateTotalFees() {
            const total = addedTickets.reduce((sum, ticket) => sum + ticket.fee, 0);
            totalFeesInput.value = total.toFixed(2);
            updateFinalAmount();
        }

        function updateFinalAmount() {
            const total = parseFloat(totalFeesInput.value || '0');
            let discount = parseFloat(discountInput.value || '0');

            if (discount > total) {
                discount = total;
                discountInput.value = total.toFixed(2);
                showMsg('warning', "Discount cannot exceed total fees. Discount adjusted to total fees.");
            }
        }

        function handlePaymentModeChange() {
            if (paymentModeSelect.value === 'upi') {
                upiFieldsDiv.classList.remove('d-none');
                document.getElementById('upiScreenshot').required = true;
                document.getElementById('transactionId').required = true;
            } else {
                upiFieldsDiv.classList.add('d-none');
                document.getElementById('upiScreenshot').required = false;
                document.getElementById('transactionId').required = false;
            }
            updateFinalAmount();
        }

        async function submitBooking() {
            if (addedTickets.length === 0) {
                showMsg('error', 'Please add at least one ticket before submitting.');
                return;
            }
            const totalAmount = parseFloat(totalFeesInput.value || '0');
            const discount = parseFloat(discountInput.value || '0');
            const paymentMode = paymentModeSelect.value;
            const discountReason = discountReasonInput.value.trim();
            const transactionId = document.getElementById('transactionId').value.trim();
            const upiScreenshot = document.getElementById('upiScreenshot').files[0];

            if (!paymentMode) {
                showMsg('error', 'Please select a payment mode.');
                return;
            }
            if (paymentMode === 'upi' && (!transactionId || !upiScreenshot)) {
                showMsg('error', 'Please enter UPI Transaction ID and upload a screenshot.');
                return;
            }

            const bookingsPayload = addedTickets.map(ticket => ({
                RegistrationId: ticket.registrationId,
                YatraIds: ticket.yatraId,
                Seats: ticket.seats.join(','),
                BusId: ticket.busId,
            }));

            const fd = new FormData();
            fd.append('action', 'book_ticket');
            fd.append('UserId', "{{ request.session.user_id }}");
            fd.append('AmountPaid', (totalAmount - discount).toFixed(2));
            fd.append('Discount', discount.toFixed(2));
            fd.append('DiscountReason', discountReason);
            fd.append('PaymentMode', paymentMode);
            fd.append('TransactionId', transactionId);
            if (upiScreenshot) {
                fd.append('UPIScreenshot', upiScreenshot);
            }
            fd.append('Bookings', JSON.stringify(bookingsPayload));

            try {
                const res = await postForm('book_ticket', fd, true);
                if (String(res.message_code) === "1000") {
                    showMsg('success', res.message_text || 'Tickets booked successfully!');
                    addedTickets = [];
                    renderAddedTickets();
                    calculateTotalFees();
                    if (validMobile(searchMobileInput.value.trim())) {
                        RegistrationDisplay.fetchBookingHistory();
                    }
                } else {
                    showMsg('error', res.message_text || 'Failed to book tickets.');
                }
            } catch (err) {
                console.error("Booking failed:", err);
                showMsg('error', `An error occurred during booking: ${err.message}`);
            }
        }

        return {
            loadAllRoutesYatras, handleRouteChange, handleYatraChange, handleBusChange,
            addTicket, updateFinalAmount, handlePaymentModeChange, submitBooking
        };
    })();

    document.addEventListener('DOMContentLoaded', async () => {
        RegistrationDisplay.populateHistoryYears();
        sessionStorage.removeItem('lastSearchMobile');
        searchMobileInput.value = '';
        labelMobile.textContent = '';
        regItemsList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Search a mobile number to see registrations.</li>';
        bookingHistoryList.innerHTML = '<li class="list-group-item text-center text-muted py-4">Select filters to view history.</li>';
        Booking.renderAddedTickets();
        Booking.calculateTotalFees();
    });

    btnSearch.addEventListener('click', () => RegistrationDisplay.doSearch(true));
    searchMobileInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') RegistrationDisplay.doSearch(true); });
    btnAddNew.addEventListener('click', () => {
        const mob = searchMobileInput.value.trim();
        if (!validMobile(mob)) {
            showMsg('error', "Please enter a valid 10-digit mobile number in the search box first.");
            searchMobileInput.focus();
            return;
        }
        RegistrationForm.openForm('insert', null, mob);
    });
    regForm.addEventListener('submit', RegistrationForm.handleSubmit);

    historyYearSelect.addEventListener('change', RegistrationDisplay.fetchBookingHistory);
    historyPassengerSelect.addEventListener('change', RegistrationDisplay.fetchBookingHistory);

    btnRegNext.addEventListener('click', () => { new bootstrap.Tab(document.getElementById('booking-tab')).show(); });

    bookingTabButton.addEventListener('shown.bs.tab', () => {
        Booking.loadAllRoutesYatras();
        populatePassengerBookingDropdown(currentRegistrations);
    });

    selectRoute.addEventListener('change', Booking.handleRouteChange);
    selectYatra.addEventListener('change', Booking.handleYatraChange);
    selectBus.addEventListener('change', Booking.handleBusChange);
    btnAddTicket.addEventListener('click', Booking.addTicket);
    discountInput.addEventListener('input', Booking.updateFinalAmount);
    paymentModeSelect.addEventListener('change', Booking.handlePaymentModeChange);
    submitBookingBtn.addEventListener('click', Booking.submitBooking);

</script>
</body>
</html>