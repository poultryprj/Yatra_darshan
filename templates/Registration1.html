{% load i18n %}
{% load static %}
{% load pwa %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yatra Darshan - Registration</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="manifest" href="{% static 'assets/__manifest.json' %}">

  <style>
    /* palette & base */
    :root{
      --brand-orange: #ff7b00;
      --brand-orange-dark: #e67000;
      --brand-blue: #003399;
      --brand-green: #006633;
    }
    body{ background:#f0f2f5; font-family: Arial, sans-serif; margin:0; padding:0; }

    /* top navbar */
    .navbar{ background:var(--brand-orange); height:55px; }
    .navbar-brand{ color:#fff; font-weight:600; font-size:18px; }
    .navbar-toggler{ border:none; background:#fff; border-radius:6px; padding:6px 8px; }

    /* drawer */
    .drawer{ position:fixed; top:55px; left:-100%; width:68%; height:calc(100% - 55px); background:#fff; transition:left .28s; z-index:1100; box-shadow:2px 0 8px rgba(0,0,0,.08); overflow:auto; }
    .drawer.open{ left:0; }
    .drawer .additional-content{ padding:12px; text-align:center; background:#f8f9fb; position:sticky; top:0; }
    .drawer ul{ padding:12px; }
    .drawer ul li{ list-style:none; margin-bottom:6px; }

    /* main container card */
    .container-reg{ max-width:980px; margin:84px auto 40px; padding:0 12px; }
    .card-main{ border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); overflow:hidden; }

    /* row with search + add (single-line) */
    .search-row{ padding:18px; display:flex; gap:10px; align-items:center; background:#fff; }
    .search-grow{ flex:1; position:relative; }
    .search-icon-btn{
      position:absolute; right:6px; top:50%; transform:translateY(-50%);
      border-radius:6px; border:none; background:var(--brand-orange); color:#fff; width:40px; height:40px;
      display:flex; align-items:center; justify-content:center;
    }
    .search-icon-btn:hover{ background:var(--brand-orange-dark); }

    /* small Add button: same height as search icon */
    .small-add{
      width:40px; height:40px; border-radius:8px; border:none; display:flex; align-items:center; justify-content:center;
      background:#198754; color:#fff; flex:0 0 auto;
    }
    .small-add:hover{ background:#146c43; }

    /* list area */
    .results-area{ padding:12px 18px 24px 18px; background:#fff; }
    .listview .list-group-item{ border:0; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0; cursor:pointer; }
    .listview .list-group-item:hover{ background:#fbfbff; }

    /* single-line user details (exclude mobile) */
    .item-left{ display:flex; gap:12px; align-items:center; }
    .item-reg{ font-weight:600; color:var(--brand-blue); min-width:90px; }
    .item-name{ font-weight:600; color:#333; }
    .item-meta{ color:#6c757d; font-size:0.9rem; }

    .item-right{ text-align:right; color:#6c757d; font-size:0.88rem; min-width:120px; }

    /* floating animated inputs for the action bottom sheet */
    /* floating label system */
    .floating {
    position: relative;
    margin-top: 16px;
    }
    .floating input,
        .floating select {
        width: 100%;
        padding: 14px 12px 12px 12px;
        border: none;
        border-bottom: 1px solid #ccc;
        border-radius: 0;
        background: transparent;
        outline: none;
        font-size: 15px;
    }
    .floating label {
        position: absolute;
        left: 12px;
        top: 12px;
        font-size: 14px;
        color: #6c757d;
        pointer-events: none;
        transition: all 0.2s ease;
    }
    /* ðŸ”¥ move label up when focused or input has text */
        .floating input:focus + label,
        .floating input:not(:placeholder-shown) + label,
        .floating select:focus + label,
        .floating select:not([value=""]) + label {
        top: -6px;
        font-size: 12px;
        color: var(--brand-green);
        background: #fff;
        padding: 0 4px;
    }

    /* bottom sheet submit button */
    .btn-submit{ background:var(--brand-orange); color:#fff; border:none; border-radius:10px; padding:12px; }
    .btn-submit:hover{ background:var(--brand-orange-dark); }

    /* offcanvas (bottom) header */
    .offcanvas-bottom .offcanvas-header{ background:var(--brand-orange);Â color:#fff;Â }
    {% comment %} .offcanvas-bottom .offcanvas-header{ background:var(--brand-blue); color:#fff; } {% endcomment %}
    .offcanvas-bottom .offcanvas-body{ padding:16px; background:#fff; }

    /* responsive tweaks */
    @media (max-width:520px){
      .container-reg{ margin:72px 8px 20px; }
      .item-right{ min-width:80px; font-size:0.8rem; }
    }

    /* search box same size as icon */
    .search-grow input {
    width: 220px;
    height: 40px;
    border: 1px solid #ccc;
    text-align: center;
    }

    .item-line {
        font-size: 14px;
        white-space: nowrap;  /* keeps everything on one line */
    }

    .card-body { padding: 1rem; }
    #yatraList .card { margin-bottom: 8px; 
    }

    .btn-submit{ background:var(--brand-orange); color:#fff; border:none; border-radius:10px; padding:12px; }
    .btn-submit:hover{ background:var(--brand-orange-dark);Â }

    #loader {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 99999;
      background: #6236FF;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    #loader .loading-icon {
      width: 42px;
      height: auto;
      animation: loadingAnimation 0.5s ease-in-out infinite;
    }

    #loader.hidden {
      display: none;
    }

    @keyframes loadingAnimation {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(180deg);
      }
    }


    body.animationGoBack {
      overflow: hidden;
    }

    body.animationGoBack .appHeader,
    body.animationGoBack .appBottomMenu,
    body.animationGoBack .extraHeader,
    body.animationGoBack #appCapsule {
      transform: translate(100%, 0);
      transition: all .24s linear;
    }

    body.animationGoBack:after {
      content: "";
      display: block;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 100%;
      background-color: #6236FF;
      background-image: url("../img/loading-icon.png");
      background-repeat: no-repeat;
      background-size: 42px auto;
      background-position: center center;
      z-index: 9999;
      animation: animationGoBack .24s linear;
    }

    @keyframes animationGoBack {
      0% {
        left: -100%;
      }
      100% {
        left: 0;
      }
    }
    .back-btn { font-size: 1.75rem; color: white; text-decoration: none; }

  </style>
</head>
<body>
  <!-- loader -->
  <div id="loader"style="display: none;">
      <img src="{% static 'assets/img/loading-icon.png' %}" alt="icon" class="loading-icon">
  </div>

<!-- Topbar -->
<nav class="navbar fixed-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="{% url 'home' %}" class="back-btn"><i class="bi bi-arrow-left-circle-fill"></i></a>
        <span class="navbar-brand mb-0 h1" style="color:white">Registration Page</span>
        <span style="width: 30px;"></span>
    </div>
</nav>


{% comment %}
<!-- Side Drawer -->
<div id="drawer" class="drawer">
  <div class="additional-content">
    <img src="{% static 'assets/img/lakshya_pratishthan.png' %}" width="92" height="92" class="rounded-circle" alt="logo">
    <div style="margin-top:8px;"><b style="color:#000;">Darshan Yatra</b></div>
    <button onclick="closeDrawer()" class="btn btn-sm position-absolute" style="right:8px; top:8px;"><i class="bi bi-x-lg"></i></button>
  </div>
  {% comment %} <ul>
    <li><a href="{% url 'Registrationpage1' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-house-door me-2"></i> Home</a>
    </li>

    <li><a href="{% url 'dashboard' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-grid-1x2-fill me-2"></i> Dashboard</a>
    </li>

    <li><a href="{% url 'user_master' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-people-fill me-2"></i> User Management</a>
    </li>

    <li><a href="{% url 'route_master' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-geo-alt-fill me-2"></i> Route Master</a>
    </li>

    <li><a href="{% url 'area_master' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-map-fill me-2"></i> Area Master</a>
    </li>

    <li><a href="{% url 'yatra_master' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-calendar-event-fill me-2"></i> Yatra Master</a>
    </li>

    <li><a href="{% url 'daily_report' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-cash-coin me-2"></i> Daily Collection</a>
    </li>

    <li><a href="{% url 'print_report_page' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-printer-fill me-2"></i> Print Report</a>
    </li>

    <li><a href="{% url 'logout' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-box-arrow-right me-2"></i> Logout</a>
    </li>
</ul> {% endcomment %}
{% comment %}
<ul>
    <li>
        <a href="{% url 'Registrationpage1' %}" class="text-decoration-none text-dark d-block py-2">
            <i class="bi bi-house-door me-2"></i> Home
        </a>
    </li>

    <li>
        <a href="{% url 'dashboard' %}" class="text-decoration-none text-dark d-block py-2">
            <i class="bi bi-grid-1x2-fill me-2"></i> Dashboard
        </a>
    </li>

    {# âœ… Show these menus only if user_role != 2 #}
    {% if request.session.user_role != "2" %}
        <li>
            <a href="{% url 'user_master' %}" class="text-decoration-none text-dark d-block py-2">
                <i class="bi bi-people-fill me-2"></i> User Management
            </a>
        </li>

        <li>
            <a href="{% url 'route_master' %}" class="text-decoration-none text-dark d-block py-2">
                <i class="bi bi-geo-alt-fill me-2"></i> Route Master
            </a>
        </li>

        <li>
            <a href="{% url 'area_master' %}" class="text-decoration-none text-dark d-block py-2">
                <i class="bi bi-map-fill me-2"></i> Area Master
            </a>
        </li>

        <li>
            <a href="{% url 'yatra_master' %}" class="text-decoration-none text-dark d-block py-2">
                <i class="bi bi-calendar-event-fill me-2"></i> Yatra Master
            </a>
        </li>
    {% endif %}

    <li>
        <a href="{% url 'daily_report' %}" class="text-decoration-none text-dark d-block py-2">
            <i class="bi bi-cash-coin me-2"></i> Daily Collection
        </a>
    </li>

    <li>
        <a href="{% url 'print_report_page' %}" class="text-decoration-none text-dark d-block py-2">
            <i class="bi bi-printer-fill me-2"></i> Print Report
        </a>
    </li>

    <li>
        <a href="{% url 'passenger_documents' %}" class="text-decoration-none text-dark d-block py-2">
            <i class="bi bi-person-badge me-2"></i> Passenger Docs
        </a>
    </li>

    <li>
      <a href="{% url 'area_report' %}" class="text-decoration-none text-dark d-block py-2"><i class="bi bi-pin-map-fill me-2"></i> Area Report</a>
    </li>

    <li>
      <a href="{% url 'whatsapp_messaging_page' %}" class="text-decoration-none text-dark d-block py-2">
        <i class="bi bi-whatsapp me-2"></i> WhatsApp SMS
      </a>
    </li>

    <li>
        <a href="{% url 'logout' %}" class="text-decoration-none text-dark d-block py-2">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
        </a>
    </li>
</ul>
{% endcomment %}


</div>

<!-- main content -->
<div class="container-reg">

  <!-- Row with 3 count inputs -->
  <!-- Row with 3 count inputs -->
<div class="row mb-2 align-items-center">
  <!-- Label -->
  <div class="col-auto">
    <label for="Count1" class="col-form-label fw-bold">Group Count</label>
  </div>

  <!-- 3 inputs -->
  <div class="col">
    <div class="d-flex gap-2">
      <input id="Count1" type="number" class="form-control" value="1">
      <input id="Count2" type="number" class="form-control" value="1" >
      <input id="Count3" type="number" class="form-control" value="1" >
    </div>
    <!-- âœ… Message area below inputs -->
    <div id="countMessage" class="mt-2 text-danger fw-bold"></div>
  </div>
</div>



  <div class="card-main">

    <!-- search + add -->
    <div class="search-row">
        <div class="search-grow">
            <input id="searchMobile" type="tel" maxlength="10" 
                placeholder="Mobile Number" autocomplete="off"
                style="text-align:left; padding-left:10px; height:40px; border:1px solid #ccc; border-radius:6px;" />
            <button id="btnSearch" class="search-icon-btn" title="Search">
                <i class="bi bi-search"></i>
            </button>
        </div>

      <!-- small add icon (same size as search) - placed inline -->
      <button id="btnAddNew" class="small-add" title="Add new registration for same mobile">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>

    <!-- status -->
    <div id="statusMsg" class="px-3 py-2 d-none"></div>

    <!-- results box -->
    <div id="resultsWrap" class="results-area d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Registrations for <strong id="labelMobile"></strong></div>
        <div><span id="resultCount" class="badge bg-secondary">0</span></div>
      </div>

      <div id="regList" class="listview">
        <ul id="regItems" class="list-group list-group-flush"></ul>
      </div>
    </div>

    <!-- Second Part: Selected Yatras + Payment Details -->
    <div id="yatraPaymentSection" class="results-area mt-3 d-none">
      <!-- Selected Yatras -->
      <div class="mb-2" style="font-weight:600; color:#333;">Selected Yatras</div>
      <div id="selectedYatras" class="list-group mb-3"></div>

      <!-- Payment Details -->
      <div class="mb-2" style="font-weight:600; color:#333;">Payment Details</div>

      <!-- Amount Payable -->
      <div class="floating">
        <input id="AmountPayable" type="number" placeholder=" " min="0">
        <label>Amount Payable (â‚¹)</label>
      </div>

      <!-- Discount -->
      <div class="floating mt-2">
        <input id="Discount" type="number" placeholder=" " min="0">
        <label>Discount (â‚¹)</label>
      </div>

      <!-- Discount Reason -->
      <div class="floating mt-2">
        <input id="DiscountReason" type="text" placeholder=" ">
        <label>Discount Reason</label>
      </div>

      <!-- Payment Mode -->
      <div class="floating mt-2">
        <select id="PaymentMode" placeholder=" " required >
          <option value="">Select Payment Mode*</option>
          <option value="cash">Cash</option>
          <option value="upi">UPI</option>
        </select>
        <label>Payment Mode</label>
      </div>

      <!-- Conditional UPI Fields -->
      <div id="upiFields" class="d-none mt-2">
        <div class="floating">
          <input id="TransactionId" type="text" placeholder=" ">
          <label>UPI Transaction ID</label>
        </div>
        <div class="mt-2">
          <label class="form-label">Upload UPI Screenshot*</label>
          <input id="UPIScreenshot" type="file" class="form-control" accept="image/*,.pdf" required >
        </div>
      </div>

      <div class="mt-3 d-grid">
        {% comment %} <button id="btnBookTicket" type="button" class="btn btn-primary"> {% endcomment %}
        <button id="btnBookTicket" type="button" class="btn btn-submit">  
          <i class="bi bi-ticket-perforated-fill me-1"></i> Book Ticket
        </button>
      </div>
    </div>
  </div>
</div>

<!-- bottom action sheet (offcanvas bottom) -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="regActionBar" aria-labelledby="regActionBarLabel" style="height:fit-content; --bs-offcanvas-height: 64vh;">
  <div class="offcanvas-header">
    <h5 id="regActionBarLabel" class="offcanvas-title">Pilgrim Registration</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="regForm" autocomplete="off">
      <input id="RegistrationId" type="hidden" value="0">

      <!-- Row 1: Mobile + Alternate Mobile -->
      <div class="d-flex gap-2">
        <div class="floating" style="flex:1">
            <input id="MobileNo" type="tel" placeholder=" " maxlength="10" required>
            <label>Mobile No. *</label>
        </div>
        <div class="floating" style="flex:1">
            <input id="AlternateMobileNo" type="tel" placeholder=" " maxlength="10">
            <label>Alternate Mobile</label>
        </div>
      </div>

      <!-- Row 2: First Name + Middle Name -->
      <div class="d-flex gap-2 mt-2">
        <div class="floating" style="flex:1">
            <input id="Firstname" type="text" placeholder=" " required>
            <label>First Name *</label>
        </div>
        <div class="floating" style="flex:1">
            <input id="Middlename" type="text" placeholder=" " required>
            <label>Middle Name *</label>
        </div>
      </div>

      <!-- Row 3: Last Name + Area -->
      <div class="d-flex gap-2 mt-2">
        <div class="floating" style="flex:1">
            <input id="Lastname" type="text" placeholder=" " required>
            <label>Last Name *</label>
        </div>
        <div class="floating" style="flex:1">
          <select id="AreaId" placeholder=" " required><option value="">Select Area</option></select>
          <label>Area *</label>
        </div>
      </div>

      <!-- Row 4: Address -->
      <div class="d-flex gap-2 mt-2">
        <div class="floating" style="flex:1">
          <input id="Address" type="text" placeholder=" " required>
          <label>Address *</label>
        </div>
        {% comment %} <!-- Zone Preference -->
        <div class="floating" style="flex:1">
          <select id="ZonePreference" placeholder=" ">
            <option value="0" selected>No Preference</option>
            <option value="1">Front</option>
            <option value="2">Middle</option>
            <option value="3">Back</option>
          </select>
          <label>Zone Preference</label>
        </div> {% endcomment %}
      </div> 

      <!-- Fields to show only in INSERT mode -->
      <div id="insertOnlyFields">
        <div class="d-flex gap-2 mt-2">
          <div class="floating" style="flex:1">
            <select id="Gender" placeholder=" "><option value="">Select Gender</option></select>
            <label>Gender</label>
          </div>
          <div class="floating" style="flex:1">
            <select id="BloodGroup" placeholder=" "><option value="">Select Blood Group</option></select>
            <label>Blood Group</label>
          </div>
        </div>

        <div class="d-flex gap-2 mt-2">
          <div class="floating" style="flex:1">
            <input id="DateOfBirth" type="date" placeholder=" ">
            <label>Date of Birth</label>
          </div>
          <div class="floating" style="flex:1">
            <input id="AadharNumber" type="text" placeholder=" " maxlength="12">
            <label>Aadhar No.</label>
          </div>
        </div>
      </div>

    <div class="d-flex gap-2 mt-1">
      <div class="floating" style="flex:1">
        <input id="AadharUpload" type="file" accept="image/*,.pdf">
        <label>Aadhar Upload</label>
      </div>
      <div class="floating" style="flex:1">
        <input id="ProfilePicUpload" type="file" accept="image/*,.pdf">
        <label>Profile Picture Upload</label>
      </div>
    </div>

    <!-- Voter Id Upload -->
    <div class="d-flex gap-2 mt-1">
      <div class="floating" style="flex:1">
        <input type="file" id="VoterIdUpload" name="VoterIdUpload" accept="image/*,.pdf">
        <label>Voter Id Upload</label>
      </div>
    </div>

    <!-- ðŸ”¥ Hidden fields to hold old image URLs during update -->
    <input type="hidden" id="PhotoFileName" name="PhotoFileName" value="">
    <input type="hidden" id="IdProofFileName" name="IdProofFileName" value="">
    <input type="hidden" id="VoterId" name="VoterId" value="">

      <div class="mt-3 d-grid">
        <button id="btnSubmit" type="submit" class="btn-submit"><i class="bi bi-check2-circle me-1"></i> Submit</button>
      </div>

      <div class="card mt-3">
        {% comment %} <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Select Yatras</h6>
        </div> {% endcomment %}
        <div id="yatraSection" class="card-body d-none">
          <div id="yatraList"></div>
          <div class="mt-3 d-flex justify-content-between align-items-center">
            <strong>Total Fees: â‚¹<span id="totalFee">0</span></strong>
            <button id="btnAddYatra" type="button" class="btn btn-submit">
              <i class="bi bi-plus-circle"></i> Add Yatra
            </button>
          </div>
        </div>
      </div>

      <div class="text-muted small mt-2" id="formModeHint" style="display:none;">Mode: Insert</div>    
    </form>
<!-- scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // drawer
  const menuBtn = document.getElementById('menuBtn'), drawer = document.getElementById('drawer');
  menuBtn.addEventListener('click', ()=> drawer.classList.add('open'));
  function closeDrawer(){ drawer.classList.remove('open'); }
  window.addEventListener('click', (e)=> { if (!drawer.contains(e.target) && !menuBtn.contains(e.target)) closeDrawer(); });

  // helpers
  const statusBox = document.getElementById('statusMsg');
  function showMsg(type, text){
    statusBox.className = 'px-3 py-2'; // reset
    if (type === 'success') {
        statusBox.classList.add('alert', 'alert-success');
    } else {
        statusBox.classList.add('alert', 'alert-danger');
    }
    statusBox.textContent = text;
    statusBox.classList.remove('d-none');
  }
  function hideMsg(){ statusBox.classList.add('d-none'); statusBox.textContent=''; }

  function postForm(action, data={}){
    const fd = new FormData();
    fd.append('action', action);
    for (const k in data) fd.append(k, data[k]);
    return fetch("{% url 'registration_api1' %}", { method:'POST', body: fd }).then(r=> r.json());
  }

  // elements
  const inputMobile = document.getElementById('searchMobile');
  const btnSearch = document.getElementById('btnSearch');
  const btnAddNew = document.getElementById('btnAddNew');
  const resultsWrap = document.getElementById('resultsWrap');
  const regItems = document.getElementById('regItems');
  const labelMobile = document.getElementById('labelMobile');
  const resultCount = document.getElementById('resultCount');

  function validMobile(m){ return /^\d{10}$/.test(m); }

  // btnSearch.addEventListener('click', doSearch);
  btnSearch.addEventListener('click', () => {
    console.log("Clearing local storage before search...");

    // Clear all local storage
    localStorage.clear();

    // Optional: if using sessionStorage too
    // sessionStorage.clear();

    console.log("Local storage after clear:", localStorage);

    // Run your search
    doSearch();
  });

  
  inputMobile.addEventListener('keydown', function(e){ if (e.key==='Enter') doSearch(); });

  async function doSearch(){
    // localStorage.clear();
    // console.log("All localStorage cleared on page reload!");

    // hideMsg();
    setTimeout(() => {
      hideMsg();
    }, 2000);
    
    const mob = inputMobile.value.trim();
    if (!validMobile(mob)){ showMsg('error','Please enter a valid 10-digit mobile number.'); return; }
    try {
      const resp = await postForm('search_list', { search: mob });
      if (resp.message_code == 1000 && Array.isArray(resp.message_data)){
        // Store search results for later use
        sessionStorage.setItem('lastSearchResults', JSON.stringify(resp.message_data));
        renderList(resp.message_data, mob);
        //showMsg('success','Registrations fetched.');
      } else {
        sessionStorage.setItem('lastSearchResults', JSON.stringify([]));
        renderList([], mob);
        showMsg('error', resp.message_text || 'No records found.');
      }
          } catch (err){
      console.error(err);
      showMsg('error','Search failed.');
    }
  }

  function renderList(rows, mob){
    labelMobile.textContent = mob;
    resultsWrap.classList.remove('d-none');
    regItems.innerHTML = '';
    resultCount.textContent = rows.length;

    // âœ… Show Selected Yatras + Payment section only when there are search results
    const yatraPaymentSection = document.getElementById('yatraPaymentSection');
    yatraPaymentSection.classList.remove('d-none');

    if (!rows.length){
      regItems.innerHTML = '<li class="list-group-item text-center text-muted py-4">No records found.</li>';
      
      // Show empty yatras when no users found
      renderSelectedYatras([], mob);
      return;
    }
    
    rows.forEach(r => {
        const li = document.createElement('li');
        li.className = 'list-group-item';

        const regId = r.RegistrationId || '';
        const fullName = [r.Firstname, r.Middlename, r.Lastname].filter(Boolean).join(" ");
        const area = r.AreaName || '-';
        const gender = r.GenderName || '-';

        // li.innerHTML = `
        //    <div class="item-line">
        //    ${regId}&nbsp;&nbsp;${fullName}, ${area}, ${gender}
        //    </div>
        // `;
        
        li.innerHTML = `
          <div class="item-line">
            <strong>${fullName}</strong>, ${area}
          </div>
        `;

        li.addEventListener('click', () => openActionSheet('update', r, mob));
        regItems.appendChild(li);
    });
    
    // ðŸ”¥ Pass search results to renderSelectedYatras to show only relevant users' yatras
    renderSelectedYatras(rows, mob);
  }

  // action bottom sheet
  const offcanvasEl = document.getElementById('regActionBar'), offcanvas = new bootstrap.Offcanvas(offcanvasEl);

  offcanvasEl.addEventListener('hidden.bs.offcanvas', function() {
    // Update selected yatras display when the registration form is closed
    const currentSearchResults = JSON.parse(sessionStorage.getItem('lastSearchResults') || '[]');
    const searchMobile = inputMobile.value.trim();
    renderSelectedYatras(currentSearchResults, searchMobile);
  });

  const regForm = document.getElementById('regForm'), modeHint = document.getElementById('formModeHint');

  async function loadDropdowns(){
    const [a,g,b] = await Promise.all([ postForm('list_area'), postForm('list_gender'), postForm('list_bloodgroup') ]);
    const areaSel = document.getElementById('AreaId'), genderSel = document.getElementById('Gender'), bloodSel = document.getElementById('BloodGroup');
    function fill(sel, res, vKey, tKey){
      sel.innerHTML = '<option value="">Select</option>';
      if (res && res.message_code == 1000 && Array.isArray(res.message_data)){
        res.message_data.forEach(it=> {
          const o = document.createElement('option'); o.value = it[vKey] || it[tKey] || ''; o.textContent = it[tKey];
          sel.appendChild(o);
        });
      }
    }
    fill(areaSel, a, 'AreaId', 'AreaName');
    fill(genderSel, g, 'GenderId', 'GenderName');
    fill(bloodSel, b, 'BloodGroupId', 'BloodGroupName');
  }

  async function openActionSheet(mode, row, mob){
    // reset form
    regForm.reset();

    // ðŸ”¥ CRITICAL FIX: Always reset RegistrationId to 0 for insert mode
     if (mode === 'insert') {
        document.getElementById('RegistrationId').value = '0';
        
        // ðŸ”¥ NEW FIX: Clear hidden fields for insert mode
        document.getElementById("PhotoFileName").value = "";
        document.getElementById("IdProofFileName").value = "";
        document.getElementById("VoterId").value = "";

      // ðŸ”¥ NEW FIX: Clear any existing yatra selections for new user
        const userId = getCurrentUserId(); // This will be "0" for new users
        const allUsersYatras = getAllUsersYatras();
        if (allUsersYatras[userId]) {
            delete allUsersYatras[userId]; // Remove any existing data for "0" key
            saveAllUsersYatras(allUsersYatras);
        }  
    }

    // open Bootstrap offcanvas (bottom sheet)
    offcanvas.show();

    // update heading
    document.getElementById('regActionBarLabel').textContent =
        mode === 'insert' ? 'Add New Registration' : 'Update Registration';
    modeHint.textContent = "Mode: " + (mode === 'insert' ? "Insert" : "Update");

    if (mode === 'insert' && mob) {
      document.getElementById('MobileNo').value = mob;
    } else if (mode === 'insert') {
        document.getElementById('MobileNo').value = ''; // Clear mobile for fresh registration
    }

    // Show/hide fields based on mode
    const insertOnlyFields = document.getElementById('insertOnlyFields');
    if (mode === 'insert') {
      insertOnlyFields.style.display = 'block';
    } else {
      insertOnlyFields.style.display = 'none';
    }

    // load dropdowns (Area, Gender, Blood Group)
    try {
        const [areas, genders, bloodgroups] = await Promise.all([
        postForm('list_area'),
        postForm('list_gender'),
        postForm('list_bloodgroup')
        ]);

        const areaSel = document.getElementById('AreaId');
        const genderSel = document.getElementById('Gender');
        const bloodSel = document.getElementById('BloodGroup');

        // fill Area
        areaSel.innerHTML = '<option value="">Select Area</option>';
        if (areas?.message_code === 1000) {
        areas.message_data.forEach(it => {
            const o = document.createElement('option');
            o.value = it.AreaId;
            o.textContent = it.AreaName;
            areaSel.appendChild(o);
        });
        }

        // fill Gender (only Male & Female) with Female as default for insert
        genderSel.innerHTML = '<option value="">Select Gender</option>';
        if (genders?.message_code === 1000) {
          let femaleValue = null;
          genders.message_data
              .filter(it => it.GenderName === "Male" || it.GenderName === "Female")
              .forEach(it => {
              const o = document.createElement('option');
              o.value = it.GenderId;  // ðŸ”¥ Use GenderId, not GenderName
              o.textContent = it.GenderName;
              if (it.GenderName === "Female") {
                femaleValue = o.value;
              }
              genderSel.appendChild(o);
              });
          
          // Set Female as default for insert mode
          if (mode === 'insert' && femaleValue) {
            genderSel.value = femaleValue;
          }
        }

        // fill Blood Group
        bloodSel.innerHTML = '<option value="">Select Blood Group</option>';
        if (bloodgroups?.message_code === 1000) {
        bloodgroups.message_data.forEach(it => {
            const o = document.createElement('option');
            o.value = it.BloodGroupId;  // ðŸ”¥ Use BloodGroupId
            o.textContent = it.BloodGroupName;
            bloodSel.appendChild(o);
        });
        }

        // ðŸ”¥ POPULATE FIELDS FOR UPDATE MODE
        if (mode === 'update' && row) {
          console.log("Populating update mode with row:", row);  // Debug log
          
          document.getElementById('RegistrationId').value = row.RegistrationId || '';
          document.getElementById('Firstname').value = row.Firstname || '';
          document.getElementById('Middlename').value = row.Middlename || '';
          document.getElementById('Lastname').value = row.Lastname || '';
          document.getElementById('MobileNo').value = row.MobileNo || mob || '';
          document.getElementById('AlternateMobileNo').value = row.AlternateMobileNo || '';
          document.getElementById('Address').value = row.Address || '';
          document.getElementById('AadharNumber').value = row.AadharNumber || '';
          // ðŸ”¥ ONLY populate hidden fields in UPDATE mode
          document.getElementById("PhotoFileName").value = row.PhotoFileName || "";
          document.getElementById("IdProofFileName").value = row.IdProofFileName || "";
          document.getElementById("VoterId").value = row.VoterIdProof || "";
          console.log("875",row);

          // Set dropdown values after options are loaded
          setTimeout(() => {
            if (row.AreaId) {
              console.log("Setting AreaId:", row.AreaId);
              areaSel.value = row.AreaId;
            }
            
            if (row.GenderId) {
              console.log("Setting GenderId:", row.GenderId);
              genderSel.value = row.GenderId;
            }
            
            if (row.BloodGroupId) {
              console.log("Setting BloodGroupId:", row.BloodGroupId);
              bloodSel.value = row.BloodGroupId;
            }
          }, 100);

          // ðŸ”¥ DateOfBirth comes as "dd-mm-yyyy" â†’ convert to yyyy-mm-dd
          if (row.DateOfBirth && row.DateOfBirth !== "") {
              const parts = row.DateOfBirth.split("-");
              if (parts.length === 3) {
                  const formatted = `${parts[2]}-${parts[1]}-${parts[0]}`; 
                  document.getElementById('DateOfBirth').value = formatted;
              }
          }
        }

    } catch (err) {
        console.error("Error loading dropdowns:", err);
    }
  }
  
    function setDropdownValue(select, value) {
      if (!value) return;
      [...select.options].forEach(opt => {
          if (opt.value == value) opt.selected = true;
      });
    }

  // add new click (small icon)
  btnAddNew.addEventListener('click', ()=>{
    const mob = inputMobile.value.trim();

      // ðŸ”¥ Check if mobile is empty
    if (!mob) {
      alert("Please enter mobile number in search box for new registration.");
      inputMobile.focus();
      return; // stop here
    }

    // ðŸ”¥ Check if mobile is not valid 10 digits
    if (!validMobile(mob)) {
      alert("Please enter a valid 10-digit mobile number before adding new registration.");
      inputMobile.focus();
      return;
    }

    // Only pass mobile if it's valid, otherwise pass null for fresh registration
    const mobileToPass = validMobile(mob) ? mob : null;
    openActionSheet('insert', null, mobileToPass);
  });

  // submit handler
  regForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  // âœ… Validate required fields
  const requiredFields = ['MobileNo', 'Firstname', 'Middlename', 'Lastname', 'AreaId', 'Address'];
  for (const fieldId of requiredFields) {
    const field = document.getElementById(fieldId);
    if (!field.value.trim()) {
      const fieldName = field.previousElementSibling.textContent.replace(' *', '');
      alert(`Please fill ${fieldName}`);
      field.focus();
      return;
    }
  }

  const mob = document.getElementById('MobileNo').value.trim();
  if (!validMobile(mob)) {
    alert('Mobile must be 10 digits');
    return;
  }

  const RegistrationId = document.getElementById('RegistrationId').value || '0';
  const isInsertMode = RegistrationId === '0';

  // âœ… Build FormData (includes files & text fields)
  const fd = new FormData();
  fd.append("action", "submit");
  fd.append("RegistrationId", RegistrationId);
  fd.append("userMobileNo", mob);
  fd.append("userFirstname", document.getElementById('Firstname').value.trim());
  fd.append("userMiddlename", document.getElementById('Middlename').value.trim());
  fd.append("userLastname", document.getElementById('Lastname').value.trim());
  fd.append("AreaId", document.getElementById('AreaId').value || "1");
  fd.append("Gender", document.getElementById('Gender').value || "1");
  fd.append("Address", document.getElementById('Address').value.trim());
  fd.append("userAlternateMobileNo", document.getElementById('AlternateMobileNo').value.trim());
  fd.append("BloodGroup", document.getElementById('BloodGroup').value || "1");

  // âœ… Convert DOB to dd/mm/yyyy if exists
  const dobVal = document.getElementById('DateOfBirth').value;
  if (dobVal) {
    const [y, m, d] = dobVal.split("-");
    fd.append("DateOfBirth", `${d}/${m}/${y}`);
  } else {
    fd.append("DateOfBirth", "");
  }

  // âœ… Append file uploads or fallback to hidden fields
  const aadharFile = document.getElementById("AadharUpload")?.files[0];
  if (aadharFile) {
    fd.append("AadharUpload", aadharFile);
  } else {
    fd.append("IdProofFileName", document.getElementById("IdProofFileName").value || "");
  }

  const profileFile = document.getElementById("ProfilePicUpload")?.files[0];
  if (profileFile) {
    fd.append("ProfilePicUpload", profileFile);
  } else {
    fd.append("PhotoFileName", document.getElementById("PhotoFileName").value || "");
  }

  const voterFile = document.getElementById("VoterIdUpload")?.files[0];
  if (voterFile) {
    fd.append("VoterIdUpload", voterFile);
  } else {
    fd.append("VoterId", document.getElementById("VoterId").value || "");
  }

  document.getElementById('loader').style.display = 'flex';

  try {
    const resp = await fetch("{% url 'registration_api1' %}", {
      method: "POST",
      body: fd
    });

    document.getElementById('loader').style.display = 'none';

    if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);

    const res = await resp.json();

    if (String(res.message_code) === "1000") {
      showMsg("success", res.message_text || "Registration saved successfully");

      if (isInsertMode) {
        const newRegistrationId = res.RegistrationId || res.message_data?.RegistrationId;
        if (newRegistrationId) {
          document.getElementById("RegistrationId").value = newRegistrationId;

          // âœ… Transfer yatras from 0 â†’ new ID
          const allUsersYatras = getAllUsersYatras();
          if (allUsersYatras["0"]) {
            allUsersYatras[newRegistrationId] = allUsersYatras["0"];
            delete allUsersYatras["0"];
            saveAllUsersYatras(allUsersYatras);
          }
        }
        alert("Registration saved successfully! You can now select yatras for this user or close the form.");

        const yatraSection = document.getElementById("yatraSection");
        const yatraBtn = document.querySelector(".btn-outline-primary");
        if (yatraSection && yatraSection.classList.contains("d-none")) {
          renderYatras();
          yatraSection.classList.remove("d-none");
          if (yatraBtn) yatraBtn.innerHTML = '<i class="bi bi-x-circle"></i> Hide Yatras';
        }
      } else {
        offcanvas.hide(); // update mode
      }

      // âœ… Refresh search
      setTimeout(async () => {
        await doSearch();
        setTimeout(() => {
          const currentSearchResults = JSON.parse(sessionStorage.getItem("lastSearchResults") || "[]");
          renderSelectedYatras(currentSearchResults, inputMobile.value.trim());
        }, 100);
      }, 300);

    } else {
      showMsg("error", res.message_text || "Save failed");
    }
  } catch (err) {
    document.getElementById('loader').style.display = 'none';
    console.error(err);
    showMsg("error", "Save error");
  }
});

  // allow pressing search icon or enter to trigger search
  //document.getElementById('btnSearch').addEventListener('click', doSearch);

</script>

<script>
// Updated Yatra Management System
let selectedYatras = []; 
const routes = {{ route_yatras|safe }};

// Insert "Select Yatras" button
document.addEventListener("DOMContentLoaded", ()=>{
  const yatraBtn = document.createElement("button");
  yatraBtn.className = "btn btn-outline-primary w-100 mt-2";
  yatraBtn.innerHTML = '<i class="bi bi-list-check"></i> Select Yatras';
  yatraBtn.type = "button";

  // append button before yatra section
  document.querySelector("#regForm .mt-3").appendChild(yatraBtn);

  // toggle section on button click
  yatraBtn.addEventListener("click", ()=>{
    const section = document.getElementById("yatraSection");
    if(section.classList.contains("d-none")){
      renderYatras();
      section.classList.remove("d-none");
      yatraBtn.innerHTML = '<i class="bi bi-x-circle"></i> Hide Yatras';
    } else {
      section.classList.add("d-none");
      yatraBtn.innerHTML = '<i class="bi bi-list-check"></i> Select Yatras';
    }
  });

  // Initial render of selected yatras on page load - show nothing initially
  renderSelectedYatras([], null);
});

// Get current user identifier
function getCurrentUserId() {
  const regId = document.getElementById("RegistrationId").value || "new";
  return regId;
}

// Get current user's full name
function getCurrentUserName() {
  return [
    document.getElementById("Firstname").value.trim(),
    document.getElementById("Middlename").value.trim(),
    document.getElementById("Lastname").value.trim()
  ].filter(Boolean).join(" ") || "Unknown";
}

// Get all users' yatras from localStorage
function getAllUsersYatras() {
  return JSON.parse(localStorage.getItem("userYatras") || "{}");
}

// Save all users' yatras to localStorage
function saveAllUsersYatras(data) {
  localStorage.setItem("userYatras", JSON.stringify(data));
  console.log("Updated userYatras saved to localStorage:", data);
}

// Get current user's yatras
function getCurrentUserYatras() {
  const userId = getCurrentUserId();
  const allUsersYatras = getAllUsersYatras();
  return allUsersYatras[userId] ? allUsersYatras[userId].yatras || [] : [];
}

// Update current user's yatras
function updateCurrentUserYatras(yatras) {
  const userId = getCurrentUserId();
  const userName = getCurrentUserName();
  const allUsersYatras = getAllUsersYatras();
  
  if (!allUsersYatras[userId]) {
    allUsersYatras[userId] = { fullName: userName, yatras: [] };
  }
  
  allUsersYatras[userId].fullName = userName;
  allUsersYatras[userId].yatras = yatras;
  
  saveAllUsersYatras(allUsersYatras);
}

// Render Yatras grouped by route with restored toggle states
function renderYatras(){
  const container = document.getElementById("yatraList");
  container.innerHTML = "";

  // Get current user's existing yatras
  const existingYatras = getCurrentUserYatras();
  const existingYatraIds = existingYatras.map(y => y.id);
  
  console.log("Existing yatras for current user:", existingYatras);

  routes.forEach(route=>{
    // Debug: Log the route and its yatras to see the data structure
    console.log(`Processing route: ${route.YatraRouteName}`);
    console.log('Route Yatras:', route.Yatras);
    
    if (route.Yatras && route.Yatras.length > 0) {
      console.log('First yatra sample - ALL PROPERTIES:', route.Yatras[0]);
      console.log('All property names:', Object.keys(route.Yatras[0]));
      
      // Check different possible status property names
      route.Yatras.forEach((y, index) => {
        console.log(`Yatra ${index} properties:`, {
          YatraId: y.YatraId,
          YatraRouteStatus: y.YatraRouteStatus,
          status: y.status,
          Status: y.Status,
          active: y.active,
          Active: y.Active,
          isActive: y.isActive,
          IsActive: y.IsActive,
          enabled: y.enabled,
          Enabled: y.Enabled
        });
      });
    }
    
    // First, let's show ALL yatras temporarily to see what we get
    // Remove the status filter for debugging
    const allYatras = route.Yatras || [];
    
    console.log(`Total yatras for ${route.YatraRouteName}:`, allYatras.length);
    
    // Skip this entire route if no yatras at all
    if (!allYatras.length) {
      console.log(`Skipping route ${route.YatraRouteName} - no yatras at all`);
      return;
    }
    
    // For now, use all yatras (we'll add filtering back once we know the correct property)
    const activeYatras = allYatras;

    const card = document.createElement("div");
    card.className = "card mb-2 shadow-sm";

    let yatraItems = "";
    activeYatras.forEach(y=>{
      // Check if this yatra is already selected
      const isSelected = existingYatraIds.includes(y.YatraId.toString());
      const checkedAttr = isSelected ? 'checked' : '';
      
      yatraItems += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>${y.YatraDateTime}</strong><br>
            <small> â‚¹${y.YatraFees}</small>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input yatra-toggle" type="checkbox"
              value="${y.YatraId}" data-amount="${y.YatraFees}" 
              data-route="${route.YatraRouteName}" data-datetime="${y.YatraDateTime}"
              ${checkedAttr}>
          </div>
        </li>`;
    });

    card.innerHTML = `
      <div class="card-header bg-light">
        <strong>${route.YatraRouteName}</strong><br>
        <small>${route.YatraRouteDetails}</small>
      </div>
      <ul class="list-group list-group-flush">${yatraItems}</ul>
    `;
    container.appendChild(card);
  });

  // Attach toggle events
  container.querySelectorAll(".yatra-toggle").forEach(chk=>{
    chk.addEventListener("change", handleYatraToggle);
  });
  
  // Calculate initial total based on existing selections
  calculateAndDisplayTotal();
  // Log how many route cards are actually displayed
  const displayedCards = container.querySelectorAll('.card').length;
  console.log(`Displayed ${displayedCards} route cards with active yatras`);

}

// Handle individual yatra toggle changes
function handleYatraToggle(event) {
  const checkbox = event.target;
  const yatraId = checkbox.value;
  const amount = parseFloat(checkbox.dataset.amount);
  const route = checkbox.dataset.route;
  const datetime = checkbox.dataset.datetime;
  
  let currentUserYatras = getCurrentUserYatras();
  
  if (checkbox.checked) {
    // Add yatra if not already exists
    const exists = currentUserYatras.find(y => y.id === yatraId);
    if (!exists) {
      currentUserYatras.push({
        id: yatraId,
        route: route,
        amount: amount,
        datetime: datetime
      });
      console.log(`Added Yatra ID ${yatraId} for current user`);
    }
  } else {
    // Remove yatra
    currentUserYatras = currentUserYatras.filter(y => y.id !== yatraId);
    console.log(`Removed Yatra ID ${yatraId} for current user`);
  }
  
  // Update localStorage
  updateCurrentUserYatras(currentUserYatras);
  
  // Update total display
  calculateAndDisplayTotal();
  
  // ðŸ”¥ FIX: Update selected yatras display in main screen with current search context
  const currentSearchResults = JSON.parse(sessionStorage.getItem('lastSearchResults') || '[]');
  const searchMobile = document.getElementById('searchMobile').value.trim();
  renderSelectedYatras(currentSearchResults, searchMobile);
} 



// Calculate and display total for current user
function calculateAndDisplayTotal() {
  const currentUserYatras = getCurrentUserYatras();
  const total = currentUserYatras.reduce((sum, y) => sum + y.amount, 0);
  
  document.getElementById("totalFee").textContent = total;
  console.log("Total calculated:", total);
}

// Updated Add Yatra button handler
document.addEventListener("DOMContentLoaded", () => {
  // Wait for DOM to be ready, then add event listener
  setTimeout(() => {
    const addYatraBtn = document.getElementById("btnAddYatra");
    if (addYatraBtn) {
      addYatraBtn.addEventListener("click", handleAddYatra);
    }
  }, 100);
});

function handleAddYatra() {
  console.log("=== Add Yatra Button Clicked ===");
  
  const currentUserYatras = getCurrentUserYatras();
  
  if (!currentUserYatras.length) { 
    console.log("No yatras selected for current user.");
    alert("Select at least one yatra"); 
    return; 
  }

  // Update the selected yatras display
  renderSelectedYatras();

  // Show success message
  alert(`${currentUserYatras.length} yatra(s) confirmed for this user.`);

  // Hide the yatra selection section
  const section = document.getElementById("yatraSection");
  section.classList.add("d-none");
   
  if (section.classList.contains("d-none")) {
  console.log("1057 close model")  
  const closeBtn = document.querySelector('.btn-close[data-bs-dismiss="offcanvas"]');
  if (closeBtn) closeBtn.click();
  }
  
  // Update button text
  const yatraBtn = document.querySelector('button[data-bs-target="#yatraSection"]') || 
                   document.querySelector('button:contains("Hide Yatras")');
  if (yatraBtn) {
    yatraBtn.innerHTML = '<i class="bi bi-list-check"></i> Select Yatras';
  }

  console.log("Yatra selection confirmed and section hidden.");
}
</script>
{% comment %} <script>
document.addEventListener("DOMContentLoaded", () => {
  const paymentMode = document.getElementById('PaymentMode');
  const upiFields = document.getElementById('upiFields');

  if (paymentMode && upiFields) {
    paymentMode.addEventListener('change', () => {
      upiFields.classList.toggle('d-none', paymentMode.value !== 'upi');
    });
  }

  const btnBookTicket = document.getElementById("btnBookTicket");
  if (btnBookTicket) {
    btnBookTicket.addEventListener("click", async () => {
      try {
        btnBookTicket.disabled = true; // âœ… Prevent double click
        btnBookTicket.innerText = "Booking...";

        const allUsersYatras = getAllUsersYatras();
        if (!allUsersYatras || Object.keys(allUsersYatras).length === 0) {
          alert("Please select at least one yatra before booking.");
          btnBookTicket.disabled = false;
          btnBookTicket.innerText = "Book Ticket";
          return;
        }

        // âœ… Collect all registrations with their yatraIds
        let bookingData = [];
        for (const regId in allUsersYatras) {
          const user = allUsersYatras[regId];
          if (!user.yatras || user.yatras.length === 0) continue;
          bookingData.push({
            RegistrationId: regId,
            YatraIds: user.yatras.map(y => y.id)
          });
        }

        const fd = new FormData();
        fd.append("action", "book_ticket");
        fd.append("UserId", "{{ request.session.user_id|default:'1' }}");
        fd.append("Bookings", JSON.stringify(bookingData)); // âœ… send all bookings together
        fd.append("AmountPaid", document.getElementById("AmountPayable").value || "0");
        fd.append("Discount", document.getElementById("Discount")?.value || "0");
        fd.append("DiscountReason", document.getElementById("DiscountReason")?.value || "");
        fd.append("PaymentId", document.getElementById("PaymentId")?.value || "");
        

        // âœ… Append UPI Screenshot file if selected
        const upiFile = document.getElementById("UPIScreenshot")?.files[0];
        if (upiFile) {
          fd.append("UPIScreenshot", upiFile);
        }

        const resp = await fetch("{% url 'registration_api1' %}", {
          method: "POST",
          body: fd
        });

        if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);

        const data = await resp.json();
        console.log("Book Ticket Response:", data);

        if (data.message_code === 1000) {
          alert("âœ… Tickets booked successfully!");
          location.reload()
        } else {
          alert(`âš ï¸ Booking failed: ${data.message_text}`);
        }

      } catch (error) {
        console.error("Booking error:", error);
        alert("âŒ Failed to book ticket. Please try again.");
      } finally {
        btnBookTicket.disabled = false;
        btnBookTicket.innerText = "Book Ticket";
      }
    });
  }
});
</script> {% endcomment %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const paymentMode = document.getElementById('PaymentMode');
  const upiFields = document.getElementById('upiFields');
  const btnBookTicket = document.getElementById("btnBookTicket");

  if (paymentMode && upiFields) {
    paymentMode.addEventListener('change', () => {
      // Show UPI fields only when "upi" is selected
      upiFields.classList.toggle('d-none', paymentMode.value !== 'upi');
    });
  }

  if (btnBookTicket) {
    btnBookTicket.addEventListener("click", async () => {
      try {
        btnBookTicket.disabled = true;
        btnBookTicket.innerText = "Booking...";
        

        const allUsersYatras = getAllUsersYatras();
        if (!allUsersYatras || Object.keys(allUsersYatras).length === 0) {
          alert("Please select at least one yatra before booking.");
          btnBookTicket.disabled = false;
          btnBookTicket.innerText = "Book Ticket";
          return;
        }

        // Collect bookings
        let bookingData = [];
        for (const regId in allUsersYatras) {
          const user = allUsersYatras[regId];
          if (!user.yatras || user.yatras.length === 0) continue;
          bookingData.push({
            RegistrationId: regId,
            YatraIds: user.yatras.map(y => y.id)
          });
        }

        const fd = new FormData();
        fd.append("action", "book_ticket");
        fd.append("UserId", "{{ request.session.user_id|default:'1' }}");
        fd.append("Bookings", JSON.stringify(bookingData));
        fd.append("AmountPaid", document.getElementById("AmountPayable").value || "0");
        fd.append("Discount", document.getElementById("Discount")?.value || "0");
        fd.append("DiscountReason", document.getElementById("DiscountReason")?.value || "");
        fd.append("PaymentId", document.getElementById("PaymentId")?.value || "");
        fd.append("PaymentMode", paymentMode.value || ""); // cash / upi
        // Add Count values
        fd.append("Count1", document.getElementById("Count1")?.value || "0");
        fd.append("Count2", document.getElementById("Count2")?.value || "0");
        fd.append("Count3", document.getElementById("Count3")?.value || "0");

        // âœ… NEW: Check payment mode selected
        if (!paymentMode.value) {
          alert("Please select a payment mode.");
          btnBookTicket.disabled = false;
          btnBookTicket.innerText = "Book Ticket";
          return;
        }

        // If UPI selected â†’ send TransactionId + Screenshot
        if (paymentMode.value === "upi") {
          const transactionId = document.getElementById("TransactionId")?.value || "";
          //if (!transactionId.trim()) {
          //  alert("Please enter UPI Transaction ID.");
          //  btnBookTicket.disabled = false;
          //  btnBookTicket.innerText = "Book Ticket";
          //  return;
          // }
          fd.append("TransactionId", transactionId);

          const upiFile = document.getElementById("UPIScreenshot")?.files[0];
          if (!upiFile) {
            alert("Please upload UPI screenshot.");
            btnBookTicket.disabled = false;
            btnBookTicket.innerText = "Book Ticket";
            return;
          }
          fd.append("UPIScreenshot", upiFile);
        }

        document.getElementById('loader').style.display = 'flex';

        const resp = await fetch("{% url 'registration_api1' %}", {
          method: "POST",
          body: fd
        });

        document.getElementById('loader').style.display = 'none';

        if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
        const data = await resp.json();
        console.log("Book Ticket Response:", data);

        if (data.message_code === 1000) {
          // âœ… Fill counts from API response if available
          if (data.message_data) {
            const counts = {
              Count1: data.message_data.GroupCount || 0,
              Count2: data.message_data.CurrentTicket || 0,
              Count3: data.message_data.BalanceTicket || 0
            };

            // Update input values
            document.getElementById("Count1").value = counts.Count1;
            document.getElementById("Count2").value = counts.Count2;
            document.getElementById("Count3").value = counts.Count3;

            // âœ… Save them into sessionStorage immediately
            Object.keys(counts).forEach(id => {
              sessionStorage.setItem(id, counts[id]);
            });
          }

          console.log("âœ… Updated counts saved to sessionStorage:", data.message_data);

          alert("âœ… Tickets booked successfully!");
          location.reload();
        } else {
          alert(`âš ï¸ Booking failed: ${data.message_text}`);
        }


      } catch (error) {
        console.error("Booking error:", error);
        alert("âŒ Failed to book ticket. Please try again.");
      } finally {
        btnBookTicket.disabled = false;
        btnBookTicket.innerText = "Book Ticket";
      }
    });
  }
});
</script>

<script>
// Render selected yatras for all users from localStorage (for main screen display)
function renderSelectedYatras(searchResults = null, searchMobile = null) {
  const yatraContainer = document.getElementById('selectedYatras');
  if (!yatraContainer) return;

  yatraContainer.innerHTML = '';

  // Get all users' yatras from localStorage
  const allUsersYatras = getAllUsersYatras();
  console.log("Rendering all users' yatras:", allUsersYatras);

  // Build Yatra lookup by ID from routes
  const yatraMap = {};
  routes.forEach(route => {
    if (route.Yatras && route.Yatras.length) {
      route.Yatras.forEach(y => {
        yatraMap[y.YatraId.toString()] = {
          route: route.YatraRouteName,
          fees: y.YatraFees,
          datetime: y.YatraDateTime
        };
      });
    }
  });

  let usersToShow = {};

  // If we have search results, show only those users' yatras
  if (searchResults && Array.isArray(searchResults) && searchResults.length > 0) {
    // Show yatras only for users in search results
    searchResults.forEach(user => {
      const regId = user.RegistrationId ? user.RegistrationId.toString() : 'new';
      if (allUsersYatras[regId]) {
        usersToShow[regId] = allUsersYatras[regId];
      }
    });
  } else if (searchMobile && validMobile(searchMobile)) {
    // If we have a searched mobile but no results, still check localStorage for any users with that mobile
    Object.keys(allUsersYatras).forEach(regId => {
      // This would need mobile number stored in localStorage structure for proper filtering
      // For now, show nothing if no search results
      // usersToShow = {}; // Empty object - no users to show
    });
    usersToShow = {}; // Show nothing when search returns no results
  } else {
    // Only show yatras when there's no search active (initial state)
    // Don't show all users' yatras when search box is empty but user hasn't searched
    usersToShow = {};
  }

  // If no users have yatras, show message
  if (Object.keys(usersToShow).length === 0) {
    const noYatras = document.createElement('div');
    noYatras.className = "text-muted text-center py-3";
    noYatras.innerHTML = '<i class="bi bi-info-circle"></i> No yatras selected yet.';
    yatraContainer.appendChild(noYatras);
    return;
  }

  // Calculate total amount across all selected users
  let grandTotal = 0;

  // Loop through each user to show
  Object.keys(usersToShow).forEach(regId => {
    const user = usersToShow[regId];
    const fullName = user.fullName || "(Unnamed)";
    const userYatras = Array.isArray(user.yatras) ? user.yatras : [];

    const userBlock = document.createElement('div');
    userBlock.className = "card mb-2";

    const cardHeader = document.createElement('div');
    cardHeader.className = "card-header bg-light d-flex justify-content-between align-items-center";
    
    const nameDiv = document.createElement('div');
    nameDiv.className = "fw-bold text-primary";
    nameDiv.textContent = fullName;
    cardHeader.appendChild(nameDiv);

    if (userYatras.length > 0) {
      const userTotal = userYatras.reduce((sum, y) => {
        const yData = yatraMap[y.id];
        const fee = yData ? parseFloat(yData.fees) : parseFloat(y.amount || 0);
        return sum + (isNaN(fee) ? 0 : fee);
      }, 0);
      
      grandTotal += userTotal;
      
      const totalBadge = document.createElement('span');
      totalBadge.className = "badge bg-success";
      totalBadge.textContent = `â‚¹${userTotal}`;
      cardHeader.appendChild(totalBadge);
    }

    userBlock.appendChild(cardHeader);

    const cardBody = document.createElement('div');
    cardBody.className = "card-body";

    if (!userYatras.length) {
      const noYatra = document.createElement('div');
      noYatra.className = "small text-muted";
      noYatra.textContent = "No yatras selected yet.";
      cardBody.appendChild(noYatra);
    } else {
      userYatras.forEach(y => {
        const yData = yatraMap[y.id];
        const yLine = document.createElement('div');
        yLine.className = "small text-dark mb-1 d-flex justify-content-between";

        if (yData) {
          // yLine.innerHTML = `
          //  <span><i class="bi bi-calendar-event me-1"></i>${yData.datetime}</span>
          //  <span class="fw-bold">â‚¹${yData.fees}</span>
          // `;
          yLine.innerHTML = `
            <div>
              <div><i class="bi bi-geo-alt-fill me-1 text-primary"></i><strong>${yData.route}</strong></div>
              <div class="small text-muted"><i class="bi bi-calendar-event me-1"></i>${yData.datetime}</div>
            </div>
            <span class="fw-bold">â‚¹${yData.fees}</span>
          `;
        } else {
          yLine.innerHTML = `
            <span><i class="bi bi-question-circle me-1"></i>Yatra ID: ${y.id} (details not found)</span>
            <span class="fw-bold">â‚¹${y.amount || 0}</span>
          `;
        }

        cardBody.appendChild(yLine);
      });
    }

    userBlock.appendChild(cardBody);
    yatraContainer.appendChild(userBlock);
  });

  // Show grand total if there are selected yatras
  if (grandTotal > 0) {
    const totalCard = document.createElement('div');
    totalCard.className = "card border-success";
    totalCard.innerHTML = `
      <div class="card-body text-center">
        <h5 class="card-title text-success">Total Amount: â‚¹${grandTotal}</h5>
        <p class="card-text small text-muted">Total for all selected yatras</p>
      </div>
    `;
    yatraContainer.appendChild(totalCard);
    
    // Auto-fill the payment amount
    const amountPayableInput = document.getElementById('AmountPayable');
    if (amountPayableInput) {
      amountPayableInput.value = grandTotal;
    }
  }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ids = ["Count1", "Count2", "Count3"];
  const msgBox = document.getElementById("countMessage");

  // âœ… Restore counts from sessionStorage or default to 1
  ids.forEach(id => {
    let savedValue = sessionStorage.getItem(id);
    if (savedValue === null) {
      savedValue = 1;
      sessionStorage.setItem(id, 1);
    }
    document.getElementById(id).value = savedValue;
  });

  // âœ… Check conditions
  let values = ids.map(id => parseInt(sessionStorage.getItem(id) || 0));

  if (values.every(v => v === 0)) {
    msgBox.textContent = "Group is Over";
    values = [1, 1, 1];
    ids.forEach((id, i) => {
      document.getElementById(id).value = values[i];
      sessionStorage.setItem(id, values[i]);
    });
    // keep editable
    ids.forEach(id => (document.getElementById(id).disabled = false));
  } else if (values[0] > 1) {
    // disable all if first box > 1
    ids.forEach(id => (document.getElementById(id).disabled = true));
    msgBox.textContent = " ";
  } else {
    // keep editable in all other cases
    ids.forEach(id => (document.getElementById(id).disabled = false));
    msgBox.textContent = "";
  }

  // âœ… Save on input if editable
  ids.forEach(id => {
    document.getElementById(id).addEventListener("input", e => {
      if (!e.target.disabled) {
        sessionStorage.setItem(id, e.target.value);
      }
    });
  });

  // âœ… Clear only localStorage, not sessionStorage
  localStorage.clear();
});
</script>


</body>
</html>
