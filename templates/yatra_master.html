{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Darshan Yatra - Yatra Master</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="manifest" href="{% static 'assets/__manifest.json' %}">

    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; }
        .navbar { background-color: #ff7b00; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .back-btn { font-size: 1.5rem; color: white; text-decoration: none; }
        .navbar-brand { font-weight: bold; }
        .container-main { max-width: 800px; margin: 80px 0; background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .btn-custom { background: #ff7b00; color: #fff; border: none; font-weight: bold; }
        .modal-body label { font-weight: bold; color: #003399; }
        .form-control, .form-select { border-radius: 6px; border: 1px solid #ccc; }
        .form-control:focus, .form-select:focus { border-color: #006633; box-shadow: 0 0 5px rgba(0,102,51,0.4); }
        .yatra-card { padding: 0.75rem; border-bottom: 1px solid #dee2e6; }
        .yatra-card:last-child { border-bottom: none; }
        .yatra-row-1 { display: flex; justify-content: space-between; align-items: center; }
        .yatra-row-2 { margin-top: 0.25rem; }
        .yatra-name { font-weight: bold; }
        .yatra-date { font-size: 0.9em; color: #6c757d; }
        .yatra-actions { display: flex; gap: 0.75rem; align-items: center; }
        
        @media (max-width: 480px) {
            .container-main { margin: 70px 0; border-radius: 0; padding: 1rem 0.5rem; }
        }
        .select2-container--bootstrap-5 .select2-dropdown { z-index: 1060; }
    </style>
</head>
<body>

<nav class="navbar fixed-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="{% url 'dashboard' %}" class="back-btn"><i class="bi bi-arrow-left-circle"></i></a>
        <span class="navbar-brand mb-0 h1" style="color:white">Yatra Master</span>
        <span style="width: 30px;"></span> 
    </div>
</nav>

<div class="container-main">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 fs-4 text-primary">Manage Yatras</h2>
        <button class="btn btn-custom" id="addYatraBtn"><i class="bi bi-plus-circle"></i> Add Yatra</button>
    </div>

    <div id="yatraTableBody">
        {% for yatra in yatras %}
        <div class="yatra-card" 
             data-yatra-id="{{ yatra.YatraId }}" data-route-id="{{ yatra.YatraRouteId }}" data-date-time="{{ yatra.YatraDateTime }}"
             data-fees="{{ yatra.YatraFees|default_if_none:'' }}" data-status="{{ yatra.YatraStatus }}">
            
            <div class="yatra-row-1">
                <span class="yatra-name">{{ yatra.YatraRouteName }}</span>
                <div class="yatra-actions">
                    {% if yatra.YatraStatus == 1 %}<span class="badge bg-success">Active</span>
                    {% else %}<span class="badge bg-danger">Inactive</span>{% endif %}
                    <button class="btn btn-sm btn-outline-primary edit-btn"><i class="bi bi-pencil-fill"></i></button>
                </div>
            </div>
            <div class="yatra-row-2">
                <span class="yatra-date">{{ yatra.YatraDateTime }}</span>
            </div>
        </div>
        {% empty %}
        <p class="text-center text-muted">No yatras found.</p>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="yatraModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="yatraForm">
            <input type="hidden" id="formYatraId">
            <div class="mb-3"><label for="formRouteId" class="form-label">Route</label><select class="form-select" id="formRouteId" style="width:100%;" required><option value="">Select a Route</option>{% for route in routes %}<option value="{{ route.YatraRouteId }}">{{ route.YatraRouteName }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label for="formDateTime" class="form-label">Date and Time</label><input type="datetime-local" class="form-control" id="formDateTime" required></div>
            <div class="mb-3"><label for="formFees" class="form-label">Fees</label><input type="number" class="form-control" id="formFees" placeholder="Enter fees" required></div>
            <div class="mb-3"><label for="formStatus" class="form-label">Status</label>
                <select class="form-select" id="formStatus" style="width:100%;">
                    <option value="1">Active</option>
                    <!-- **** THIS IS THE FIX **** -->
                    <option value="2">Deactivated</option>
                </select>
            </div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-custom" id="saveYatraBtn">Save Yatra</button></div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    const yatraModal = new bootstrap.Modal(document.getElementById('yatraModal'));
    const yatraTableBody = document.getElementById('yatraTableBody');

    $(document).ready(function() {
        $('#formRouteId').select2({ theme: "bootstrap-5", dropdownParent: $('#yatraModal') });
        $('#formStatus').select2({ theme: "bootstrap-5", dropdownParent: $('#yatraModal'), minimumResultsForSearch: Infinity });
    });

    function formatToInput(apiDate) {
        if (!apiDate) return '';
        const [datePart, timePart] = apiDate.split(' ');
        const [day, month, year] = datePart.split('-');
        return `${year}-${month}-${day}T${timePart}`;
    }

    document.getElementById('addYatraBtn').addEventListener('click', () => {
        document.getElementById('yatraForm').reset();
        document.getElementById('formYatraId').value = ''; 
        document.getElementById('modalTitle').textContent = 'Add New Yatra';
        $('#formRouteId').val('').trigger('change');
        $('#formStatus').val('1').trigger('change');
        yatraModal.show();
    });

    yatraTableBody.addEventListener('click', (e) => {
        const editButton = e.target.closest('.edit-btn');
        if (editButton) {
            const card = editButton.closest('.yatra-card');
            document.getElementById('formYatraId').value = card.dataset.yatraId;
            document.getElementById('formDateTime').value = formatToInput(card.dataset.dateTime);
            document.getElementById('formFees').value = card.dataset.fees; 
            document.getElementById('modalTitle').textContent = 'Edit Yatra';
            $('#formRouteId').val(card.dataset.routeId).trigger('change');
            
            // This will now correctly set the status to '1' or '2'
            let statusValue = card.dataset.status;
            // The API returns the ID as a string, e.g., "1" or "2". We can use this directly.
            // If the API returns a name like "Active", we'd need to map it.
            // But since our API now sends the ID (1 or 2), this is correct.
            $('#formStatus').val(statusValue).trigger('change');

            yatraModal.show();
        }
    });

    document.getElementById('saveYatraBtn').addEventListener('click', () => {
        const yatraId = document.getElementById('formYatraId').value;
        const dateTime = document.getElementById('formDateTime').value;
        const fees = document.getElementById('formFees').value;
        const routeId = $('#formRouteId').val();
        const status = $('#formStatus').val();

        if (!routeId || !dateTime || !fees) {
            swal("Error", "All fields are required.", "error");
            return;
        }

        let formData = new FormData();
        formData.append('routeId', routeId);
        formData.append('dateTime', dateTime); 
        formData.append('fees', fees);
        formData.append('status', status);
        if (yatraId) {
            formData.append('action', 'update_yatra');
            formData.append('yatraId', yatraId);
        } else {
            formData.append('action', 'add_yatra');
        }
        fetch("{% url 'yatra_master_api' %}", { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.message_code === 1000) {
                    swal({ title: "Success!", text: data.message_text, type: "success" }, () => location.reload());
                } else {
                    swal("Error", data.message_text || "An error occurred.", "error");
                }
            });
    });
</script>
</body>
</html>